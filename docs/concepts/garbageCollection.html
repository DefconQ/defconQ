<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/garbageCollection" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">Garbage Collection | DefconQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://DefconQ.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://DefconQ.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://DefconQ.github.io/docs/concepts/garbageCollection"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Garbage Collection | DefconQ"><meta data-rh="true" name="description" content="In this blog post, we cover another crucial concept, which if fully understood, can set you apart. Today&#x27;s topic is Garbage Collection, and here&#x27;s the news upfront: There&#x27;s no such thing as Garbage in KDB/Q!! Yes, you read it correctly. Don&#x27;t be caught off guard like I was, discovering this information in a job interview with &quot;the QGOD&quot; among all KDB/Q developers. Keep reading and learn everything you need to know about this essential topic."><meta data-rh="true" property="og:description" content="In this blog post, we cover another crucial concept, which if fully understood, can set you apart. Today&#x27;s topic is Garbage Collection, and here&#x27;s the news upfront: There&#x27;s no such thing as Garbage in KDB/Q!! Yes, you read it correctly. Don&#x27;t be caught off guard like I was, discovering this information in a job interview with &quot;the QGOD&quot; among all KDB/Q developers. Keep reading and learn everything you need to know about this essential topic."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://DefconQ.github.io/docs/concepts/garbageCollection"><link data-rh="true" rel="alternate" href="https://DefconQ.github.io/docs/concepts/garbageCollection" hreflang="en"><link data-rh="true" rel="alternate" href="https://DefconQ.github.io/docs/concepts/garbageCollection" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://R6JV2N50EX-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DefconQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DefconQ Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E9ED09HNE3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-E9ED09HNE3",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="DefconQ" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5860f28a.css">
<script src="/assets/js/runtime~main.faaaa23f.js" defer="defer"></script>
<script src="/assets/js/main.d631296b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#74e8a3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">If you would like to connect, please reach out on <a href="https://www.linkedin.com/in/alexanderunterrainer/">Linkedin</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DefconQ Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="150" width="50"><img src="/img/logoLight.svg" alt="DefconQ Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="150" width="50"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Learn</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about/about">About</a><a class="navbar__item navbar__link" href="/cv/cv">CV</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/DefconQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdbq-language">KDB/Q Language</a><button aria-label="Expand sidebar category &#x27;KDB/Q Language&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdb-architecture">KDB Architecture</a><button aria-label="Expand sidebar category &#x27;KDB Architecture&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/important-concepts">Important Concepts</a><button aria-label="Collapse sidebar category &#x27;Important Concepts&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/attributes">Attributes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/memoryManagement">Memory Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/concepts/garbageCollection">Garbage Collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/amend">Amend, Amend At: The Swiss Army knife among KDB/Q operators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/dictionariesTables">Dictionaries and Tables</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorials">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/productivity-tools">Productivity Tools</a><button aria-label="Expand sidebar category &#x27;Productivity Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/important-concepts"><span itemprop="name">Important Concepts</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Garbage Collection</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Garbage Collection</h1>
<p>In this blog post, we cover another crucial concept, which if fully understood, can set you apart. Today&#x27;s topic is Garbage Collection, and here&#x27;s the news upfront: There&#x27;s no such thing as Garbage in KDB/Q!! Yes, you read it correctly. Don&#x27;t be caught off guard like I was, discovering this information in a job interview with <strong>&quot;the QGOD&quot;</strong> among all KDB/Q developers. Keep reading and learn everything you need to know about this essential topic.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>To fully comprehend Garbage Collection in KDB/Q, a solid understanding of Memory Management in KDB/Q is required, which you can find in detail in my previous blog post <a href="https://www.defconq.tech/docs/concepts/memoryManagement" target="_blank" rel="noopener noreferrer">here</a></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-allocation">Memory Allocation<a href="#memory-allocation" class="hash-link" aria-label="Direct link to Memory Allocation" title="Direct link to Memory Allocation">​</a></h2>
<p>As explained in my previous <a href="https://www.defconq.tech/docs/concepts/memoryManagement" target="_blank" rel="noopener noreferrer">post</a>, KDB/Q employs a memory allocation strategy in blocks of powers of two, reserving the next larger memory block for the storage of the object. This memory allocation draws from the heap memory of KDB/Q processes, allocated during startup. The maximum memory allocated to a KDB/Q process can be defined by specifying a memory limit using the <a href="https://code.kx.com/q/basics/syscmds/#w-workspace" target="_blank" rel="noopener noreferrer"><code>-w</code></a> flag at startup. Alternatively, if no memory limit is specified, KDB/Q assumes there is none and utilizes all available memory as required. You can observe the above behaviour in the following code snippet:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Starting a KDB/Q process without memory limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Alexander@Alexanders-MacBook-Pro:~/repos|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⇒  qq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KDB+ 4.0 2023.01.20 Copyright (C) 1993-2023 Kx Systems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m64/ 4(24)core 8192MB Alexander alexanders-macbook-pro.local 127.0.0.1 EXPIRE 2025.02.21 XXXX@gmail.com KDB PLUS TRIAL #5018719</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 359200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 67108864</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 67108864</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589934592</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 668</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 28611</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Starting a KBD/Q process with 200MB memory limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Alexander@Alexanders-MacBook-Pro:~/repos|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⇒  qq -w 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KDB+ 4.0 2023.01.20 Copyright (C) 1993-2023 Kx Systems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m64/ 4(24)core 8192MB Alexander alexanders-macbook-pro.local 127.0.0.1 EXPIRE 2025.02.21 XXXX@gmail.com KDB PLUS TRIAL #5018719</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 359296</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 67108864</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 67108864</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 209715200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589934592</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 668</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 28611</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The system command <a href="https://code.kx.com/q/ref/dotq/#w-memory-stats" target="_blank" rel="noopener noreferrer"><code>.Q.w[]</code></a> provides essential memory statistics in a user-friendly format. Key entries to examine include <code>used</code>, denoting the amount of heap memory currently utilized, <code>heap</code>, representing the total size of the heap, <code>peak</code>, the largest heap memory size we have observed so far, <code>wmax</code>, indicating the memory limit established by the <code>-w</code> flag on startup, and <code>mphy</code> the physical available memory of the system. As evident, the first case has a memory limit of 0, indicating an absence of limitations. In the second instance, we&#x27;ve set the memory limit to 200MB for the specified process, as reflected in <code>wmax</code> returned by <code>.Q.w[]</code>.</p>
<p>Another important observation we can make is the fact that even though we initiated our KDB/Q process with a 200MB memory limit in the second example, the initial heap is only allocated at 64MB. This behavior stems from KDB/Q&#x27;s approach of not allocating the entire memory at once but rather expanding the heap in 64MB increments. If there is a memory limit set and our process breaches this limit the KDB/Q process will terminate with a <code>-w abort</code> error.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>It&#x27;s crucial to understand that in the absence of a set memory limit, the effective memory limit is not equivalent to the physical memory, as indicated by <code>mphy</code>, but rather twice that amount [5, p.131]. This discrepancy arises from the fact that most operating systems utilize a concept of <a href="https://www.techtarget.com/searchstorage/definition/virtual-memory" target="_blank" rel="noopener noreferrer">Virtual Memory</a>, where secondary memory can be used as if it were a part of the main memory, basically functioning as an extension of the main memory.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference-counting">Reference Counting<a href="#reference-counting" class="hash-link" aria-label="Direct link to Reference Counting" title="Direct link to Reference Counting">​</a></h2>
<p>Now, let&#x27;s dive into the most critical section of this article, so fasten your seatbelt and focus. KDB/Q employs a concept known as reference counting to track live objects. This means that once an object is no longer referenced, the associated memory allocated to this object is reclaimed and returned to the heap of our KDB/Q process (or to the OS if the system command <code>-g</code> is set to <code>1</code>, and the freed memory is greater than or equal to 64MB. Further details on this will be covered in a later section).</p>
<p>Let&#x27;s pause for a moment and that information. If you were paying attention, you will realise, that what we just learned, means that <strong>THERE IS NO SUCH THING AS GARBAGE in KDB/Q</strong>. Yes, that&#x27;s right. Since the memory occupied by an object is immediately reclaimed when the object is no longer referenced, and this freed memory can be assigned to a new object, we can affirm that there is no garbage in KDB/Q.</p>
<p>The system command <a href="https://code.kx.com/q/basics/internal/#-16x-ref-count" target="_blank" rel="noopener noreferrer"><code>-16!</code></a>  provides the reference count of a variable. The following code snippet demonstrates this feature.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)x:2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-16!x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)x:y:z:2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-16!x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="qgc-and-coalescing-memory"><code>Q.gc[]</code> and Coalescing Memory<a href="#qgc-and-coalescing-memory" class="hash-link" aria-label="Direct link to qgc-and-coalescing-memory" title="Direct link to qgc-and-coalescing-memory">​</a></h2>
<p>Now that we know that there is no such thing as garbage, let&#x27;s explore the functionality of <a href="https://code.kx.com/q/ref/dotq/#gc-garbage-collect" target="_blank" rel="noopener noreferrer"><code>.Q.gc[]</code></a>. As mentioned in my earlier blog <a href="https://www.defconq.tech/docs/concepts/memoryManagement" target="_blank" rel="noopener noreferrer">post</a>, KDB/Q allocates memory in blocks of power of 2, with the initial block being 64MB. When our KDB/Q process starts up, a 64MB heap is allocated. As we store data in variables, memory blocks of corresponding power-of-two sizes are created to accommodate the new data. However, if these variables are no longer referenced and the memory is no longer needed, calling <code>.Q.gc[]</code> in KDB/Q attempts to coalesce all free and adjacent memory blocks into the next larger power-of-two block. Moreover, any memory blocks larger or equal to 64MB will be returned to the operating system.</p>
<p>Let&#x27;s have a look at this behaviour in practice</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// First we start a new KDB/Q process and inspect the memory usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Alexander@Alexanders-MacBook-Pro:~/repos|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⇒  qq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KDB+ 4.0 2023.01.20 Copyright (C) 1993-2023 Kx Systems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m64/ 4(24)core 8192MB Alexander alexanders-macbook-pro.local 127.0.0.1 EXPIRE 2025.02.21 XXXX@gmail.com KDB PLUS TRIAL #5018719</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 0.359376</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 67.10886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 67.10886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.000668</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 0.028611</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We now create a vector with 10000000 numbers and see how much space that took</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)v:til 10000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 134.5758</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 201.3266</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 201.3266</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.000668</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 0.028611</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// As you can see, this takes roughly 200MB of space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Deleting the variable v however will not free up the memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)delete v from `.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// v no longer exists as you can observe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// However, the memory hasn&#x27;t been returned to the OS and is still reservered for the KDB/Q heap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 0.359392</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 201.3266</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 201.3266</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.000668</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 0.028611</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Only when we invoke .Q.gc[] the free memory blocks are coalesced (defragmented) and returned to the OS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.gc[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">134217728</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 0.35808</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 67.10886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 201.3266</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.000669</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 0.028641</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// You can see that after calling .Q.gc[] the size of the heap decreased to the same size we started with, roughly 67MB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the example above, we started a new KDB/Q process and observed that the initial memory allocated to the process&#x27;s heap was 67MB (<strong>NOTE</strong>: slightly larger than the 64MB mentioned earlier in this article). Next, we created a vector containing 10 million long values and can observe that the memory occupied by our KBD/Q process increased to roughly 200MB. But why did the memory increase by that much? With 10 million long values, we&#x27;d expect roughly 80MB of space to be occupied, not 134MB. As explained in my previous blog post, KDB/Q allocates memory in power-of-two blocks, and the next larger block required to store 80MB of data is actually 134MB, totaling 200MB of heap memory. Finally we deleted our variable and inspect our memory stats one more time. But hold on, why does the heap still occupy 200MB? Why hasn&#x27;t the memory been released to the OS? This is because KDB/Q doesn&#x27;t automatically release memory to the OS unless the KDB/Q process is started with the <code>-g</code> flag set to true. Only when invoking .Q.gc[] will the memory be returned to the OS, as demonstrated in the example above.</p>
<p>Let&#x27;s now have a closer look at the <code>-g</code> flag.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-system-command--g">The system command <code>-g</code><a href="#the-system-command--g" class="hash-link" aria-label="Direct link to the-system-command--g" title="Direct link to the-system-command--g">​</a></h2>
<p>The system command <a href="https://code.kx.com/q/basics/syscmds/#g-garbage-collection-mode" target="_blank" rel="noopener noreferrer"><code>-g</code></a>, often referred to as garbage collection mode (although, in my opinion, this is misleading as there is no such thing as garbage in KDB/Q), can be used to return unreferenced memory to the OS immediately. The <code>g</code> flag can take one of two values:</p>
<ul>
<li><code>-g 0</code>: the deferred (default) mode, which returns memory to the OS when either .Q.gc[] is called or an allocation fails, offering a performance advantage but potentially posing challenges in dimensioning or managing memory requirements. If the freed memory isn&#x27;t returned to the OS, our KDB/Q process might occupy free memory that could be used otherwise by another process</li>
<li><code>-g 1</code>: the immediate mode, which returns memory blocks equal to or larger than 64MB to the OS as soon as they are no longer referenced, but this comes with an associated performance overhead.</li>
</ul>
<p>When starting a KDB/Q process without the -g flag specified, the flag will automatically set to 0 as this is the default mode, meaning that &quot;garbage collection&quot; is deferred. We have already seen this behaviour in our previous example, showing that the unreferenced memory is only returned when .Q.gc[] was invoked. Let&#x27;s now look in more detail what happens when we set the -g flag to true.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Alexander@Alexanders-MacBook-Pro:~/repos|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We first start a KDB/Q process with the -g flag set to true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⇒  qq -g 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KDB+ 4.0 2023.01.20 Copyright (C) 1993-2023 Kx Systems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m64/ 4(24)core 8192MB Alexander alexanders-macbook-pro.local 127.0.0.1 EXPIRE 2025.02.21 XXXXr@gmail.com KDB PLUS TRIAL #5018719</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We then create the same vector of 10000000 long values and inspect the memory usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)v:til 10000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 134.5772</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 201.3266</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 201.3266</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.000668</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 0.028611</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Next we delete the variable v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)delete v from `.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// v no longer exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We can observe that the unreferenced memory was returned to the OS immediately as the heap decreased</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 0.359488</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 67.10886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 201.3266</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.000668</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 0.028611</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see, having the <code>-g</code> flag set to true will return unreferenced memory that is larger or equal than 64MB immediately to the OS. It is crucial to emphasize that only unreferenced memory above his 64MB threshold is returned to the OS. We will discuss this in the following section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-qgc-and--g-1-can-be-bad">Why .Q.gc[] and <code>-g 1</code> can be bad<a href="#why-qgc-and--g-1-can-be-bad" class="hash-link" aria-label="Direct link to why-qgc-and--g-1-can-be-bad" title="Direct link to why-qgc-and--g-1-can-be-bad">​</a></h2>
<p>While freeing up memory might seem like a generally good practice, it&#x27;s not always the case, particularly in low-latency, high-frequency applications where performance is key. Allow me to elablorate on the reasons behind this:</p>
<p>We first look into the aspect of <code>.Q.gc[]</code>: As outlined earlier in this blog post, when initiating a KDB/Q process without a set memory limit, the actual allocated memory is twice the available physical memory due to the utilization of virtual memory. This characteristic introduces uncertainty regarding the duration of <code>.Q.gc[]</code> completion. Imagine a scenario with a substantial production box boasting hundreds or even thousands of gigabytes of RAM; the coalescence of unreferenced memory blocks could consume a considerable amount of time. Undoubtedly, you wouldn&#x27;t want your trading applications to experience disruptions during this process.</p>
<p>Now, let&#x27;s explore the <code>-g</code> flag, and you might already anticipate the issue with it. As a reminder, when the <code>-g</code> flag is set to true, unreferenced memory is released to the OS immediately. However, unlike <code>.Q.gc[]</code>, the <code>-g</code> flag doesn&#x27;t consolidate free memory blocks, it solely releases free memory blocks that are larger or equal to 64MB. This implies that if you allocate a large number of small variables consuming less than 64MB, deleting them won&#x27;t result in the return of this unreferenced memory to the OS. Let me illustrate this for you:</p>
<p>(<strong>Note</strong>: This example has been partially taken from <a href="https://dataintellect.com/blog/garbage-collection-kdb/" target="_blank" rel="noopener noreferrer">Garbage Collection in KDB+</a> by Data Intellect )</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Alexander@Alexanders-MacBook-Pro:~/repos|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Again, we first start a KDB/Q process with the -g flag set to true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⇒  qq -g 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KDB+ 4.0 2023.01.20 Copyright (C) 1993-2023 Kx Systems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m64/ 4(24)core 8192MB Alexander alexanders-macbook-pro.local 127.0.0.1 EXPIRE 2025.02.21 XXXXr@gmail.com KDB PLUS TRIAL #5018719</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We then create 10000 variables and store 3000 long numbers in each of them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)a:upper -10000?`4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q){@[`.;x;:;til 3000]} each a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Let&#x27;s have a look at the memory stats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 328.4331</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 335.5443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 335.5443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.020665</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 1.124617</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// As you can see, our heap increased by 335MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// However, each individual variable only takes 14bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-22!first a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Helper code: Creating 10000 vectors with 3000 long values each</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q){til 3000} each til 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Whereas collectively, they amount to 240MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)1e-6*-22!{til 3000} each til 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">240.06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Having another look at the memory stats, we can observe that the peak inreased even further</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 328.4331</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 671.0886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 671.0886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.020665</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 1.124617</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We now delete all variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q){value&quot;delete &quot;,(string x),&quot; from `.&quot;}each a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// But as you can see, the unreferenced memory was not returned to the OS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// The heap is still 671MB </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 0.490992</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 671.0886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 671.0886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.020665</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 1.124617</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Only when invoking .Q.gc[], the unreferenced memory is defragmented and then released</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.gc[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">603979776</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Our heap now decreased to 67MB, the smallest memory block allocated on startup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.w[]*1e-6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">used| 0.48968</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap| 67.10886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peak| 671.0886</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wmax| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap| 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mphy| 8589.935</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syms| 0.020666</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symw| 1.124647</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the example above, we initially created a list of 10,000 variables, each holding 3,000 long values. It&#x27;s evident that our heap memory increased from the initial 67MB allocated on startup to 335MB. However, upon inspecting the memory size of the first individual variable among the 10,000, we observed that it only required 14 bytes. Whereas the collective size of our list of variables amounted to 240MB, as indicated by our helper code. (<strong>Note</strong>: The reason it&#x27;s 240MB and not 335MB is due to adding the initial block of 67MB to the 240MB and accounting for some overhead of the pointers to each list stored in the individual variables. In KDB/Q, each list has an associated pointer to the list, consuming 8 bytes of memory). After deleting all the variables, we noticed that our heap memory didn&#x27;t decrease, even though the <code>-g</code> flag was set to true. (The heap size is actually 671MB because our helper code also consumed some memory). This is because, unlike <code>.Q.gc[]</code>, the <code>-g</code> flag doesn&#x27;t coalesce unreferenced memory and only releases memory blocks larger or equal to 64MB to the OS. Since all variables only consume 14 bytes, no memory is released. It&#x27;s only when invoking <code>.Q.gc[]</code> that the unreferenced memory is defragmented, releasing all memory larger or equal to 64MB to the OS. Inspecting the memory usage after <code>.Q.gc[]</code> confirms this.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="recent-changes-in-qgc">Recent changes in <code>.Q.gc[]</code><a href="#recent-changes-in-qgc" class="hash-link" aria-label="Direct link to recent-changes-in-qgc" title="Direct link to recent-changes-in-qgc">​</a></h2>
<p>Starting from version 4.1t (released in July 2022), <a href="https://code.kx.com/q/ref/dotq/#gc-garbage-collect" target="_blank" rel="noopener noreferrer"><code>.Q.gc[0]</code></a>  has been introduced to execute a subset of operations performed by <code>.Q.gc[]</code>, specifically, returning only unused blocks &gt;= 64MB to the OS. This offers the advantage of faster execution compared to <code>.Q.gc[]</code>, but it comes with the drawback of not defragmenting unused memory blocks of smaller sizes and hence, it may not free as much unused memory.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>In conclusion, understanding memory management and garbage collection is pivotal when working with KDB/Q to ensure optimal performance in real-time data processing. Contrary to traditional concepts of garbage collection, KDB/Q adopts a reference counting mechanism, promptly releasing memory whenever an object is no longer referenced. This eliminates the concept of &quot;garbage&quot; in KDB/Q, as unreferenced memory is efficiently reallocated for new data. The system command <code>.Q.gc[]</code> and the <code>-g</code> flag, when set to 1, provide means to return unreferenced memory blocks larger or equal to 64MB to the OS. However, the careful use of these tools is crucial, as <code>.Q.gc[]</code> defragments unused memory, whereas <code>-g 1</code> may not efficiently free smaller-sized memory blocks. Considerations about latency and performance implications are essential, especially in high-frequency applications, urging developers to weigh the trade-offs when deciding to invoke garbage collection operations in KDB/Q.</p>
<p>As usual, feel free to reach out if you have any questions.</p>
<p>Resources:</p>
<ol>
<li><a href="https://www.timestored.com/kdb-guides/memory-management" target="_blank" rel="noopener noreferrer">Memory Management in KDB</a> by Ryan Hamilton</li>
<li><a href="https://dataintellect.com/blog/garbage-collection-kdb/" target="_blank" rel="noopener noreferrer">Garbage Collection in KDB+</a> by Data Intellect</li>
<li><a href="https://code.kx.com/q/ref/dotq/#gc-garbage-collect" target="_blank" rel="noopener noreferrer">.Q.gc</a> KX Reference Card</li>
<li><a href="https://kx.com/academy/modules/memory-management-query-optimization/#memory-management-query-optimization" target="_blank" rel="noopener noreferrer">Memory Management and Query Optimization</a> KX Academy</li>
<li><a href="https://www.amazon.co.uk/Tips-Scalable-Maintainable-19-Mar-2015-Paperback/dp/B011T8G1BI/ref=sr_1_1?crid=24RJTTLOLGLDL&amp;dib=eyJ2IjoiMSJ9.lmMNTN0zZdbFzy5nD8D0YA.vuxL-ioxwBocxvLYxn43KZMqCNrm2IaHLGZ_Z-NqUhc&amp;dib_tag=se&amp;keywords=nick+psaris&amp;qid=1708596183&amp;sprefix=%2Caps%2C61&amp;sr=8-1" target="_blank" rel="noopener noreferrer">Q Tips</a> by Nick Psaris</li>
<li><a href="https://www.techtarget.com/searchstorage/definition/virtual-memory" target="_blank" rel="noopener noreferrer">Virtual Memory</a> by Alexander S. Gillis</li>
</ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/concepts/memoryManagement"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Memory Management</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/concepts/amend"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Amend, Amend At: The Swiss Army knife among KDB/Q operators</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#memory-allocation" class="table-of-contents__link toc-highlight">Memory Allocation</a></li><li><a href="#reference-counting" class="table-of-contents__link toc-highlight">Reference Counting</a></li><li><a href="#qgc-and-coalescing-memory" class="table-of-contents__link toc-highlight"><code>Q.gc[]</code> and Coalescing Memory</a></li><li><a href="#the-system-command--g" class="table-of-contents__link toc-highlight">The system command <code>-g</code></a></li><li><a href="#why-qgc-and--g-1-can-be-bad" class="table-of-contents__link toc-highlight">Why .Q.gc[] and <code>-g 1</code> can be bad</a></li><li><a href="#recent-changes-in-qgc" class="table-of-contents__link toc-highlight">Recent changes in <code>.Q.gc[]</code></a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Learn</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/company/defconq/" target="_blank" rel="noopener noreferrer" class="footer__link-item">DefconQ Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/alexanderunterrainer/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Alexander Unterrainer Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://www.youtube.com/@DefconQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube Channel<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/DefconQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 DefconQ Ltd. This website is maintained by Alexander Unterrainer. Disclaimer: All content shared on this website reflect solely his personal thoughts and opinions, and is not representative of any past, current, or future employers or affiliations.</div></div></div></footer></div>
</body>
</html>