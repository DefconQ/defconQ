<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/ipcNextLevel" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">Beyond the Fundamentals: Next Level Interprocess Communications | DefconQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://DefconQ.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://DefconQ.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://DefconQ.github.io/docs/concepts/ipcNextLevel"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Beyond the Fundamentals: Next Level Interprocess Communications | DefconQ"><meta data-rh="true" name="description" content="In my last blog post, we covered the essential concepts of Interprocess Communication (IPC) in KDB/Q. Now, it&#x27;s time to take things up a notch!"><meta data-rh="true" property="og:description" content="In my last blog post, we covered the essential concepts of Interprocess Communication (IPC) in KDB/Q. Now, it&#x27;s time to take things up a notch!"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://DefconQ.github.io/docs/concepts/ipcNextLevel"><link data-rh="true" rel="alternate" href="https://DefconQ.github.io/docs/concepts/ipcNextLevel" hreflang="en"><link data-rh="true" rel="alternate" href="https://DefconQ.github.io/docs/concepts/ipcNextLevel" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://R6JV2N50EX-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DefconQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DefconQ Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E9ED09HNE3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-E9ED09HNE3",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="DefconQ" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5860f28a.css">
<script src="/assets/js/runtime~main.6b59dc10.js" defer="defer"></script>
<script src="/assets/js/main.8ede508e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#74e8a3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">Stay up to date with the latest blogs posts - subscribe to my free Substack newsletter now <a href="https://defconq.substack.com">Free Substack Newsletter</a> or follow me on <a href="https://medium.com/@defconq">Medium</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DefconQ Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="150" width="50"><img src="/img/logoLight.svg" alt="DefconQ Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="150" width="50"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Learn</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about/about">About</a><a class="navbar__item navbar__link" href="/testimonials/testimonials">Testimonials</a><a class="navbar__item navbar__link" href="/happyHour/happyHour">Happy Hour</a><a class="navbar__item navbar__link" href="/cv/cv">CV</a><a href="https://defconq.substack.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Substack Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://medium.com/@defconq" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Medium<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://defconq.myspreadshop.co.uk" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Swag<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/DefconQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdbq-study-roadmap">KDB/Q Study Roadmap</a><button aria-label="Expand sidebar category &#x27;KDB/Q Study Roadmap&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdbq-language">KDB/Q Language</a><button aria-label="Expand sidebar category &#x27;KDB/Q Language&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdbq-architecture">KDB/Q Architecture</a><button aria-label="Expand sidebar category &#x27;KDB/Q Architecture&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/important-concepts">Important Concepts</a><button aria-label="Collapse sidebar category &#x27;Important Concepts&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/attributes">Attributes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/memoryManagement">Memory Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/garbageCollection">Garbage Collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/amend">Amend, Amend At: The Swiss Army knife among KDB/Q operators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/dictionariesTables">Dictionaries and Tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/qsql">QSQL - Querying Your Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/fby">Mastering the Art of Filtering: An In-Depth Look at fby in KDB/Q</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/functionalSelect">Embracing Terseness: Functional Forms and Parse Trees</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/joins">Joins: Connecting the Dots for Data Clarity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/iterators">Iterators: Navigating Vectors Without the Need for Loops</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/ipc">Fundamentals of Interprocess Communication (IPC)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/concepts/ipcNextLevel">Beyond the Fundamentals: Next Level Interprocess Communications</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/design-patterns-for-kdbq-systems">Design Patterns for KDB/Q Systems</a><button aria-label="Expand sidebar category &#x27;Design Patterns for KDB/Q Systems&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorials">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/productivity-tools">Productivity Tools</a><button aria-label="Expand sidebar category &#x27;Productivity Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/important-concepts"><span itemprop="name">Important Concepts</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Beyond the Fundamentals: Next Level Interprocess Communications</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Beyond the Fundamentals: Next Level Interprocess Communications</h1>
<p>In my last blog post, we covered the essential concepts of <strong>Interprocess Communication (IPC)</strong> in KDB/Q. Now, it&#x27;s time to take things up a notch!</p>
<p>In this post, we’ll explore advanced IPC techniques that are crucial for building more sophisticated <strong>KDB/Q Tick applications</strong>. Whether you&#x27;re enhancing the standard Tick setup with components like a Gateway or Load Balancer, or simply looking to optimize your existing architecture for better efficiency and performance, these concepts will be invaluable. The topics we are going to cover are the follwoing</p>
<ul>
<li><strong>Asynchronous Broadcast</strong></li>
<li><strong>Asynchronous Callbacks</strong></li>
<li><strong>Deferred Synchronous Messaging</strong></li>
<li><strong>Deferred Response</strong></li>
</ul>
<p>All of these concepts are covered in the official documentation at <a href="https://code.kx.com/home/" target="_blank" rel="noopener noreferrer">code.kx.com</a>, but my goal is to break them down into simple, digestible explanations, one byte (pun intended) at a time. If you need a refresher on the <strong>Fundamentals of IPC</strong>, you can check out my previous blog post <a href="https://www.defconq.tech/docs/concepts/ipc" target="_blank" rel="noopener noreferrer">here</a>. Otherwise, let’s get straight to it, let&#x27;s immerse ourselves into the world of IPC mastery!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="asynchronous-broadcasting">Asynchronous Broadcasting<a href="#asynchronous-broadcasting" class="hash-link" aria-label="Direct link to Asynchronous Broadcasting" title="Direct link to Asynchronous Broadcasting">​</a></h2>
<p>In <a href="https://code.kx.com/q/releases/ChangesIn3.4/" target="_blank" rel="noopener noreferrer">KDB/Q version 3.4</a>, KX introduced asynchronous broadcast, also known as <a href="https://code.kx.com/q/basics/internal/#-25x-async-broadcast" target="_blank" rel="noopener noreferrer"><code>-25!</code></a>, enabling the broadcasting of data as an asynchronous message to specific handles. But why was this feature implemented? To understand this, we need to take a step back and examine what happens behind the scenes when data is sent via Interprocess Communication (IPC).</p>
<p>Transmitting raw data can be inefficient and slow, which is why KDB/Q serializes data before sending it, and the receiving process then deserializes it. While this process is usually fast for small amounts of data, it can become increasingly time-consuming when dealing with large datasets or sending data to multiple processes. This inefficiency is particularly noticeable in the default implementation of the plain vanilla Tickerplant, as shown in the code below. (For a detailed walkthrough of the plain vanilla Tickerplant, check out my blog post <a href="https://www.defconq.tech/docs/tutorials/tick" target="_blank" rel="noopener noreferrer">here</a>).</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.u.pub:{[t;x]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {[t;x;w] if[count x:.u.sel[x] w 1;(neg first w)(`upd;t;x)]}[t;x] each .u.w[t]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As shown in the code above, we iterate over all subscriber handles for a specific table, sending the data asynchronously to each one. This approach requires the message to be serialized separately for every subscriber, which can introduce performance overhead and slow down the process.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You can use the internal functions <a href="https://code.kx.com/q/basics/internal/#-8x-to-bytes" target="_blank" rel="noopener noreferrer"><code>-8!</code></a> and <a href="https://code.kx.com/q/basics/internal/#-9x-from-bytes" target="_blank" rel="noopener noreferrer"><code>-9!</code></a> for data serialization and deserialization. <code>-8!x</code> converts <code>x</code> into its IPC byte representation, while <code>-9!x</code> reconstructs data from its IPC byte format. Explore more serialization examples <a href="https://code.kx.com/q/kb/serialization/" target="_blank" rel="noopener noreferrer">here</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Serialise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-8!1 2 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x010000001a000000060003000000010000000200000003000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Deserialise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-9!-8!1 2 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>To optimize this process, KX introduced asynchronous broadcast. The key advantage of <code>-25!(handles;msg)</code> over <code>neg[handles]@\:msg</code> is that it serializes the message only once, significantly reducing CPU and memory load. The message is serialized to the lowest capability of the list of handles, meaning if the connected processes are running different versions of KDB/Q, the serialization will be limited to the types supported by the oldest version. If an error occurs, no messages are sent, and the function will return the handle whose capability caused the failure.</p>
<p>Similar to <code>neg[handles]@\:msg</code>, the <code>-25!x</code> operation queues the message as asynchronous on the specified handles. The messages are not sent immediately but will be dispatched during the next iteration of the main loop or can be flushed manually using <code>neg[handles]@\:(::)</code> or <code>-25!(handles; ::)</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="asynchronous-callbacks">Asynchronous Callbacks<a href="#asynchronous-callbacks" class="hash-link" aria-label="Direct link to Asynchronous Callbacks" title="Direct link to Asynchronous Callbacks">​</a></h2>
<p>So far, we’ve covered fairly straightforward concepts of Interprocess Communication. Now, it’s time to explore something slightly more advanced: <strong>Asynchronous Callbacks</strong>. This technique is especially useful when you want to maintain fully asynchronous communication between processes, ensuring maximum efficiency, neither process gets blocked or has to wait for a response.</p>
<p>While implementing asynchronous callbacks isn’t overly complex, there’s one critical rule to follow: <strong>both the client and the server must use async calls</strong>. Failing to do so can lead to a <strong>deadlock</strong>. For instance, due to KDB/Q&#x27;s single-threaded nature, if the client makes a synchronous call, the server’s attempt to call back will hang indefinitely since the original synchronous call is still being processed.</p>
<p>Let’s go through some examples to see asynchronous callbacks in action!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unary-functions">Unary Functions<a href="#unary-functions" class="hash-link" aria-label="Direct link to Unary Functions" title="Direct link to Unary Functions">​</a></h3>
<p>Let&#x27;s start with a simple example: invoking a unary function (a function that takes a single argument) via an asynchronous call on the server side. The server will evaluate the function and send the result back to the client.</p>
<p>On the client side, we&#x27;ll define a function to handle the server&#x27;s response. Once the function is processed, the server will <strong>&quot;call back&quot;</strong> to the client process that originally invoked it, triggering the client-side function to process the result.</p>
<p>The following code snippet demonstrates this behavior:</p>
<p>First, we define two functions on the server: one to process and handle the client call and invoke a unary function, and secondly the actual unary function, invoked by the function that processes the request, itself. While it&#x27;s not strictly necessary to separate them, as everything could be handled within a single function, for clarity, I&#x27;ve chosen to break it down into two distinct functions. This makes it easier to understand each step of the process. After this example, we’ll explore how to consolidate everything into a single function.</p>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// just a reminder, our server runs on port 6001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)\p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// A unary function taking one argument. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)unaryServerFunction:{show &quot;Hello from the client side. This is client: &quot;,string x}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, we define the function responsible for handling the client&#x27;s request and executing the previously defined unary function. We then send an asynchronous message to the client, calling the client function that was provided as the <code>y</code> parameter in the request-handling function.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)processClientRequest:{unaryServerFunction x;(neg .z.w)(y;&quot;Hello from the server side&quot;)}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>CLIENT</strong></p>
<p>Now, the final step is to define the client function that will process the result returned by the server. Once that&#x27;s in place, we can send an asynchronous message to the server, calling the <code>processClientRequest</code> function and passing the client name as the <code>x</code> parameter and the client function name as the <code>y</code> parameter for the server to invoke as a callback.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// h contains the connection handle to the server </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// define client function to be invoked by the server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)clientFunction:{show x}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// asynchronous call to the server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`processClientRequest;`DefconQ;`clientFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)&quot;Hello from the server side&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Asynchronous Callback" src="/assets/images/asynchronousCallback-3197916c1dec40ee33acd14cba16af3f.png" width="3420" height="356" class="img_ev3q"></p>
<p>That wasn’t too difficult! Earlier, I mentioned that everything we just implemented using two functions could actually be done in a single function. Do you think that’s possible? It absolutely is! All we need to do is make a small adjustment to the <code>unaryServerFunction</code>, modifying it so that it prints the &quot;Hello from the client side&quot; message to the console and then sends an asynchronous message back to the client. The code snippet below highlights the necessary changes on the server side, no modifications are needed on the client side since the overall behavior remains unchanged.</p>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)unaryServerFunction:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	show &quot;Hello from the client side. This is client: &quot;,string x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	(neg .z.w)(y;&quot;Hello from the Server side&quot;)}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Asynchronous Callback with one function only" src="/assets/images/asynchronousCallback2-ae2c3ff4ed924fb2d70827d956c52914.png" width="3406" height="466" class="img_ev3q"></p>
<p>That wasn’t too difficult either! At this point, you might be thinking that interprocess communication isn’t all that challenging after all. But, as with anything in programming, or life in general, you should always expect the unexpected. What do I mean by that? Well, what if the client sends an incorrect data type as a parameter to the unary function on the server? What would happen then?</p>
<p><img decoding="async" loading="lazy" alt="QA Testing" src="/assets/images/QATestingMeme-bc0b35b7ea54ee3903991d5e65558f07.jpeg" width="800" height="660" class="img_ev3q"></p>
<p>Let&#x27;s walk through an example. First, we&#x27;ll define a function called square <code>square</code> on the server, which takes a parameter <code>x</code>, computes its square, and returns the result. Additionally, it will print the result to the console. We&#x27;ll then refactor our <code>processClientRequest</code> function to invoke the<code>square</code> function with the parameter provided by the client and return the result via an asynchronous callback. Once again, there’s no need to modify anything on the client side, all we have to do is send an asynchronous message to the server, invoking <code>processClientRequest</code> with the appropriate parameters.</p>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)square:{show &quot;The square of &quot;,string[x],&quot; is &quot;,string[res:x*x];:res}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)processClientRequest:{result:square x;(neg .z.w)(y;&quot;Squaring &quot;,string[x],&quot; returns :&quot;,string result)}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>CLIENT</strong></p>
<p>With our server-side functions now refactored, the final step is to invoke them asynchronously from the client. Let&#x27;s start by passing a valid integer to be squared.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`processClientRequest;4;`clientFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Answer from server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)&quot;Squaring 4 returns :16&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>SERVER</strong></p>
<p>The request was successfully processed on the server, with the result logged to the console and then sent back to the client, which also displayed it on its console (as shown above).</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)&quot;The square of 4 is 16&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Asynchronous Callback Testing with correct data type" src="/assets/images/AsynchronousCallbackTestingCorrect-d883a2031e23bccf34c4aea4d00275a6.png" width="3420" height="234" class="img_ev3q"></p>
<p>Next, let&#x27;s repeat the same exercise but pass a symbol data type instead. Since the <code>square</code> function on the server expects a numerical input, this will naturally result in a <code>type</code> error.</p>
<p><strong>CLIENT</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`processClientRequest;`DefconQ;`clientFunction)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [2]  square:{show &quot;The square of &quot;,string[x],&quot; is &quot;,string[res:x*x];:res}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q))\</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Asynchronous Callback Testing with incorrect data type" src="/assets/images/AsynchronousCallbackTestingIncorrect-2274598e335502bec6741f7b9c9474d4.png" width="3416" height="478" class="img_ev3q"></p>
<p>As seen in the code snippet and screenshot above, the server encountered a <code>type</code> error and has entered debug mode. You will need to manually exit it using the backslash <code>\</code> command.</p>
<p>This behavior is highly undesirable and must be avoided at all costs, as it results in the server becoming unresponsive until manual intervention. In a large investment bank or hedge fund processing millions of trades daily, even a few minutes of downtime could lead to substantial financial losses.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="error-trapping-safeguard-your-code">Error Trapping: Safeguard Your Code<a href="#error-trapping-safeguard-your-code" class="hash-link" aria-label="Direct link to Error Trapping: Safeguard Your Code" title="Direct link to Error Trapping: Safeguard Your Code">​</a></h4>
<p>How can we prevent situations like the one we just encountered? Luckily, nearly every programming language offers a mechanism for handling exceptions. If you&#x27;re familiar with languages like Java, you might recognize this as a <strong>try-catch</strong> statement. In KDB/Q, exception handling is managed using the <strong>trap</strong> operator. And in good KDB/Q manner, this is an operator we have already seen several times, having multiple overloads, one of which serves as <strong>trap</strong>. Here’s the syntax:</p>
<table><thead><tr><th>Name</th><th>Syntax</th><th>Description</th></tr></thead><tbody><tr><td>Trap At</td><td><code>@[f;fx;e]</code></td><td>Try <code>f@fx</code>;    catch with <code>e</code></td></tr><tr><td>Trap</td><td><code>.[g;gx;e]</code></td><td>Try <code>g . gx</code>;  catch with <code>e</code></td></tr></tbody></table>
<p>where</p>
<ul>
<li><code>f</code> is a unary function, with <code>fx</code> as an argument within its domain.</li>
<li><code>g</code> is a function with a specified rank, and <code>gx</code> is either an atom or a list of length <strong>count</strong>  containing elements within the domain of <code>g</code>.</li>
<li><code>e</code> represents an expression, usually a function.</li>
</ul>
<p>Now, let&#x27;s put the trap operator into action and see how it works in practice. First, we define two functions in our KDB/Q process: a unary function, <code>square</code>, which takes a single argument and returns its square, and a binary function that accepts two arguments and returns their sum. By using the <code>trap</code> operator with <code>@</code> and <code>.</code> to invoke these functions, we can catch any errors that occur without disrupting the program flow. Instead of halting execution, the error message is returned gracefully.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)square:{x*x}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)add:{x+y}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)@[square;4;{&quot;Error message: &quot;,x}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)@[square;`DefconQ;{&quot;Error message: &quot;,x}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Error message: type&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).[add;(3;4);{&quot;Error message: &quot;,x}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).[add;(`DefconQ;4);{&quot;Error message: &quot;,x}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Error message: type&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let&#x27;s apply this knowledge within a function to prevent process interruptions. By wrapping our function calls with <code>trap</code>, we can ensure that any errors are handled gracefully, allowing the program to continue running smoothly instead of getting stuck in debug mode. First, we define a function that invokes the previously defined <code>square</code> function without using <code>trap</code> to observe how it behaves when called with an incorrect data type..</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)functionWithoutErrorTrap:{[x] res:square[x]; show &quot;Function continues&quot;;:&quot;Return success. Result is: &quot;,string res}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)square[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)functionWithoutErrorTrap[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Function continues&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Return success. Result is: 4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)functionWithoutErrorTrap[`DefconQ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [2]  square:{x*x}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q))\</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, we create another function with the same functionality but explicitly use <code>trap</code> to catch any potential errors. In the first case, the program flow is interrupted, causing the process to enter debug mode until we manually exit using the backslash operator. However, in the second case, <code>trap</code> ensures that errors are handled gracefully, preventing any disruption to the process flow.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)functionWithErrorTrap:{[x] res:@[square;x;{&quot;Error message: &quot;,x}];show &quot;Function continues&quot;;:&quot;Return success. Result is: &quot;,res}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)functionWithErrorTrap[`DefconQ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Function continues&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Return success. Result is: Error message: type&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="trap-gotchas">Trap Gotchas<a href="#trap-gotchas" class="hash-link" aria-label="Direct link to Trap Gotchas" title="Direct link to Trap Gotchas">​</a></h5>
<p>One key consideration when using <strong>trap</strong> is how KDB/Q evaluates expressions. As we saw in the syntax <code>@[f;fx;e]</code>, the expression <code>e</code> can be any valid KDB/Q expression. However, KDB/Q evaluates expressions before executing the actual code, meaning that if <code>e</code> contains a syntax error, your code will fail before trap even gets a chance to run. Additionally, since <code>e</code> is evaluated first, any code within it will execute immediately, regardless of whether an error occurs in <code>f@fx</code>. In most cases, you’ll want <code>e</code> to be a function that only executes when an error is thrown, ensuring it runs only when needed. The below examples should illustrate this behaviour:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)@[square;2;nonExistingVariable]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;nonExistingVariable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  @[square;2;nonExistingVariable]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)@[square;2;{nonExistingVariable}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)@[square;2;{nonExistingVariable]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  @[square;2;{nonExistingVariable]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)@[square;2;a:20]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)@[square;2;{ `a set 100}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)@[square;`b;{ `a set 100}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="variadic-functions">Variadic Functions<a href="#variadic-functions" class="hash-link" aria-label="Direct link to Variadic Functions" title="Direct link to Variadic Functions">​</a></h3>
<p>We’ve now explored how to use asynchronous callbacks with a unary function. Next, let’s move on to asynchronous callbacks for variadic functions, functions that can accept any number of arguments. To illustrate this, we’ll define a <code>sum</code> function on the server that takes three arguments, <code>x,y and z</code>, and returns their sum. We’ll then use <strong>apply</strong> (another overload of <code>.</code>) to pass the parameters received from the client via an asynchronous call and return the result. The code for this example is provided below.</p>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)add:{x+y+z}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)processClientRequest:{show res:add . x;(neg .z.w)(y;res)}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the client side, we can now make an asynchronous call to the server, invoking the <code>processClientRequest</code> function and passing the list of arguments to be passed to the <code>add</code> function defined on the server. The result is first logged to the console on the server side before being sent back to the client, where it is then displayed on the console as well.</p>
<p><strong>CLIENT</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)clientFunction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{show x}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`processClientRequest;1 2 3;`clientFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// result from the server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Asynchronous Callback Testing with variadic Function" src="/assets/images/AsynchronousCallbackVariadic-70a8b93a67beecca0109a6ea79b713f2.png" width="3420" height="356" class="img_ev3q"></p>
<p>This worked perfectly! However, there&#x27;s something worth considering, our example is quite limited, as it only handles a single specific use case: calculating the sum of three numbers on the server. In a real-world KDB/Q Tick Architecture, this wouldn&#x27;t be practical. So how can we make it more flexible? The solution is to create a wrapper function and refactor our code to handle a wider range of scenarios.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="wrapper-function">Wrapper Function<a href="#wrapper-function" class="hash-link" aria-label="Direct link to Wrapper Function" title="Direct link to Wrapper Function">​</a></h3>
<p>To make the asynchronous communication between our client and server more flexible, we&#x27;ll modify the <code>processClientRequest</code> function on the server. Instead of being limited to a specific function, it will now accept the name of any function defined on the server as a parameter, evaluate it with the provided arguments, and return the result to the client that initiated the asynchronous call.</p>
<p>To evaluate any function dynamically on the server, we leverage the evaluate-by-name concept. By passing the function name as a parameter, we can use the <code>value</code> operator in KDB/Q to retrieve and execute the corresponding function definition. Let’s illustrate this with an example.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{x+y}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)value `add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{x+y}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(value `add)[2;3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, we can apply this knowledge to refactor our code and achieve the desired functionality. The following code implements these changes.</p>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)add:{x+y}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)sub:{x-y}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)processClientRequest:{show res:(value x) . y;(neg .z.w)(z;res)}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>CLIENT</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// invoke the add function on the server, adding 5 to 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`processClientRequest;`add;10 5;`clientFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// invoke the sub function on the server, subtracting 5 from 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`processClientRequest;`sub;10 5;`clientFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Pretty cool, right?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="anonymous-functions">Anonymous Functions<a href="#anonymous-functions" class="hash-link" aria-label="Direct link to Anonymous Functions" title="Direct link to Anonymous Functions">​</a></h3>
<p>But we can take it even further! By leveraging an anonymous function, we can combine everything we&#x27;ve learned so far to achieve the same functionality, without defining any functions on the server at all. And if we really want to push the boundaries, we don&#x27;t even need to define the function that processes the result on the client either. Let&#x27;s dive in and explore how this works!</p>
<p><strong>CLIENT</strong></p>
<p>First, to keep things simple, we&#x27;ll use a single anonymous function while still relying on the <code>clientFunction</code> defined on our client to handle the result returned by the server. Remember, we can send a query via Interprocess Communication as a parse tree using the syntax <code>(functionName; arg1; ...; argN)</code>. In this case, instead of specifying a function name to be executed on the server, we send an anonymous function. This function takes three parameters: <code>x</code> and <code>y</code>, which are numeric values used to compute the sum of two numbers, and <code>z</code>, which represents the function name to be invoked on the client side when the server returns the result.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h]({(neg .z.w)(z;x+y)};10;5;`clientFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)15</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where</p>
<ul>
<li><code>{(neg .z.w)(z;x+y)}</code> is the anonymous function taking three parameters, <code>x,y,z</code></li>
<li><code>x and y</code> are numeric values used to compute the sum of two numbers</li>
<li><code>z</code> the function name to be invoked on the client side when the server returns the result</li>
</ul>
<p>Let&#x27;s take it a step further by replacing the function name intended for invocation on the client with another anonymous function. This makes the entire process completely independent of any predefined functions on either the client or server.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h]({(neg .z.w)(z;x+y)};10;5;{show x})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)15</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deferred-synchronous-messaging">Deferred Synchronous Messaging<a href="#deferred-synchronous-messaging" class="hash-link" aria-label="Direct link to Deferred Synchronous Messaging" title="Direct link to Deferred Synchronous Messaging">​</a></h2>
<p>After exploring asynchronous callbacks, we now understand a powerful communication method that enables efficient interaction between KDB/Q processes without causing any of them to block. But is this always the best approach? What if the process sending an asynchronous call depends on the result and cannot proceed until it receives a response? Consider a client querying a load balancer, which then distributes the request across multiple backend processes. The client needs the full response before it can continue execution. In our previous asynchronous callback examples, the client never waited for a response, it simply sent the query and moved on. This can be problematic in scenarios where the client must wait for the result.</p>
<p>This is exactly where we are going to leverage <strong>Deferred Synchronous Messaging</strong>: This technique involves sending an asynchronous message first and immediately flushing the output queue by following up with a synchronous message. This ensures that the client remains blocked until a response is received, allowing for controlled execution flow.</p>
<p>Before discussing <strong>deferred synchronous messaging</strong> in detail, let’s quickly revisit the difference between synchronous and asynchronous messaging:</p>
<ul>
<li><strong>Synchronous messaging</strong> pauses the client process after sending a request, waiting for a response from the server before continuing.</li>
<li><strong>Asynchronous messaging</strong> allows the client to continue execution immediately after sending a request, without waiting for or expecting a reply.</li>
</ul>
<p>Since asynchronous messages do not expect a return value, what happens if the server does send a response to an asynchronous request? Let’s explore this scenario: we have set up two KDB/Q processes, the client running on port <code>6000</code> and the server on port <code>6001</code>.</p>
<p>Next, we will define a function <code>add</code> on the server that takes two numbers, adds them together, and sends the result back to the client using asynchronous messaging. Now, from the client, we can send an asynchronous request to invoke this function on the server. Let’s see what happens.</p>
<p>First, we define the function on the server, by leveraging the internal <a href="https://code.kx.com/q/ref/dotz/#zw-handle" target="_blank" rel="noopener noreferrer"><code>.z.w</code></a>, which holds the connection handle of the process that sent the query.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)add:{neg[.z.w] x+y}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can now call the function from our client by sending an asynchronous message to the server and observe the outcome.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`add;2;3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)&#x27;type</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Remember, we established a connection from the client to the server using <code>hopen</code>. The connection handle stored in the variable <code>h</code> allows us to send messages and interact with the server.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)h:hopen `::6001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8i</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>As seen in the output, the client encountered a <code>type</code> error. But why did this happen? Remember, in asynchronous messaging, the client sends a query without expecting a response. However, in this case, the server did send a reply back to the client. Unlike receiving an unexpected gift, which might be a pleasant surprise, the client wasn’t prepared for a response, resulting in a  <code>type</code> error.</p>
<p>This is a small but important drawback of asynchronous messaging, if the server sends a response and the client isn&#x27;t expecting it, a <code>type</code> error occurs. However, when using <strong>Deferred Synchronous Messaging</strong> we are essentiallys sending an asynchronous message and then immediately flushing the output queue by following up with a synchronous message. This not only ensures that the client is blocked until a response is received, but by doing this, the client now expects a reply, and when the server sends back the asynchronous callback, the client no longer encounters an error. Let&#x27;s see this in action:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`add;2;3);h[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`add;2;3);h(::)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As seen in the code above, we no longer encounter a <code>type</code> error, and the result from the <code>add</code> function is successfully returned. The two methods, <code>h[]</code> and <code>h(::)</code>, are equivalent, allowing you to choose whichever style suits you best. Additionally, we can store the returned result in a variable for further processing.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)neg[h](`add;2;3);result:h[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)result*2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this, we conclude our deep dive into <strong>Deferred Synchronous Messaging</strong> and can now move on to <strong>Deferred Response</strong>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deferred-response">Deferred Response<a href="#deferred-response" class="hash-link" aria-label="Direct link to Deferred Response" title="Direct link to Deferred Response">​</a></h2>
<p>In the previous section, we explored how deferred synchronous messaging allows a client to send an asynchronous request to the server while immediately blocking itself with a synchronous message. This approach enables the server to process the request without being blocked, delegating tasks to worker processes in the background, aggregating the results, and then returning them to the client.</p>
<p>This method is so widely used that KX introduced a built-in function to optimize gateway efficiency. Starting from <a href="https://code.kx.com/q/releases/ChangesIn3.6/#deferred-response" target="_blank" rel="noopener noreferrer">KDB/Q version 3.6</a>, the <strong>Deferred Response</strong> was introduced. In the next section, we’ll take a closer look at how this works, reinforcing the theory with practical examples.</p>
<p>Even though this technique looks complicated at first, it&#x27;s actually not that hard once you understand it. The deferred response consists of two key components:</p>
<ol>
<li><strong>Suspending a Sync Message</strong>: <code>-30!(::)</code> emporarily suspends the processing of a synchronous message, allowing the response to be sent explicitly at a later time. This enables the server to handle other messages before sending a response.</li>
<li><strong>Sending the Deferred Response</strong>: <code>-30!(handle; isError; msg)</code> is used to respond to the deferred sync call. The <code>isError</code> flag indicates whether an error occurred (<code>1b</code> for an error, <code>0b</code> for success). The <code>msg</code> parameter contains either an error message (if an error occurred) or the actual result of the deferred sync call if execution was successful.</li>
</ol>
<p>The diagram below illustrates this process.</p>
<p><img decoding="async" loading="lazy" alt="Client Gateway interaction with Deferred Response" src="/assets/images/deferredResponse-84d740fb42e87dac6b0d461003912760.gif" width="966" height="578" class="img_ev3q"></p>
<p>As illustrated above, the client first sends a synchronous message (<strong>1</strong>) to the Gateway, which defers the response for later processing, using <code>-30!(::)</code> (<strong>2</strong>). The Gateway then asynchronously dispatches the request (<strong>3</strong>) to the Real-Time Database (RDB) and the Historical Database (HDB) without waiting for an immediate result. Once the RDB and HDB process the query, they return the results (<strong>4</strong> and <strong>5</strong>) asynchronously to the Gateway. The Gateway then aggregates these results (not shown in the diagram) before finally sending the consolidated response back to the client (<strong>6</strong>), using <code>-30!(handle;isError;msg)</code></p>
<p>Now, we can explore a practical example, but before diving into the practical example shown above, let&#x27;s first examine how <strong>suspending a synchronous message</strong> with <code>-30!(::)</code> and sending a <strong>deferred response</strong> via <code>-30!(handle;isError;msg)</code> works.</p>
<p>To do this, we modify the default implementation of  <code>.z.pg</code>, the message handler for synchronous requests, so that it completes the currently executing callback without immediately responding to the client. The <code>-30!(::)</code> command can be used at any point in the execution path of <code>.z.pg</code> to defer the response. This allows us to initiate some work, let <code>.z.pg</code> complete without sending a reply, and then explicitly return the response once the workers have finished processing the task.</p>
<p>We update <code>.z.pg</code> to print the message handle of the client making the synchronous call, along with the function and its corresponding parameters, to the console. The response is then deferred. This allows us to observe how the client remains blocked while the server processes the function and eventually returns the result.</p>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)// SERVER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)\p 6001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).z.pg:{show .z.w;show x;-30!(::)}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>CLIENT</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)// CLIENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h:hopen `::6001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h({x+x};4)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)7i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{x+x}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-30!(7i;0b;{x+x}4)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Deferred Response Explained" src="/assets/images/deferredResponse2-5e399ca83279813a9c43161c4df08702.gif" width="3420" height="1156" class="img_ev3q"></p>
<p>The example above should give you a solid understanding of the concept behind deferred responses. Of course, it&#x27;s a simplified version of how you would use <code>-30!</code> in real-world scenarios.</p>
<p>Before exploring a more practical example, let&#x27;s complete this basic demonstration by showing how to send an error message back to the client. No refactoring is needed, his time, instead of returning a successful result, we will send an error message from the server. Let’s see how that works.</p>
<p>We begin by sending the same synchronous request from the client to the server as before. Once the request is sent, the client will again remain blocked, waiting for a response. Meanwhile, the server is free to continue its execution.</p>
<p><strong>CLIENT</strong></p>
<div class="language-q)// codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-q)// codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)h({x+x};4)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Thanks to our customized <code>.z.pg</code> function, we can observe the connection handle of the process that sent the query, along with the query itself. Now, all that&#x27;s left is to return an error message by setting the <code>isError</code> bollean flag to true (1b) and passing the error message in the form of a string or symbol</p>
<p><strong>SERVER</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q).z.pg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{show .z.w; show x; -30!(::)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)7i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{x+x}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-30!(7i;1b;`thisIsAnError)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The client then receives the response from the server, which in this case is an error. The error message is displayed on the client console.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;thisIsAnError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  h({x+x};4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>One great feature of the Deferred Response in KDB/Q is that it automatically tracks connection handles awaiting a response. If you attempt to send a message to a handle that is not expecting a response, a domain error will be triggered. This behavior is demonstrated in the code snippet below.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)-30!(7i;1b;`thisIsAnError)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;Handle 7 was not expecting a response msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  -30!(7i;1b;`thisIsAnError)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-30!(7i;0b;`noError)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;Handle 7 was not expecting a response msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  -30!(7i;0b;`noError)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mastering-deferred-response-a-practical-gateway-example">Mastering Deferred Response: A Practical Gateway Example<a href="#mastering-deferred-response-a-practical-gateway-example" class="hash-link" aria-label="Direct link to Mastering Deferred Response: A Practical Gateway Example" title="Direct link to Mastering Deferred Response: A Practical Gateway Example">​</a></h3>
<p>Now that we’ve explored the details of deferred response, let’s apply our knowledge to a practical scenario. We’ll build a simple Gateway that handles synchronous queries from a client. This Gateway will forward the client’s query to two worker processes: a Real-time Database (<strong>RDB</strong>) containing intraday trade data and a Historical Database (<strong>HDB</strong>) storing historical data. Once the worker processes evaluate the query, they will return the results to the Gateway, which will aggregate them before sending the final response back to the client. Without further delay, let’s get started!</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This example is an extended, in detailed explained walk through of the example provided by KX <a href="https://code.kx.com/q/kb/deferred-response/" target="_blank" rel="noopener noreferrer">here</a></p></div></div>
<p>Let&#x27;s start by looking at the code for the RDB and HDB, as this is the simplest part, it just involves setting up some dummy trade data. We’ll also define a <code>getTradeData</code> function that retrieves trade data for a given symbol. In the case of the RDB, we’ll add a date column with today’s date before returning the result. This ensures a consistent schema between the RDB and HDB, making it easier to aggregate the results on the Gateway.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="realtime-database-rdb">Realtime Database RDB<a href="#realtime-database-rdb" class="hash-link" aria-label="Direct link to Realtime Database RDB" title="Direct link to Realtime Database RDB">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  1 // RDB  rdb.q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3 // Set the RDB port to 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4 system &quot;p 6000&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  6 // Create an intraday table for trade data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  8 trade:([] time:asc 10?.z.T; sym:10?`AAPL`GOOG`MSFT; price:10?100.; qty:10?1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10 // Create a function to retrieve trade data for a specific symbol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11 // For consistency, we add a date column set to today&#x27;s date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 12 getTradeData:{[s] `date xcols update date:.z.D from select from trade where sym=s}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="historical-database-hdb">Historical Database HDB<a href="#historical-database-hdb" class="hash-link" aria-label="Direct link to Historical Database HDB" title="Direct link to Historical Database HDB">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  1 // HDB  hdb.q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3 // Set the HDB port to 6001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4 system &quot;p 6001&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  6 // Create an intraday table for trade data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  8 trade:([] date:asc 20?.z.D-1 2 3;time:asc 20?.z.T; sym:20?`AAPL`GOOG`MSFT; price:20?100.; qty:20?1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10 // Create a function to retrieve trade data for a specific symbol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11 getTradeData:{[s] select from trade where sym=s}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="gateway">Gateway<a href="#gateway" class="hash-link" aria-label="Direct link to Gateway" title="Direct link to Gateway">​</a></h4>
<p>Now, let&#x27;s move on to our Gateway, which is a bit more complex, but don&#x27;t worry, I will walk you through it step by step.</p>
<p>First, we establish connections to all our worker processes (RDB and HDB) and store these connections in a variable called <code>workerHandles</code>. Next, we create an empty dictionary to store results received from the worker processes for each client handle, he handle of the process that sent a query to the Gateway.</p>
<p>How does this dictionary look in practice? Each entry maps a client handle to a list of tuples. Each tuple consists of two elements <code>clientHandle | ((isError;result1);(isError;result2);...;(isError;resultN))</code>:</p>
<ol>
<li>The <code>isError</code> flag (which we introduced earlier).</li>
<li>The result, which could either be an error message or actual data.</li>
</ol>
<p>Here&#x27;s what that structure looks like:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clientHandle1 | ((0b;result1);(0b;result2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clientHandle2 | ((1b;result1);(0b;result2))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Or, alternatively as actual KDB/Q dictionary</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show pending:4 5!(((0b;10);(0b;11));((1b;20);(1b;21)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4| 0b 10 0b 11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5| 1b 20 1b 21</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, we define a custom <code>.z.pg</code> function to handle all incoming synchronous messages. Inside this function, we create a <code>remoteFunction</code> that will be sent to the worker processes. This function takes two parameters: the client query and the client handle. The client handle is essential for tracking which client the results belong to.</p>
<p>The Gateway sends an asynchronous message to each worker handle, invoking the <code>remoteFunction</code> with the client handle and client query as arguments. The worker processes, in turn, execute the <code>remoteFunction</code> on the worker process, invoking the client function passed by the gateway, and then sends the result back to the Gateway via an asynchronous message.</p>
<p>Finally, our custom <code>.z.pg</code> function defers the response using <code>-30!(::)</code>, ensuring that the client remains blocked while allowing the Gateway to continue processing other tasks.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Customised .z.pg connection handler for synchronous messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.z.pg:{[query]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // function definition to be send to worker processes, executing the client query</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // and sending the result back to the gateway, invoking callback function on GW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remoteFunction: {[clntHandle;query]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        (neg .z.w)(`callback;clntHandle;@[(0b;)value@; query; {[error] (1b;error)}])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // send client query to all worker processes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        neg[workerHandles]@\:(remoteFunction;.z.w;query);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // defer response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -30!(::);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you&#x27;ve been paying close attention to the <code>remoteFunction</code>, you might have noticed an extra <code>@</code> inside the <code>trap</code> command:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@[(0b;) value@; query; {[error] (1b; error)}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You might be wondering why this is necessary. Well, remember that KDB/Q always attempts to evaluate expressions whenever possible. If we only had <code>(0b;) value</code> this would already be considered an evaluable expression. You can see this in the following example:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)(0b;)value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, by adding the additional <code>@</code>, we create a projection that waits for another parameter to be passed, effectively delaying the evaluation of the expression until the parameter is provided.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)(0b;)value@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enlist[0b;]@[.:]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, the final step on our gateway is to implement the callback function that the worker processes will invoke when sending back the result. This callback function takes two arguments: the client handle and the result. It first appends the result to the <code>pending</code> dictionary, keeping track of responses received for a particular client. Then, it checks whether the number of received results matches the total number of worker handles, if so, all responses have arrived; otherwise, it continues waiting for the remaining ones.</p>
<p>Next, the function verifies if an error occurred by summing the error flags. If the sum is zero, no errors were encountered. However, if the sum is greater than or equal to one, it indicates that at least one error was received, setting <code>isError</code> to <code>1b</code>.</p>
<p>The function then retrieves all results associated with a specific client handle. If an error occurred, it returns the first error message; otherwise, it aggregates the worker responses using the <code>raze</code> function. Finally, it sends the result back to the client via the client handle and clears the pending dictionary entry for that client.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// callback function to be called by worker processes when returning result to the gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callback:{[clientHandle;result]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // append current result to the pending results for particular client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pending[clientHandle],:enlist result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // check if we already have all expected results for this client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[count[workerHandles]=count pending[clientHandle];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // check if any of the responses includes an error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                isError:0&lt;sum pending[clientHandle][;0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // grab the results: either error string or data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result:pending[clientHandle][;1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // return the first error or the reduced result to the client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                r:$[isError;{first x where 10h=type each x};reduceFunction] result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // send result to client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -30!(clientHandle;isError;r);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // reset pending results for this client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pending[clientHandle]:();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Putting it all together:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  1 // Gateway  gw.q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3 // Set the Gateway port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4 system &quot;p 5999&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  6 // Connect to all worker handles, i.e. RDB and HDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  7 workerHandles:hopen each 6000 6001;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  9 // Dictionary to keep track of results received for each clientHandle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10 pending:()!();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 12 // function to reduce the results received from the different worker processes. In this case, basic raze</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 13 reduceFunction:raze;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 15 // Customised .z.pg connection handler for synchronous messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 16 .z.pg:{[query]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 17         // function definition to be send to worker processes, executing the client query</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 18         // and sending the result back to the gateway, invoking callback function on GW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 19         remoteFunction: {[clntHandle;query]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 20                         (neg .z.w)(`callback;clntHandle;@[(0b;)value@; query; {[error] (1b;error)}])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 21                         };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 22         // send client query to all worker processes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 23         neg[workerHandles]@\:(remoteFunction;.z.w;query);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 24         // defer response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 25         -30!(::);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 26         };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 29 // callback function to be called by worker processes when returning result to the gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 30 callback:{[clientHandle;result]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 31         // append current result to the pending results for particular client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 32         pending[clientHandle],:enlist result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 33         // check if we already have all expected results for this client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 34         if[count[workerHandles]=count pending[clientHandle];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 35                 // check if any of the responses includes an error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 36                 isError:0&lt;sum pending[clientHandle][;0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 37                 // grab the results: either error string or data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 38                 result:pending[clientHandle][;1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 39                 // return the first error or the reduced result to the client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 40                 r:$[isError;{first x where 10h=type each x};reduceFunction] result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 41                 // send result to client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 42                 -30!(clientHandle;isError;r);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 43                 // reset pending results for this client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 44                 pending[clientHandle]:();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 45         ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 46         };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="client">Client<a href="#client" class="hash-link" aria-label="Direct link to Client" title="Direct link to Client">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)h(`getTradeData;`AAPL)                                                                                                 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date       time         sym  price    qty                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.09 06:16:08.787 AAPL 63.46716 360                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.09 07:14:17.624 AAPL 23.06385 257                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.09 08:50:31.645 AAPL 94.9975  858                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.09 09:01:27.840 AAPL 43.9081  585                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.10 14:17:41.480 AAPL 8.123546 959                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.11 18:21:54.926 AAPL 15.08133 865                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.11 20:02:15.145 AAPL 15.67317 344                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.11 21:09:39.902 AAPL 70.43314 314                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.12 04:25:17.604 AAPL 19.59907 257                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025.03.12 20:26:20.197 AAPL 69.19531 869</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The final step in our example is to launch all the processes, start a client, and test our implementation. Since the Gateway depends on the RDB and HDB, we need to start these processes first. Once they are up and running, we can start the Gateway. Finally, we launch a client and send a synchronous query to the Gateway to see everything in action. Let&#x27;s do it!</p>
<p><img decoding="async" loading="lazy" alt="Deferred Response Example" src="/assets/images/deferredResponseExample-2c05c3bbf930fe50d91f037f0d4cb960.gif" width="3420" height="2214" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bonus-material">Bonus Material<a href="#bonus-material" class="hash-link" aria-label="Direct link to Bonus Material" title="Direct link to Bonus Material">​</a></h2>
<p>After sharing my last article about <strong>Next-level Interprocess Communication</strong> on LinkedIn, I received valuable feedback from two experienced developers. This is exactly what DefconQ is all about: fostering a community where KDB/Q knowledge is shared, and experienced developers help qbies and fellow KDB/Q developers grow.</p>
<p>The first suggestion by <a href="https://www.linkedin.com/in/conor-mahony-5430801b/" target="_blank" rel="noopener noreferrer">Conor Mahony</a>, was to include the <code>.z.pc</code> message handler callback function in the article. The second was a more practical request from <a href="https://www.linkedin.com/in/james-neill-aa127955/" target="_blank" rel="noopener noreferrer">James Neill</a>, asking for an explanation of the default behavior of <code>.z.pg</code>. Let&#x27;s dive into both.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zpc-connection-handler"><a href="https://code.kx.com/q/ref/dotz/#zpc-close" target="_blank" rel="noopener noreferrer"><code>.z.pc</code></a> connection handler<a href="#zpc-connection-handler" class="hash-link" aria-label="Direct link to zpc-connection-handler" title="Direct link to zpc-connection-handler">​</a></h3>
<p>The <code>.z.pc</code> message handler is a unary function triggered when a connection is closed, regardless of the reason. It allows for any necessary cleanup actions and ensures a graceful disconnection. Since the connection is already closed when <code>.z.pc</code> is called, no remote values can be assigned to <code>.z.a</code>, <code>.z.u</code>, or <code>.z.w</code>, and only local values are returned. The function receives a single parameter, <code>x</code> which represents the handle of the process whose connection was terminated.</p>
<p>You might be wondering why it&#x27;s important to <em>worry</em> about processes that close or drop their connection to your process. Let me explain. When developing fully asynchronous applications, you always want to implement <code>.z.pc</code> such that it clears dropped clients. Otherwise, a new client that unexpectedly inherit a previous client handle, which is quite likely, might receive a result that wasn&#x27;t addressed to them. That’s why it&#x27;s highly recommend incorporating <code>.z.pc</code> from the start when working with asynchronous messaging, even if you&#x27;re using deferred response.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="value---the-default-behavior-of-zpg-and-zps"><code>value</code> - The Default Behavior of <code>.z.pg</code> and <code>.z.ps</code><a href="#value---the-default-behavior-of-zpg-and-zps" class="hash-link" aria-label="Direct link to value---the-default-behavior-of-zpg-and-zps" title="Direct link to value---the-default-behavior-of-zpg-and-zps">​</a></h3>
<p>Neill’s request was essentially about what happens when we execute the following code</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q) h([]a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q) h`a`b`c!(1 2;3 4;5 6)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So, let’s run it and analyze the results. We start by launching two KDB/Q processes, a server and a client, then establish a connection from the client to the server. When we execute our code, the first line runs without issues, while the second command results in a type error.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)h `a`b`c!(1 2;3 4;5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5 6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h ([] a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  h ([] a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At first, this might be confusing for qbies, but the explanation is fairly simple. The key insight here is that the default implementation of <code>.z.pg</code> and <code>.z.ps</code> is the <code>value</code> operator. But why is that?</p>
<p>Since queries are typically sent as a <strong>parse three</strong> (which is the preferred format) or as a <strong>string literal</strong>, KDB/Q executes these by applying <code>value</code> to them. This explains why <code>value</code> is the default implementation of <code>.z.pg</code> and <code>.z.ps.</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)value &quot;2+2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)value (+;2;2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h &quot;2+2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h (+;2;2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let’s examine the data types involved in our two queries:</p>
<ul>
<li>In the first query, we sent a dictionary, a structure mapping keys to values. Applying <code>value</code> to a dictionary returns its value part. The response from the server confirms this expected behavior.</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)value  `a`b`c!(1 2;3 4;5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5 6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h `a`b`c!(1 2;3 4;5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5 6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>In the second query, we sent a table. Since a table is essentially a <strong>flipped column dictionary</strong> (or a list of dictionaries), applying <code>value</code> to it results in a <code>type</code> error, as a table does not have a direct <strong>&quot;value&quot;</strong> component.</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)value ([] a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  value ([] a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h ([] a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  h ([] a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To avoid this error, you could flip the table before sending it, since a flipped table is a dictionary, making it compatible with <code>value</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)value flip ([] a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 5 6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)h flip ([] a:1 2 3;b:4 5 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 5 6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And that wraps up our advanced IPC training! You&#x27;re now a master of interprocess communication, at least when it comes to KDB/Q.</p>
<p><strong>Happy coding!</strong></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/concepts/ipc"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Fundamentals of Interprocess Communication (IPC)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/design-patterns-for-kdbq-systems"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Design Patterns for KDB/Q Systems</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#asynchronous-broadcasting" class="table-of-contents__link toc-highlight">Asynchronous Broadcasting</a></li><li><a href="#asynchronous-callbacks" class="table-of-contents__link toc-highlight">Asynchronous Callbacks</a><ul><li><a href="#unary-functions" class="table-of-contents__link toc-highlight">Unary Functions</a><ul><li><a href="#error-trapping-safeguard-your-code" class="table-of-contents__link toc-highlight">Error Trapping: Safeguard Your Code</a><ul><li><a href="#trap-gotchas" class="table-of-contents__link toc-highlight">Trap Gotchas</a></li></ul></li></ul></li><li><a href="#variadic-functions" class="table-of-contents__link toc-highlight">Variadic Functions</a></li><li><a href="#wrapper-function" class="table-of-contents__link toc-highlight">Wrapper Function</a></li><li><a href="#anonymous-functions" class="table-of-contents__link toc-highlight">Anonymous Functions</a></li></ul></li><li><a href="#deferred-synchronous-messaging" class="table-of-contents__link toc-highlight">Deferred Synchronous Messaging</a></li><li><a href="#deferred-response" class="table-of-contents__link toc-highlight">Deferred Response</a><ul><li><a href="#mastering-deferred-response-a-practical-gateway-example" class="table-of-contents__link toc-highlight">Mastering Deferred Response: A Practical Gateway Example</a><ul><li><a href="#realtime-database-rdb" class="table-of-contents__link toc-highlight">Realtime Database RDB</a></li><li><a href="#historical-database-hdb" class="table-of-contents__link toc-highlight">Historical Database HDB</a></li><li><a href="#gateway" class="table-of-contents__link toc-highlight">Gateway</a></li><li><a href="#client" class="table-of-contents__link toc-highlight">Client</a></li></ul></li></ul></li><li><a href="#bonus-material" class="table-of-contents__link toc-highlight">Bonus Material</a><ul><li><a href="#zpc-connection-handler" class="table-of-contents__link toc-highlight"><code>.z.pc</code> connection handler</a></li><li><a href="#value---the-default-behavior-of-zpg-and-zps" class="table-of-contents__link toc-highlight"><code>value</code> - The Default Behavior of <code>.z.pg</code> and <code>.z.ps</code></a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Learn</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/company/defconq/" target="_blank" rel="noopener noreferrer" class="footer__link-item">DefconQ Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/alexanderunterrainer/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Alexander Unterrainer Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://defconq.myspreadshop.co.uk" target="_blank" rel="noopener noreferrer" class="footer__link-item">DefconQ Swag<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://www.youtube.com/@DefconQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube Channel<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://defconq.substack.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Substack Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://medium.com/@defconq" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/DefconQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DefconQ Ltd. This website is maintained by Alexander Unterrainer. Disclaimer: All content shared on this website reflect solely his personal thoughts and opinions, and is not representative of any past, current, or future employers or affiliations.</div></div></div></footer></div>
</body>
</html>