<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/joins" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">Joins: Connecting the Dots for Data Clarity | DefconQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://DefconQ.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://DefconQ.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://DefconQ.github.io/docs/concepts/joins"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Joins: Connecting the Dots for Data Clarity | DefconQ"><meta data-rh="true" name="description" content="So far, we’ve explored how to query data using Q-SQL and how to translate those queries into their corresponding functional forms. Now, let’s take it a step further and dive into joining datasets with KDB/Q. Joins are one of the most powerful tools in KDB/Q, and they play a significant role in its unmatched efficiency for big data analysis. Compared to other languages, KDB/Q joins are not only faster and more efficient but also uniquely versatile, featuring specialized joins like the asof join and window join."><meta data-rh="true" property="og:description" content="So far, we’ve explored how to query data using Q-SQL and how to translate those queries into their corresponding functional forms. Now, let’s take it a step further and dive into joining datasets with KDB/Q. Joins are one of the most powerful tools in KDB/Q, and they play a significant role in its unmatched efficiency for big data analysis. Compared to other languages, KDB/Q joins are not only faster and more efficient but also uniquely versatile, featuring specialized joins like the asof join and window join."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://DefconQ.github.io/docs/concepts/joins"><link data-rh="true" rel="alternate" href="https://DefconQ.github.io/docs/concepts/joins" hreflang="en"><link data-rh="true" rel="alternate" href="https://DefconQ.github.io/docs/concepts/joins" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://R6JV2N50EX-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DefconQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DefconQ Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E9ED09HNE3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-E9ED09HNE3",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="DefconQ" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5860f28a.css">
<script src="/assets/js/runtime~main.867b7601.js" defer="defer"></script>
<script src="/assets/js/main.177074e6.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#74e8a3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">Stay up to date with the latest blogs posts - subscribe to my free Substack newsletter now <a href="https://defconq.substack.com">Free Substack Newsletter</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DefconQ Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="150" width="50"><img src="/img/logoLight.svg" alt="DefconQ Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="150" width="50"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Learn</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about/about">About</a><a class="navbar__item navbar__link" href="/testimonials/testimonials">Testimonials</a><a class="navbar__item navbar__link" href="/cv/cv">CV</a><a href="https://defconq.substack.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://defconq.myspreadshop.co.uk" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Swag<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/DefconQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdbq-study-roadmap">KDB/Q Study Roadmap</a><button aria-label="Expand sidebar category &#x27;KDB/Q Study Roadmap&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdbq-language">KDB/Q Language</a><button aria-label="Expand sidebar category &#x27;KDB/Q Language&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdb-architecture">KDB Architecture</a><button aria-label="Expand sidebar category &#x27;KDB Architecture&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/important-concepts">Important Concepts</a><button aria-label="Collapse sidebar category &#x27;Important Concepts&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/attributes">Attributes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/memoryManagement">Memory Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/garbageCollection">Garbage Collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/amend">Amend, Amend At: The Swiss Army knife among KDB/Q operators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/dictionariesTables">Dictionaries and Tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/qsql">QSQL - Querying Your Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/fby">Mastering the Art of Filtering: An In-Depth Look at fby in KDB/Q</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/functionalSelect">Embracing Terseness: Functional Forms and Parse Trees</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/concepts/joins">Joins: Connecting the Dots for Data Clarity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/iterators">Iterators: Navigating Vectors Without the Need for Loops</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/ipc">Fundamentals of Interprocess Communication (IPC)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts/ipcNextLevel">Beyond the Fundamentals: Next Level Interprocess Communications</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorials">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/productivity-tools">Productivity Tools</a><button aria-label="Expand sidebar category &#x27;Productivity Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/important-concepts"><span itemprop="name">Important Concepts</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Joins: Connecting the Dots for Data Clarity</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Joins: Connecting the Dots for Data Clarity</h1>
<p>So far, we’ve explored how to query data using Q-SQL and how to translate those queries into their corresponding functional forms. Now, let’s take it a step further and dive into <strong>joining datasets</strong> with KDB/Q. Joins are one of the most powerful tools in KDB/Q, and they play a significant role in its unmatched efficiency for big data analysis. Compared to other languages, KDB/Q joins are not only faster and more efficient but also uniquely versatile, featuring specialized joins like the <strong>asof join</strong> and <strong>window join</strong>.</p>
<p>While other databases are beginning to incorporate these advanced join types into their capabilities, KDB/Q has been perfecting them for decades, enabling you to answer complex questions about your data that would otherwise be challenging to tackle. Without further ado, let’s explore this fascinating topic!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-we-use-joins">Why we use Joins<a href="#why-we-use-joins" class="hash-link" aria-label="Direct link to Why we use Joins" title="Direct link to Why we use Joins">​</a></h2>
<p>Before we start exploring joins in greater detail, let’s take a step back and consider why we use them in the first place. Why not just store all our data in one massive table and eliminate the need for joins entirely? While possible, such an approach would violate many best practices in software development and lead to significant inefficiencies. The schema for such a table would be absolutely horrendous, with potentially hundreds of columns, making it difficult to manage and query.</p>
<p>This brings us to one of the core principles of database design: <a href="https://en.wikipedia.org/wiki/Database_normalization" target="_blank" rel="noopener noreferrer"><strong>data normalization</strong></a>. Normalization is the process of organizing a relational database into structured tables following specific rules, called normal forms, to reduce redundancy and improve data integrity. While a deep dive into normalization is beyond the scope of this post, the gist is simple - data is divided into smaller, related tables using keys and reassembled when needed using joins.</p>
<p>Normalization eliminates duplicate data, saving storage space and ensuring consistency. Joins, in turn, restore the flat, rectangular structure needed for effective data analysis. For example, trading data might be stored in one table, while reference data like instrument details resides in another. Joins allow you to combine these datasets seamlessly, enabling meaningful analysis while adhering to good database design principles.</p>
<p>One of the key reasons KDB/Q excels in big data analytics is its exceptional efficiency in performing joins. Additionally, KDB/Q has featured <strong>as-of joins</strong> for nearly three decades - a groundbreaking innovation introduced by Arthur Whitney that enables users to answer questions that would otherwise remain unresolved.</p>
<p>In KDB/Q, joins can be broadly categorized into two main types: Equi (or Exact) Joins and As-of Joins. In the following sections we will look at both categories in more detail and walking through numerous examples to demonstrate their power and versatility.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-joins">Basic Joins<a href="#basic-joins" class="hash-link" aria-label="Direct link to Basic Joins" title="Direct link to Basic Joins">​</a></h2>
<p>Technically, there’s a third category of joins in KDB/Q, though it’s more accurately described as a <strong>concatenation</strong> of tables or columns. Since a table in KDB/Q is essentially a list of conforming dictionaries (if this concept is unfamiliar, check out my dedicated blog post on tables <a href="https://www.defconq.tech/docs/concepts/dictionariesTables#tables" target="_blank" rel="noopener noreferrer">here</a>) , and because tables are first-class citizens in KDB/Q, you can use the simple <strong>concatenate operator</strong> <code>,</code> to merge tables or leverage the <strong>each-both iterator</strong> <code>&#x27;</code> in combination with <code>,</code> to join all columns of two tables using <code>,&#x27;</code>.</p>
<p>Let&#x27;s look at some basic examples to illustrate how this works. We are using the simplified <code>trade</code> and <code>quote</code> tables for these examples:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="merge-tables-effortlessly-joining-records-with-concatenate-">Merge Tables Effortlessly: Joining Records with Concatenate <code>,</code><a href="#merge-tables-effortlessly-joining-records-with-concatenate-" class="hash-link" aria-label="Direct link to merge-tables-effortlessly-joining-records-with-concatenate-" title="Direct link to merge-tables-effortlessly-joining-records-with-concatenate-">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show trade:([] sym:`AAPL`MSFT`GOOG`IBM; price:123.0 45.9 234.4 20.0; qty: 100 45 200 300)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)show quote:([] sym:`AAPL`MSFT`GOOG`IBM; bid:123.1 46.0 245.9 21.9; ask:124.8 46.1 246.2 23.9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first thing you’ll notice when attempting to use the concatenate operator to combine the <code>trade</code> table with the <code>quote</code> table is that it results in a <code>mismatch</code> error. This behavior is expected. Recall that a table in KDB/Q is essentially a list of conforming column dictionaries, and in this case, the <code>trade</code> and <code>quote</code> tables do not conform. The <code>trade</code> table has the columns <code>sym</code>, <code>price</code> and <code>qty</code>, while the <code>quote</code> table contains <code>sym</code>, <code>bid</code>, and <code>ask</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade,quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;mismatch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  trade,quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we attempt to concatenate or join the <code>trade</code> table with itself, it works as expected. Since we are effectively joining the same table to itself, the schemas align perfectly, resulting in a table where each record appears twice. It’s important to note that the records are not sorted in any specific order—they appear sequentially based on how the two individual tables are joined.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade,trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The <a href="https://code.kx.com/q/basics/internal/#0nx-show" target="_blank" rel="noopener noreferrer"><code>0N!</code></a> operator is a powerful tool when it comes to debugging or inspecting the underlying structure of a KBD/Q data type</p></div></div>
<p>The compatibility of the schemas becomes more apparent when you use the <code>0N!</code> operator to inspect the underlying data structure of the <code>trade</code> table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)0N!trade,trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`sym`price`qty!(`AAPL`MSFT`GOOG`IBM`AAPL`MSFT`GOOG`IBM;123 45.9 234.4 20 123 45.9 234.4 20;100 45 200 300 100 45 200 300)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(trade;trade)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`sym`price`qty!(`AAPL`MSFT`GOOG`IBM;123 45.9 234.4 20;100 45 200 300)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`sym`price`qty!(`AAPL`MSFT`GOOG`IBM;123 45.9 234.4 20;100 45 200 300)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As long as the table schemas align, you can concatenate more than two tables without any issues.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade,trade,trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This type of join is particularly useful when combining two tables with identical schemas. However, it’s important to note that this join does not match on any keys, which means it can result in <strong>duplicate records</strong>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="combining-columns-mastering-concatenate-and-each-both-joins">Combining Columns: Mastering Concatenate and Each-Both Joins<a href="#combining-columns-mastering-concatenate-and-each-both-joins" class="hash-link" aria-label="Direct link to Combining Columns: Mastering Concatenate and Each-Both Joins" title="Direct link to Combining Columns: Mastering Concatenate and Each-Both Joins">​</a></h3>
<p>Another useful technique is joining all columns of two tables. To achieve this, we use the concatenate operator <code>,</code> in combination with the each-both iterator <code>&#x27;</code>, resulting in <code>,&#x27;</code>. Since a table in KDB/Q is essentially a list of conforming dictionaries, the concatenation is applied element-wise to each record from both tables. By leveraging the each-both iterator, the first record of the trade table (a dictionary) is joined with the first record of the quote table (also a dictionary), and so on, resulting in the desired merged output.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you need a quick refresher on KDB/Q dictionaries and tables, check out my blog post <a href="https://www.defconq.tech/docs/concepts/dictionariesTables" target="_blank" rel="noopener noreferrer">here</a></p></div></div>
<p>Let&#x27;s take a closer look at how this works in practice. First, let&#x27;s confirm that a table is indeed a list of conform dictionaries. We can do so by simply creating a list of conform dictionaries:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)(`sym`price`qty!(`AAPL;123;100);`sym`price`qty!(`MSFT;45.9;45);`sym`price`qty!(`GOOG;234.4;200);`sym`price`qty!(`IBM;20;300))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>alternatively, a table can be seen as a flipped column dictionary.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)flip (`sym`price`qty!(`AAPL;123;100);`sym`price`qty!(`MSFT;45.9;45);`sym`price`qty!(`GOOG;234.4;200);`sym`price`qty!(`IBM;20;300))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  | AAPL MSFT GOOG  IBM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">price| 123  45.9 234.4 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qty  | 100  45   200   300</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Building on the concept above, we can use the <strong>concatenate</strong> operator <code>,</code> alongside the <strong>each-both</strong> iterator <code>&#x27;</code> to join each record from both tables using <code>,&#x27;</code>. This operation adds any keys and values from the second dictionary that are missing in the first. However, if a key exists in both dictionaries, the value from the right dictionary takes precedence. The result of this operation is a list of conforming dictionaries, which, as we know, forms a valid table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade,&#x27;quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45  46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300 21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There are two key observations to make:</p>
<ol>
<li>If a key exists in both dictionaries, the value from the right dictionary takes precedence.</li>
<li>For this type of join to work, both tables must have the same number of records, which is logical given the element-wise nature of the operation.</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Reverse quote to illustrate that the sym column values of the right table take precedence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(update symTrade:sym from trade),&#x27;reverse quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty symTrade bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  123   100 AAPL     21.9  23.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 45.9  45  MSFT     245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 234.4 200 GOOG     46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 20    300 IBM      123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Use non conform lengths</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade,&#x27;2#quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  trade,&#x27;2#quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With these two fundamental implicit joins covered, let’s move on to the real strength of KDB/Q native joins.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="equi-or-exact-joins">Equi (or Exact) Joins<a href="#equi-or-exact-joins" class="hash-link" aria-label="Direct link to Equi (or Exact) Joins" title="Direct link to Equi (or Exact) Joins">​</a></h2>
<p>The first category of joins, <strong>Equi (or Exact) Joins</strong>, is used when you have one or more columns that uniquely identify the records in a table. These identifiers serve as the basis for matching and combining data from two different datasets. The shape and content of the resulting table depend on the specific type of join used. In the following sections, we’ll explore all the exact joins: <strong>left join</strong> (<code>lj</code>), <strong>inner join</strong> (<code>ij</code>), <strong>union join</strong> (<code>uj</code>), <strong>plus join</strong> (<code>pj</code>), and <strong>equi join</strong> (<code>ej</code>). The common pattern across all these joins is the fact that they rely on one or more key columns to match and align records.</p>
<p>In our examples, we’ll reuse the <code>trade</code> and <code>quote</code> tables from the previous section. To enhance understanding, we’ll illustrate the outcome of each join with graphical representations, making it easier to grasp the mechanics behind each join.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table" src="/assets/images/tradeQuoteTables-a4acce0d1bd73449b8002aac23a528be.png" width="1828" height="442" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="left-join-lj">Left Join <code>lj</code><a href="#left-join-lj" class="hash-link" aria-label="Direct link to left-join-lj" title="Direct link to left-join-lj">​</a></h3>
<p>If you’re familiar with set theory, the concept of a <strong>left join</strong> (<code>lj</code>) will feel intuitive. However, for completeness, let’s break it down. Given an <strong>unkeyed or keyed table</strong> as the <strong>left operand</strong> and a <strong>keyed table</strong> as the <strong>right operand</strong>, a left join matches rows from the right table where the key column(s) align with those in the left table. The result includes all rows from the left table, with matching data from the right table added to it.</p>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Left Join" src="/assets/images/leftJoin-45d6896cef60a180d0c4c98efe50f460.png" width="733" height="516" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="syntax">Syntax<a href="#syntax" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table1 lj table2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where</p>
<ul>
<li><strong>table1</strong> is either a table or keyed table</li>
<li><strong>table2</strong> is a keyed table</li>
</ul>
<p>If the right table lacks data for any record in the left table, the corresponding new columns will contain nulls. However, if the source and target tables have duplicate non-key columns, the operation follows upsert semantics. This means the values in the right operand (target) columns will take precedence over those in the left operand (source). A key detail to remember is that the resulting table will always have the same number of records as the left table, neither expanding nor shrinking.</p>
<p>A practical use case for a left join might involve appending bid and ask prices to trade records or enriching trade data with reference information.</p>
<p>Let&#x27;s look at the example where we join bid and ask prices to trade records:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><strong>Remember</strong>: The right operand needs to be a keyed table</p></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// we key the quote table on the first column (sym)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade lj 1!quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45  46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300 21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As mentioned above, if there are common non-key columns, the left join has upset semantics and the values of the right table prevail. Let&#x27;s illustrate this concept:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Adding a qty column to quote so we have a common column</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade lj 1!select sym,bid,ask,qty:10000 from quote where sym in `AAPL`GOOG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty   bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   10000 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 10000 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Left Join" src="/assets/images/leftJoinTables1-964e117a85e2595f0ec34b0a198ec0ec.png" width="2066" height="950" class="img_ev3q"></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Adding bid and ask column to trades for illustration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(update bid:10.0,ask:11.0 from trade) lj 1!select sym,bid,ask,qty:10000 from quote where sym in `AAPL`GOOG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty   bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   10000 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45    10    11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 10000 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300   10    11</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Left Join" src="/assets/images/leftJoinTables-6de7f28e2b3a4f463cb8e7bb026c4617.png" width="2482" height="896" class="img_ev3q"></p>
<p>In the first example above, we added the <code>qty</code> column to the <code>quotes</code> table to create a shared non-key column. As observed, the resulting join updated the values in the <code>qty</code> column wherever the keys matched (to ensure not all keys matched, we selected only Apple and Google records from the <code>quotes</code> table). For records without a match, the corresponding columns were populated with null values (evident in the <code>bid</code> and <code>ask</code> columns for Microsoft and IBM).</p>
<p>In the second example, we added <code>bid</code> and <code>ask</code> columns to the <code>trade</code> table to demonstrate that only records with matching key columns are updated, while all non-matching records remain unchanged.</p>
<p>When performing a left join on two keyed tables, the result is as expected, with the distinction that the resulting table remains keyed rather than unkeyed.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)(1!trade)lj 1!quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| ---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL| 123   100 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT| 45.9  45  46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG| 234.4 200 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM | 20    300 21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Although KDB/Q <strong>does not</strong> have a dedicated <strong>right join</strong>, you can achieve the same result as a SQL right join by simply swapping the arguments of a left join.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Swapping the arguments to obtain a right join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)quote lj 1!trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  bid   ask   price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123.1 124.8 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 46    46.1  45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 245.9 246.2 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  21.9  23.9  20    300</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="inner-join-ij">Inner Join <code>ij</code><a href="#inner-join-ij" class="hash-link" aria-label="Direct link to inner-join-ij" title="Direct link to inner-join-ij">​</a></h3>
<p>The <strong>Inner Join</strong> <code>ij</code> works similarly to the left join, with one key <em><strong>difference</strong></em>: the resulting table includes <strong>only</strong> the records present in both the left (source) and right (target) table. As with a left join, the right operand must be a keyed table (target), while the left operand can be a table or keyed table (source) with column(s) that serve as foreign key(s) to the target or match the target&#x27;s key column(s) in name and type. Matching is performed on the common column name(s) between the source and the key column(s) of the target, returning only those records with matching keys in both tables.</p>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Inner Join" src="/assets/images/innerJoin-a31dfce724248fe540fb5d2edc2842a8.png" width="784" height="503" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="syntax-1">Syntax<a href="#syntax-1" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table1 ij table2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where</p>
<ul>
<li><strong>table1</strong> is either a table or keyed table</li>
<li><strong>table2</strong> is a keyed table</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade ij 1!update sym:`X from quote where sym in `AAPL`IBM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45  46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200 245.9 246.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Inner Join" src="/assets/images/innerJoinTables-0173bccb2f5f6acbb6beb0c1feebbc29.png" width="1992" height="994" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="union-join-uj">Union Join <code>uj</code><a href="#union-join-uj" class="hash-link" aria-label="Direct link to union-join-uj" title="Direct link to union-join-uj">​</a></h3>
<p>As the name suggests, a union join merges data from two tables. In terms of set theory, the union join is analogous to the union of two sets. It vertically and horizontally combines two tables or keyed tables into a single table. The resulting table is expanded to include new columns and rows from the right operand that do not exist in the left operand, with the same name and type. Records from the left operand appear first in the result, with null values in any newly added columns. Records from the right operand follow, with their field values placed in the corresponding columns. Let’s explore this concept with some examples — it will make things clearer.</p>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Union Join" src="/assets/images/unionJoin-af02d16e1965b78de06cb2b4e65be7cd.png" width="706" height="504" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="syntax-2">Syntax<a href="#syntax-2" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h4>
<p>Unlike left and inner joins, the union join operates exclusively on <strong>two unkeyed tables</strong> or <strong>two keyed tables</strong> - it <strong>does not</strong> support combining a keyed table with an unkeyed table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table1 uj table2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyedTable1 uj keyedTable2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="union-join-for-unkeyed-table">Union Join for unkeyed table<a href="#union-join-for-unkeyed-table" class="hash-link" aria-label="Direct link to Union Join for unkeyed table" title="Direct link to Union Join for unkeyed table">​</a></h4>
<p>When neither table has a key, the union join appends the right table to the left table, filling non-common columns with null values.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade uj quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL           123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT           46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG           245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM            21.9  23.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)quote uj trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  bid   ask   price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  21.9  23.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL             123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT             45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG             234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM              20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Add a common column qty to quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade uj update qty:10 20 30 40 from quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL       10  123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT       20  46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG       30  245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM        40  21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Union Join" src="/assets/images/UnionJoinTables-2e6ed8f6dc8c6d6d2f7ba8d84eabbdce.png" width="2006" height="1206" class="img_ev3q"></p>
<p>As demonstrated in the examples above, the union join of two unkeyed tables combines the tables both vertically and horizontally, filling any missing cells with null values. This behavior becomes particularly evident when we examine the first record of the resulting table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)first trade uj update qty:10 from quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  | `AAPL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">price| 123f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qty  | 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bid  | 0n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ask  | 0n</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="union-join-for-keyed-tables">Union Join for keyed tables<a href="#union-join-for-keyed-tables" class="hash-link" aria-label="Direct link to Union Join for keyed tables" title="Direct link to Union Join for keyed tables">​</a></h4>
<p>When performing a union join on two keyed tables, the operation follows upsert semantics for both rows and columns. This behavior is best understood through an example.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)(1!trade) uj 1!quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| ---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL| 123   100 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT| 45.9  45  46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG| 234.4 200 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM | 20    300 21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Similar to other join operations, if there are common non-key columns, the values from the right operand (table) take precedence.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  21.9  23.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)update qty:10 20 from quote where sym in `MSFT`GOOG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  bid   ask   qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 46    46.1  10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 245.9 246.2 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  21.9  23.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(1!trade) uj 1!update qty:10 20 from quote where sym in `MSFT`GOOG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| ---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL| 123       123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT| 45.9  10  46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG| 234.4 20  245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM | 20        21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Union Join Keyed Tables" src="/assets/images/UnionJoinKeyedTables-6cab446ab734d2eb747a9b9f8fea2f74.png" width="2054" height="1056" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-danger-of-union-joins-handle-with-care">The Danger of Union Joins: Handle with Care<a href="#the-danger-of-union-joins-handle-with-care" class="hash-link" aria-label="Direct link to The Danger of Union Joins: Handle with Care" title="Direct link to The Danger of Union Joins: Handle with Care">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Spiderman" src="/assets/images/spiderMan-d2e13437eedd8d6e7838b78671c8d168.png" width="1002" height="712" class="img_ev3q"></p>
<p>Like Uncle Ben wisely told Peter Parker in Spider-Man: <em><strong>&quot;With great power comes great responsibility.&quot;</strong></em>, the same principle applies to union joins. While incredibly powerful, they require careful handling. The upsert semantics of a union join do not enforce data type conformity, meaning it will upsert values regardless of their type. Let’s examine this in detail.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show t1:([] a:&quot;ABC&quot;; b:1 2 3; c:(&quot;tick&quot;;&quot;tack&quot;;&quot;toe&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a b c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A 1 &quot;tick&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B 2 &quot;tack&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C 3 &quot;toe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)show t2:([] a:`A`B`C; b:1 2 3f; c:3?0Ng)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a b c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A 1 8c6b8b64-6815-6084-0a3e-178401251b68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B 2 5ae7962d-49f2-404d-5aec-f7c8abbae288</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C 3 5a580fb6-656b-5e69-d445-417ebfe71994</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)t1 uj t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a   b  c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;A&quot; 1  &quot;tick&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;B&quot; 2  &quot;tack&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;C&quot; 3  &quot;toe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`A  1f 8c6b8b64-6815-6084-0a3e-178401251b68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`B  2f 5ae7962d-49f2-404d-5aec-f7c8abbae288</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`C  3f 5a580fb6-656b-5e69-d445-417ebfe71994</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As shown in the example above, a union join on two unkeyed tables completely disregards data types. If not approached carefully, this can result in a production run-time nightmare. To avoid such pitfalls, be the (super)hero of your KDB/Q application! Use your power wisely by opting for upsert instead of a union join when your primary goal is to upsert data. Upsert operates by using the amend functionality, either modifying the existing data structure in place or creating a new copy. In doing so, it ensures data type conformity and will throw an error if there is a type mismatch.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)`t1 upsert t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  `t1 upsert t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)upsert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.[;();,;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)1 2 3 upsert 3 4 5f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  1 2 3 upsert 3 4 5f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).[1 2 3;();,;4 5 6f]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  .[1 2 3;();,;4 5 6f]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)1 2 3 union 4 5 6f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)union</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)1 2 3,4 5 6f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The examples above clearly illustrate that upsert enforces data type conformity and raises a type error if any violations occur. A union join on keyed tables ensures data type conformity for the key column and will only succeed if the key column&#x27;s data types are consistent. Unfortunately, data type conformity for non-key columns is not enforced.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show t3:([] a:&quot;ABC&quot;; b:3 4 5f; c:3?0Ng)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a b c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A 3 409031f3-b19c-6770-ee84-6e9369c98697</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B 4 52cb20d9-f12c-9963-2829-3c64d8d8cb14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C 5 cddeceef-9ee9-3847-9172-3e3d7ab39b26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(1!t1) uj 1!t3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a| b c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-| --------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A| 3 409031f3-b19c-6770-ee84-6e9369c98697</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B| 4 52cb20d9-f12c-9963-2829-3c64d8d8cb14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C| 5 cddeceef-9ee9-3847-9172-3e3d7ab39b26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)meta t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c| t f a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-| -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a| c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b| j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c| C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)meta t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c| t f a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-| -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a| s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b| f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c| g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(1!t1) uj (1!t2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0]  (1!t1) uj (1!t2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="plus-join-pj">Plus Join <code>pj</code><a href="#plus-join-pj" class="hash-link" aria-label="Direct link to plus-join-pj" title="Direct link to plus-join-pj">​</a></h3>
<p>The plus join <code>pj</code> works similar to the left join, with one key difference: it adds non-key columns rather than upserting them. This makes it particularly useful when working with two tables that share identical schemas and have numeric non-key columns. The operands for a plus join are the same as those for a left join, with the added requirement that all non-key columns must be numeric. In this operation, duplicate columns are summed across matching keys, while missing or null values are treated as zero.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="syntax-3">Syntax<a href="#syntax-3" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table1 pj table2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where</p>
<ul>
<li><strong>table1</strong> is either a table or keyed table</li>
<li><strong>table2</strong> is a keyed table</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade pj 1!update qty:10 100 1000 10000 from quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty   bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   110   123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  145   46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 1200  245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    10300 21.9  23.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(1!trade) pj 1!update qty:10 100 1000 10000 from quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | price qty   bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL| 123   110   123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT| 45.9  145   46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG| 234.4 1200  245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM | 20    10300 21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Plus Join" src="/assets/images/PlusJoinTables-5b34af09e5e7ecb0ad18d6e1ea2bd5d0.png" width="1994" height="1002" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="equi-join-ej">Equi Join <code>ej</code><a href="#equi-join-ej" class="hash-link" aria-label="Direct link to equi-join-ej" title="Direct link to equi-join-ej">​</a></h3>
<p>Up until now, all our joins have relied on a key column to determine which records from the tables should match and be included in the result. The equi join <code>ej</code>, however, allows you to join two tables even when neither has a primary key. The right operand does not need to be a keyed table. Using the column or list of columns defined as the first parameter, an equi join returns all rows from the right table that match the left table. If the specified column(s) used for matching are unique, the result will be identical to an inner join <code>ij</code>. However, in cases where the right table has multiple rows with the same matching criteria, the result will include all these rows, making it more expansive than an inner join. Unlike <code>ij</code>, every matching record from the right table is included in the output. Let&#x27;s illustrate this with an example.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="syntax-4">Syntax<a href="#syntax-4" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ej[column(List);table1;table2]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where</p>
<ul>
<li><strong>column(List)</strong> is a column name or list of column names used to match common records.</li>
<li><strong>table1</strong> can be a table or keyed table</li>
<li><strong>table2</strong> can be a table or keyed table</li>
</ul>
<p>In this example, we will make a slight modification to our <code>quote</code> table. The updated tables are defined as follows:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show trade:([] sym:`AAPL`MSFT`GOOG`IBM; price:123.0 45.9 234.4 20.0; qty: 100 45 200 300)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM  20    300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)show quote:([] sym:`AAPL`AAPL`GOOG`GOOG; bid:123.1 46.0 245.9 21.9; ask:124.8 46.1 246.2 23.9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 21.9  23.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see, the <code>quote</code> table now includes multiple records for Google and Apple, while no other stocks are represented.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)ej[`sym;trade;quote]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL 123   100 46    46.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 234.4 200 21.9  23.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(1!trade)ij 1!quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| ---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL| 123   100 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG| 234.4 200 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(1!trade) lj 1!quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | price qty bid   ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| ---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAPL| 123   100 123.1 124.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT| 45.9  45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG| 234.4 200 245.9 246.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBM | 20    300</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Equi Join" src="/assets/images/equiJoinTables-1a5e72b184c1c0dfdcc3899fb110f2af.png" width="1832" height="1044" class="img_ev3q"></p>
<p>From the example above, you can observe that the equi join matched the <code>trade</code> and <code>quote</code> tables using the <code>sym</code> column, including all matching records from the right argument, the <code>quote</code> table. In contrast, the inner join and left join only matched the first record from the right table to the left table, adhering to the specific logic of inner and left joins, respectively.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="as-of-joins">As-Of-Joins<a href="#as-of-joins" class="hash-link" aria-label="Direct link to As-Of-Joins" title="Direct link to As-Of-Joins">​</a></h2>
<p>Equi or Exact Joins are invaluable when matching datasets with a common key or ID column, such as enhancing a dataset with reference data. However, when working with big data and time series, joining solely on a key column often falls short. In many cases, you need to analyze the state of the world at a specific moment in time or within a certain time range. This is where KDB/Q&#x27;s native as-of joins, such as the <strong>as-of join <code>aj</code></strong> and <strong>window join <code>wj</code></strong>, prove extremely useful.</p>
<p>These joins enable you to recreate the state of the world at a particular point or over a specified time range. A common use case is analyzing the quote just before a trade occurred to assist compliance officers or regulators in understanding the events and verifying if the best bid and ask prices were executed. Another example is calculating the average trade price over a specific time interval before a trade, which can be done using the window join to self-join the trades data.</p>
<p>We’ll dive deeper into as-of and window joins, along with practical examples, in the following section.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="as-of-join-aj">As-of Join <code>aj</code><a href="#as-of-join-aj" class="hash-link" aria-label="Direct link to as-of-join-aj" title="Direct link to as-of-join-aj">​</a></h3>
<p>The <strong>asof join <code>aj</code></strong> is a powerful tool for joining tables based on time (or any other ordered <strong>nummerical</strong> value) columns, retrieving the most recent value in one table as of a given value in another table. The basic as-of join is implemented using the triadic function <code>aj</code>. It performs joins along common columns, selecting the most recent matching values. The syntax for <code>aj</code> is:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="syntax-5">Syntax<a href="#syntax-5" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aj[`c1...`cn; t1; t2]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where</p>
<ul>
<li><strong><code> `c1...`cn</code></strong> is a list of column names (symbols) shared by <code>t1</code> and <code>t2</code>, the tables to be joined</li>
<li>The join columns do not need to be keys, although having them as keys can improve performance.</li>
<li>All columns from both tables are included in the resulting table.</li>
</ul>
<p>The logic of <code>aj</code> works as follows:</p>
<ol>
<li>Matches on all specified columns, except the last, are determined using equality.</li>
<li>For the last column (e.g., time), the match identifies the greatest value in <code>t2</code> that is less than or equal to the corresponding value in <code>t1</code></li>
</ol>
<p>When the last column represents temporal values, the join effectively finds the value in <code>t2</code> that was valid &quot;as of&quot; the time specified in <code>t1</code>. This ensures efficient and meaningful joins, especially when dealing with time-ordered data.</p>
<p>Let’s explore this with an example. In order to do so, we need to modify our trade and quote tables slightly by adding a time column.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show trades:([] time:10:01:01 10:01:03 10:01:04;sym:`msft`ibm`ge;qty:100 200 150)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:03 ibm  200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:04 ge   150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)show quotes:([] time:10:01:00 10:01:01 10:01:01 10:01:02 10:01:03 10:01:05;sym:`ibm`msft`msft`ibm`msft`ibm;px:100 99 101 98 102 97)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:00 ibm  100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:02 ibm  98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:03 msft 102</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:05 ibm  97</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)aj[`sym`time;trades;quotes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 100 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:03 ibm  200 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:04 ge   150</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At first glance, the as-of join might seem complex, but it becomes much clearer when you work through an example step by step. Let’s do exactly that with the example above:</p>
<ol>
<li>We start with the first record in the <code>trades</code> table: We look for a <code>quotes</code> records matching <code>msft</code> as of the trade time <code>10:01:01</code>. There are two such records where the time in <code>t2</code> is less than or equal than the time in <code>t1</code>, both stamped <code>10:01:01</code>. The last one has a price of <code>101</code>, which is included in the result. Remember: the match identifies the greatest value in <code>t2</code> that is less than or equal to the corresponding <code>time</code> value in <code>t1</code>. Therefore, everything that occured after the timestamp in <code>t1</code> for this particular record is ignored. E.g <code>msft</code> at <code>10:01:03</code></li>
<li>Then, move to the second record in the <code>trades</code> table: For <code>ibm</code> as of <code>10:01:03</code>, the last matching quote record is stamped <code>10:01:02</code> with a price of <code>98</code>.</li>
<li>For the final record in our <code>trades</code> table: The symbol <code>ge</code> at <code>10:01:04</code>, there are no matching quote records.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Asof Join" src="/assets/images/asofJoinTables-93a87fe96603270bf7cc4b4d7bd94cc8.png" width="3276" height="1258" class="img_ev3q"></p>
<p>By walking through the process systematically, you can see how the as-of join matches and retrieves the most relevant records. There are some key observations to note. First, the last column specified in the column names parameter does not have to be named <code>time</code>; it can have any name, as long as the column exists in both tables. Furthermore, this column doesn’t need to be of a temporal data type - the type can be any numerical value. This flexibility comes from the fact that temporal data types in KDB/Q are internally represented as numerical values, storing a float that reflects the fractional day count from midnight on January 1, 2000.</p>
<p>We can quickly validate these points by making adjustments to our trades and quotes tables.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show tradesNew:([] whatever:1 3 4;sym:`msft`ibm`ge;qty:100 200 150)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">whatever sym  qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1        msft 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3        ibm  200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4        ge   150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)show quotesNew:([] whatever:0 1 1 2;sym:`ibm`msft`msft`ibm;px:100 99 101 98)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">whatever sym  px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0        ibm  100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1        msft 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1        msft 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2        ibm  98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)aj[`sym`whatever;tradesNew;quotesNew]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">whatever sym  qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1        msft 100 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3        ibm  200 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4        ge   150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)aj[`sym`time;trades;quotes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 100 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:03 ibm  200 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:04 ge   150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)aj[`sym`whatever;update whatever:`int$time from trades;update whatever:`int$time from quotes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  qty whatever px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 100 36061    101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:02 ibm  200 36063    98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:04 ge   150 36064</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The result of an asof join <code>aj</code> includes all columns from the right table except those used for matching. The columns used in the exact match remain the same between the two tables, but the temporal column (or more generally, the last column) will differ. In an asof join <code>aj</code>, the value from the left table takes precedence. If you want the value from the right table instead - such as the timestamp of the matching quote rather than the trade&#x27;s timestamp - you can use <code>aj0</code>, which has the exact same syntax as <code>aj</code> but returns the time from the right table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trades</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  qty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:03 ibm  200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:04 ge   150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)quotes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:00 ibm  100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:02 ibm  98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)aj[`sym`time;trades;quotes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 100 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:03 ibm  200 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:04 ge   150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)aj0[`sym`time;trades;quotes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 100 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:02 ibm  200 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:04 ge   150</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Everything else remains the same. The only difference between <code>aj</code> and <code>aj0</code> is that <code>aj0</code> returns the time column (or the last column) from the right table instead of the one from the left table.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="navigating-the-pitfalls-the-hidden-dangers-of-as-of-joins">Navigating the Pitfalls: The Hidden Dangers of As-Of Joins<a href="#navigating-the-pitfalls-the-hidden-dangers-of-as-of-joins" class="hash-link" aria-label="Direct link to Navigating the Pitfalls: The Hidden Dangers of As-Of Joins" title="Direct link to Navigating the Pitfalls: The Hidden Dangers of As-Of Joins">​</a></h4>
<p>Although the asof <code>aj</code> join doesn&#x27;t seem that complicated once you&#x27;re familiar with its syntax and logic, there&#x27;s a very important detail you must always remember. Both the asof <code>aj</code> and the window join <code>wj</code> use a binary search algorithm to locate the appropriate records for joining. For this to work correctly, the temporal column - or more generally, the last column specified - must be in ascending order within the partitions defined by the preceding columns.</p>
<p>This requirement is not enforced by KDB/Q, so no error is thrown if the temporal column isn&#x27;t sorted. Instead, the operation will produce incorrect results - essentially garbage. <strong>To emphasize</strong>: all columns except the last one specified in the join parameter are used to filter records for an exact match and narrow the rows. The binary search is then performed within this narrowed set, where the temporal (or last) column must be sorted.</p>
<p>For example, if the <code>sym</code> column is used for matching, the temporal column (e.g., <code>time</code>) must be sorted within each <code>sym</code> group for the join to work as intended.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="window-join-wj">Window Join <code>wj</code><a href="#window-join-wj" class="hash-link" aria-label="Direct link to window-join-wj" title="Direct link to window-join-wj">​</a></h3>
<p>Sometimes, focusing on a single point in time isn&#x27;t sufficient to answer our questions, and we may need to consider a time range or window instead of just a specific moment. This is where the window join proves invaluable. Contrary to popular belief, the window join is not a special case of the asof join; rather, the asof join is a specific instance of the more generalized window join.</p>
<p>While the asof join provides a snapshot of the current state at a specific moment in time, the window join aggregates values of specified columns within defined intervals, making it particularly useful for analyzing the relationship between trades and quotes in financial data. The core idea is to investigate how quotes behave in the vicinity of a trade.</p>
<p>For instance, to evaluate the execution quality of a trade, you may need to examine the range of bid and ask prices prevailing around the trade time. Unlike the asof join, which only looks back in time, the window join enables both backward - and forward-looking analysis. Additionally, while the asof join captures the state of the world at a particular time by selecting the last value before that moment, the window join facilitates more comprehensive analysis. It allows you to compute functions such as averages, medians, or any other summarizations over records within the specified time window.</p>
<p>The syntax for the window join is arguably the most complex, so let&#x27;s break it down step by step and illustrate it with an example.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="syntax-6">Syntax<a href="#syntax-6" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wj [w; c; t; (q; (f0;c0); (f1;c1))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wj1[w; c; t; (q; (f0;c0); (f1;c1))]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where</p>
<ul>
<li><code>t</code> and <code>q</code> are simple tables to be joined. The table <code>q</code> must be sorted by <code>sym</code> and <code>time</code>, with the parted <code>p</code> attribute on <code>sym</code>. Starting from <code>version 4.1t</code> (2023.08.04), if <code>t</code> is provided as a table name, it will be updated in place.</li>
<li><code>w</code> represents a pair of lists containing the start and end of the time intervals</li>
<li><code>c</code> specifies the common column names, such as <code>sym</code> and <code>time</code>, which must be of integral data types.</li>
<li><code>f0</code> and <code>f1</code> are aggregation functions applied to the values in <code>q</code> columns <code>c0</code> and <code>c1</code> over the defined intervals.</li>
</ul>
<p>For each record in <code>t</code>, the result includes additional columns <code>c0</code> and <code>c1</code>, which store the results of the aggregation functions applied to the matching intervals in <code>w</code>.</p>
<p>A typical use case might be:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wj[w;`sym`time;trade;(quote;(max;`ask);(min;`bid))]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>To view all the values within each window, use the identity function :: instead of aggregation functions.
E.g.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wj[w;c;t;(q;(::;c0);(::;c1))]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>Let’s go through an example to better understand how the window join works. Our example is inspired by the official documentation in <em><strong>Q for Mortals</strong></em>, which you can find <a href="https://code.kx.com/q4m3/9_Queries_q-sql/#999-window-join" target="_blank" rel="noopener noreferrer">here</a> For symplicity we will only consider trades and quotes for Apple.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show trades:([]sym:3#`aapl;time:09:30:01 09:30:04 09:30:08;price:100 103 101)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)show quotes::([] sym:8#`aapl;time:09:30:01+(til 5),7 8 9;ask:101 103 103 104 104 103 102 100;bid:98 99 102 103 103 100 100 99)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     ask bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 101 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:02 103 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:03 103 102</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 104 103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:05 104 103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 103 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:09 102 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:10 100 99</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>First, we create fixed-width time windows spanning 2 seconds before and 1 second after each trade time. (Note that the windows don&#x27;t have to be of uniform width.) To achieve this, we extract the <code>time</code> column from our trades table and use the each-right iterator to add -2 and 1 seconds to each time value, effectively subtracting 2 seconds and adding 1 second to each time value, creating a pair of lists representing the time intervals for each trade.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show w:-2 1+\:trades`time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">09:29:59 09:30:02 09:30:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">09:30:02 09:30:05 09:30:09</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let’s examine the actual syntax of the window join and break it down step by step.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wj[w;`sym`time;trades;(quotes;(::;`ask);(::;`bid))]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first parameter in our window join, <code>w</code> is the list of time windows we created earlier. This is followed by a list of column names, <code>sym</code> and <code>time</code> in this case, which specify the common columns between the tables. Next, we have the <code>trades</code> table, which serves as the left table in the join. The final parameter is a list containing the <code>quotes</code> table and a pair of lists, each pairing an aggregate function with a column name.</p>
<p>To view all the values within each window, we used the identity function <code>::</code> instead of an aggregate function. This produces a result similar to grouping without applying any aggregation, which can be useful for visualizing the data included in each window.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)wj[w;`sym`time;trades;(quotes;(::;`ask);(::;`bid))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price ask             bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100   101 103         98 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103   103 103 104 104 99 102 103 103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101   104 103 102     103 100 100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Window Join" src="/assets/images/windowJoin-6ad9c30ed8bc51a0c78817bc891430d9.png" width="2474" height="867" class="img_ev3q"></p>
<p>The syntax for the <code>wj1</code> window join is identical to that of <code>wj</code>. The difference lies in how the time window interval is interpreted. In <code>wj</code>, the prevailing quote at the start of the window is included, reflecting the step-function nature of quotes. However, <code>wj1</code> considers only quotes that arrive on or after the window&#x27;s start.</p>
<p>If your analysis requires quotes starting precisely from the beginning of the interval, you should use <code>wj1</code>. For further details, refer to the official documentation, as <em><strong>Q for Mortals</strong></em>  is outdated in this regard. You can find the updated reference <a href="https://code.kx.com/q/ref/wj/#interval-behavior" target="_blank" rel="noopener noreferrer">here</a>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)wj1[w;`sym`time;trades;(quotes;(::;`ask);(::;`bid))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price ask             bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100   101 103         98 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103   103 103 104 104 99 102 103 103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101   103 102         100 100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Window Join wj1" src="/assets/images/windowJoin1-2d73702cd9bc43393de059ea9528d1ef.png" width="2447" height="862" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The key distinction between window join <code>wj</code> and <code>wj1</code> lies in how they handle interval behavior. Both, <code>wj</code> and <code>wj1</code> operate on <code>[]</code> intervals, meaning they consider quotes that are ≥ the beginning and ≤ the end of the interval. With <code>wj</code>, the prevailing quote at the start of the window is considered valid, as quotes are treated as a step function. This is evident in the first example, where the second window <code>window2</code> includes the prevailing bid and ask prices as valid. In contrast, this is not the case with the <code>wj1</code> join. For <code>wj1</code>, only quotes on or after the start of the window are considered. If your use case requires quotes to be included from the beginning of the interval, you should use <code>wj1</code></p></div></div>
<p>Additionally, you can perform various analyses on the selected columns within the time range of the window join. For instance, you can calculate averages, minimums, maximums, medians, or standard deviations.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)wj[w;`sym`time;trades;(quotes;(min;`ask);(min;`bid))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price ask bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100   101 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103   103 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101   102 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)wj[w;`sym`time;trades;(quotes;(max;`ask);(max;`bid))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price ask bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100   103 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103   104 103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101   104 103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)wj[w;`sym`time;trades;(quotes;(med;`ask);(med;`bid))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price ask   bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100   102   98.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103   103.5 102.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101   103   100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)wj[w;`sym`time;trades;(quotes;(sdev;`ask);(sdev;`bid))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price ask       bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100   1.414214  0.7071068</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103   0.5773503 1.892969</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101   1         1.732051</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)wj[w;`sym`time;trades;(quotes;(avg;`ask);(avg;`bid))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price ask   bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100   102   98.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103   103.5 101.75</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101   103   101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)wj1[w;`sym`time;trades;(quotes;(avg;`ask);(avg;`bid))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     price ask   bid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:01 100   102   98.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:04 103   103.5 101.75</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl 09:30:08 101   102.5 100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Trade and Quote table - Window Join wj wj1 Comparison" src="/assets/images/windowJoinComparison-674ccff860eef18c1be70d59f3cdbe71.png" width="2456" height="874" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="window-joins-mind-the-edge-before-you-lean-too-far">Window Joins: Mind the Edge Before You Lean Too Far<a href="#window-joins-mind-the-edge-before-you-lean-too-far" class="hash-link" aria-label="Direct link to Window Joins: Mind the Edge Before You Lean Too Far" title="Direct link to Window Joins: Mind the Edge Before You Lean Too Far">​</a></h4>
<p>When performing a window join, several critical constraints must be adhered to. First, similar to the asof join, the data must be sorted - first by the key identifier used for the exact match (e.g., <code>sym</code> in this case) and then by time within each identifier partition. Additionally, the parted attribute <code>p</code> must be applied to the identifier column. Unlike other joins, which may tolerate unpartitioned data or function correctly with the grouped <code>g</code> attribute, the window join strictly requires the parted attribute.</p>
<p>While the query will execute without errors even if these conditions are not met, the resulting output will be meaningless. This requirement also makes the window join unsuitable for real-time data, such as that in the Real-Time Database (RDB). Instead, it is designed for use with historical data stored in the Historical Database (HDB), where the parted attribute has been correctly applied.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="as-of-asof">As of <code>asof</code><a href="#as-of-asof" class="hash-link" aria-label="Direct link to as-of-asof" title="Direct link to as-of-asof">​</a></h3>
<p>The <code>asof</code> operator is a simplified version of the <code>asof join aj</code> enabling you to perform the same type of match as <code>aj</code> but between a table and a single record. It returns the remaining columns from the matched row in the table.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="syntax-7">Syntax<a href="#syntax-7" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">t1 asof t2     asof[t1;t2]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where</p>
<ul>
<li><code>t1</code> is a table</li>
<li><code>t2</code> is a table or dictionary</li>
<li>the last key or column of <code>t2</code> corresponds to a time column in <code>t1</code></li>
</ul>
<p>and returns the values from the last rows matching the rest of the keys and time ≤ the time in <code>t2</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)show trades:([] time:10:01:01 10:01:03 10:01:04; sym:`msft`ibm`ge; qty:100 200 150; px:45 160 55)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time     sym  qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:01 msft 100 45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:03 ibm  200 160</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:01:04 ge   150 55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trades asof `sym`time!(`ibm;10:01:03)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qty| 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">px | 160</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>As shown in the example above, the result does not include the columns from the original dictionary used for the match. To include these columns in the result, save them into a variable and prepend them to the output of the <code>asof</code> operation.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)d,trades asof d:`sym`time!(`ibm;10:01:03)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | `ibm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time| 10:01:03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qty | 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">px  | 160</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>You can also use a list of conforming dictionary records – i.e., a table – to perform <code>asof</code> matches against each reacord.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trades asof ([] sym:`msft`ibm; time:10:01:01 10:01:03)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100 45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">200 160</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Prepending the original <code>asof</code> records to the result:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)t,&#x27;trades asof t:([] sym:`msft`ibm; time:10:01:01 10:01:03)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  time     qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msft 10:01:01 100 45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ibm  10:01:03 200 160</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance-considerations">Performance considerations<a href="#performance-considerations" class="hash-link" aria-label="Direct link to Performance considerations" title="Direct link to Performance considerations">​</a></h2>
<p>In the next section, we will explore various performance optimizations for different types of joins, starting with the obvious and basic strategies before progressing to more advanced techniques.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="join-smart-only-the-data-you-need">Join Smart: Only the Data You Need<a href="#join-smart-only-the-data-you-need" class="hash-link" aria-label="Direct link to Join Smart: Only the Data You Need" title="Direct link to Join Smart: Only the Data You Need">​</a></h4>
<p>When performing joins like left join, inner join, or union join, all non-common columns from the right table are added to the left table if their key columns match. For large datasets, this means a significant amount of data is appended, which can impact performance due to the overhead of copying data. To optimize performance, it’s better to select only the columns you need for the join. The following examples demonstrate this approach.</p>
<p><strong>Non Optimal Query</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table1 lj table2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Optimised Query</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lj[select sym,time,exchange,price from trades where sym in `AAPL`MSFT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1!select sym,description from referenceData where sym in `AAPL`MSFT]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="boost-your-joins-with-kdbqs-secret-weapon-attributes">Boost Your Joins with KDB/Q&#x27;s Secret Weapon: Attributes<a href="#boost-your-joins-with-kdbqs-secret-weapon-attributes" class="hash-link" aria-label="Direct link to Boost Your Joins with KDB/Q&#x27;s Secret Weapon: Attributes" title="Direct link to Boost Your Joins with KDB/Q&#x27;s Secret Weapon: Attributes">​</a></h4>
<p>A key performance enhancement for running queries in KDB/Q lies in its powerful feature: attributes. Attributes are metadata you can apply to lists that follow a specified order, significantly improving query performance - including joins. Joining datasets requires identifying matching keys, an operation that becomes increasingly time-consuming as datasets grow larger.</p>
<p>The efficiency of a join operation depends on how quickly KDB/Q can locate all matching records for the key column(s) in both tables. If no attributes are applied to the key column(s), the system defaults to a sequential, linear search. However, by applying an attribute, the linear search is replaced with a faster binary search, drastically improving join performance and delivering results much quicker.</p>
<p>Instead of performing a join without attributes, such as</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aj[`sym`time;trades;quotes]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>you should use</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aj[`sym`time;trades;update `g#sym from quotes]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>applying the grouped <code>g</code> attribute to the key column.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="optimising-asof-join-performance-tips-and-tricks">Optimising Asof Join Performance: Tips and Tricks<a href="#optimising-asof-join-performance-tips-and-tricks" class="hash-link" aria-label="Direct link to Optimising Asof Join Performance: Tips and Tricks" title="Direct link to Optimising Asof Join Performance: Tips and Tricks">​</a></h4>
<p>First and foremost, ensure that the columns specified as the first argument of the asof join are in the correct order, such as <code>`sym`time</code>. Incorrect ordering can lead to significant performance degradation. Next, leverage attributes for performance optimization. For in-memory asof joins, apply the grouped <code>g</code> attribute to the key column of <code>table2</code> and sort the records by time within this grouped column. For on-disk data, ensure the parted <code>p</code> attribute is applied to the key column, with records sorted by time within each partition.</p>
<p>Additionally, when performing asof joins on disk-stored data, select only the columns needed for the join. KDB/Q uses memory mapping and loads columns into memory only when required. Reducing the number of columns involved in the join will greatly enhance query performance by limiting memory usage to essential data.</p>
<p>Lastly, only select the virtual partition column if it is explicitly needed, as it is generated on demand, which can be time-consuming for large partitions.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="dont-lose-your-attributes">Don&#x27;t Lose Your Attributes<a href="#dont-lose-your-attributes" class="hash-link" aria-label="Direct link to Don&#x27;t Lose Your Attributes" title="Direct link to Don&#x27;t Lose Your Attributes">​</a></h5>
<p>When saving data to disk, we typically partition by date and apply the parted attribute to the <code>sym</code> column within each partition. As we’ve learned, attributes can greatly enhance query performance, making their use a best practice. But what happens when we load data from disk into memory and query a time range that spans multiple days? Will the parted attribute persist if we query several days worth of data? Or will it be lost?</p>
<p>For the purpose of this exercise, I have created a small, simple Historical Database (HDB), containing a trades and quotes table spanning a few days. The structure is as below</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">alexanderunterrainer@Mac:~/repos/test|⇒  ls -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x@ 4 alexanderunterrainer  staff  128 13 Dec 17:06 2024.12.09</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x@ 4 alexanderunterrainer  staff  128 13 Dec 17:06 2024.12.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x@ 4 alexanderunterrainer  staff  128 13 Dec 17:06 2024.12.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x@ 4 alexanderunterrainer  staff  128 13 Dec 17:06 2024.12.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x@ 4 alexanderunterrainer  staff  128 13 Dec 17:06 2024.12.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--@ 1 alexanderunterrainer  staff   23 13 Dec 17:02 sym</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can now start a KDB/Q process and load our data</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">alexanderunterrainer@Mac:~/repos/test|⇒  qq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KDB+ 4.0 2023.01.20 Copyright (C) 1993-2023 Kx Systems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m64/ 8(24)core 24576MB alexanderunterrainer mac 192.168.1.142 EXPIRE 2025.02.21 KDB PLUS TRIAL #5018719</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)\l .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)tables[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`s#`quotes`trades</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)t!{count value x}each t:tables[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quotes| 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trades| 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)select count i by date from trades</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date      | x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------| --</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.11| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.12| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.13| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)select count i by date from quotes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date      | x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------| --</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.11| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.12| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.13| 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)meta trades</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c   | t f a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date| d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | s   p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time| v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qty | j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">px  | f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)meta quotes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c   | t f a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date| d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | s   p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time| v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bid | f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ask | f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Our Historical Database (HDB) includes two tables, <code>trades</code> and <code>quotes</code>, each containing a total of 50 records, distributed as 10 records per day over a span of 5 days. By examining the metadata of these tables using the <code>meta</code> operator, we can confirm that the parted attribute <code>p</code> is applied to the sym column in both tables. When we query either table for a specific day and verify the metadata, we observe that the parted attribute remains intact.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)meta select from trades where date=2024.12.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c   | t f a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date| d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | s   p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time| v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qty | j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">px  | f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)meta select from quotes where date=2024.12.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c   | t f a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date| d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | s   p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time| v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bid | f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ask | f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Interestingly (and perhaps unexpectedly for some), querying the tables for a date range results in the parted attribute being removed.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)meta select from trades where date within 2024.12.10 2024.12.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c   | t f a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date| d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time| v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qty | j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">px  | f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)meta select from quotes where date within 2024.12.10 2024.12.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c   | t f a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date| d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time| v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bid | f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ask | f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But should this really come as a surprise? Not quite. Examining the data, we notice that querying a range of dates returns the results ordered by date, not by the <code>sym</code> This behavior makes perfect sense, as the Historical Database (HDB) is primarily partitioned by date, with the <code>sym</code> column partitioned only within each individual date. When querying a date range, the data is retrieved exactly as it is stored on disk, preserving this structure.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)select from trades where date within (2024.12.10;2024.12.13),i&lt;5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date       sym  time     qty px</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 aapl 02:15:30 11  28.2223</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 aapl 02:27:56 57  18.70281</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 aapl 18:20:20 74  44.18975</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 goog 11:20:03 28  44.6898</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 goog 21:02:21 54  79.32503</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.11 aapl 15:19:46 61  14.29403</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.11 aapl 16:26:35 59  49.53894</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.11 aapl 18:11:13 16  65.76692</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.11 goog 02:15:01 52  56.78577</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.11 goog 15:08:29 3   97.55778</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.12 aapl 00:18:37 52  27.85781</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.12 aapl 02:46:34 38  30.64804</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.12 aapl 14:04:50 57  72.42412</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.12 aapl 15:12:09 50  98.86591</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.12 goog 11:36:19 79  78.44527</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.13 aapl 02:06:01 43  68.67425</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.13 aapl 17:37:16 9   68.45319</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.13 goog 15:33:46 13  16.47619</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.13 goog 16:28:17 79  92.76588</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.13 goog 21:26:55 64  71.08719</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Is losing attributes really that problematic? Unfortunately, yes, it is. We&#x27;ve seen how attributes significantly enhance query performance, especially with large datasets. Conversely, running queries without attributes applied means the operations become less efficient, leading to a noticeable performance hit.</p>
<p>Fortunately, there&#x27;s an easy solution to this problem. As we&#x27;ve seen in an earlier example, querying data for a single day preserves the parted attribute since the data is parted by <code>sym</code> within each day. By leveraging this behavior and using iterators, we can create a lambda function (an anonymous function) to iterate over a list of dates, querying one day at a time. This ensures that the parted attribute remains intact. The result of such a query is a list of tables, which can then be combined into a single table using the <code>raze</code> operator.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Using a lambda to query each date art a time returns a list of tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q){ aj[`sym`time;select from trades where date=x;select from quotes where date=x]} each 2024.12.09 2024.12.10 2024.12.11 2024.12.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`date`sym`time`qty`px`bid`ask!(2024.12.09 2024.12.09 2024.12.09 2024.12.09 2..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`date`sym`time`qty`px`bid`ask!(2024.12.10 2024.12.10 2024.12.10 2024.12.10 2..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`date`sym`time`qty`px`bid`ask!(2024.12.11 2024.12.11 2024.12.11 2024.12.11 2..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`date`sym`time`qty`px`bid`ask!(2024.12.12 2024.12.12 2024.12.12 2024.12.12 2..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// You can observe that each individual element is in fact a table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)first { aj[`sym`time;select from trades where date=x;select from quotes where date=x]} each 2024.12.09 2024.12.10 2024.12.11 2024.12.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date       sym  time     qty px       bid      ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 aapl 12:28:12 12  34.93533 38.39793 38.78682</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 aapl 20:12:34 17  63.35864 76.04912 76.86455</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 01:08:14 89  95.54843</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 04:47:02 26  21.7258  59.37708 59.55671</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 04:48:15 27  22.57321 59.37708 59.55671</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 05:37:39 44  88.60093 97.53188 97.55164</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 07:30:19 57  71.99879 97.53188 97.55164</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 10:11:22 37  66.08195 97.53188 97.55164</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 10:15:57 68  97.89487 97.53188 97.55164</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 11:35:23 58  91.17688 24.69932 24.74801</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Applying raze to this list will combine all elements into a single table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)raze{ aj[`sym`time;select from trades where date=x;select from quotes where date=x]} each 2024.12.09 2024.12.10 2024.12.11 2024.12.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date       sym  time     qty px       bid      ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 aapl 12:28:12 12  34.93533 38.39793 38.78682</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 aapl 20:12:34 17  63.35864 76.04912 76.86455</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 01:08:14 89  95.54843</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 04:47:02 26  21.7258  59.37708 59.55671</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 04:48:15 27  22.57321 59.37708 59.55671</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 05:37:39 44  88.60093 97.53188 97.55164</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 07:30:19 57  71.99879 97.53188 97.55164</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 10:11:22 37  66.08195 97.53188 97.55164</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 10:15:57 68  97.89487 97.53188 97.55164</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.09 goog 11:35:23 58  91.17688 24.69932 24.74801</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 aapl 02:15:30 11  28.2223</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 aapl 02:27:56 57  18.70281</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 aapl 18:20:20 74  44.18975 34.64666 34.70822</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 goog 11:20:03 28  44.6898  86.7695  87.26624</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 goog 21:02:21 54  79.32503 1.318344 2.207291</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 msft 02:39:17 73  35.95293</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 msft 09:13:50 39  48.09078 23.71334 24.2586</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 msft 13:25:26 39  13.16095 23.71334 24.2586</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 msft 14:39:50 28  63.33324 23.71334 24.2586</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024.12.10 msft 17:22:33 11  69.90336 23.71334 24.2586</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This technique will be a valuable addition to your KDB/Q toolkit the next time you need to query a large dataset spanning multiple dates.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tips-and-tricks">Tips and Tricks<a href="#tips-and-tricks" class="hash-link" aria-label="Direct link to Tips and Tricks" title="Direct link to Tips and Tricks">​</a></h2>
<p>Sometimes, joining multiple datasets is necessary to achieve the desired result. However, in longer queries, this can lead to messy and unreadable code, making it harder to maintain and less accessible for your fellow KDB/Q colleagues.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)((select open:first px,low:min px, high:max px, close:last px by sym from trades) lj select by sym from quotes) lj 1!reference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | open     low      high     close    date       time     bid      ask      description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| --------------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl| 34.93533 14.29403 98.86591 68.45319 2024.12.13 18:12:53 91.26417 91.30803 &quot;Apple Inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">goog| 95.54843 16.47619 97.89487 21.4076  2024.12.13 12:28:42 46.10987 46.54357 &quot;Google Inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msft| 35.95293 1.280633 92.56132 56.10808 2024.12.13 10:25:30 80.95108 81.65008 &quot;Microsoft&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The query above is already somewhat difficult to read, and it’s not even a particularly complex one. In practice, you’re likely to encounter much more complicated queries. Fortunately, there’s a simple way to make such queries more readable. By leveraging an iterator, we can achieve the same result while significantly improving readability. By leveraging an iterator, we can achieve the same result while significantly improving clarity. Specifically, using the <code>over</code> iterator in combination with the desired join operation allows us to join datasets in a much cleaner and more understandable manner.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)(lj/)(select open:first px,low:min px, high:max px, close:last px by sym from trades;select by sym from quotes;1!reference)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym | open     low      high     close    date       time     bid      ask      description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----| --------------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aapl| 34.93533 14.29403 98.86591 68.45319 2024.12.13 18:12:53 91.26417 91.30803 &quot;Apple Inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">goog| 95.54843 16.47619 97.89487 21.4076  2024.12.13 12:28:42 46.10987 46.54357 &quot;Google Inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msft| 35.95293 1.280633 92.56132 56.10808 2024.12.13 10:25:30 80.95108 81.65008 &quot;Microsoft&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Doesn&#x27;t this already look much clearer? In a KDB/Q script, you can take it a step further by spreading the query across multiple lines, making it even easier to read and understand. You can even add some comments if you want.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">result:(lj/)(select open:first px,low:min px, high:max px, close:last px by sym from trades;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	    select by sym from quotes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	    1!reference);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Last but not least, we verify that both our queries actually return the same result.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)((lj/)(select open:first px,low:min px, high:max px, close:last px by sym from trades;select by sym from quotes;1!reference))~((select open:first px,low:min px, high:max px, close:last px by sym from trades) lj select by sym from quotes) lj 1!reference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>That&#x27;s all Folks! I hope you found this blog post helpful. See you next time. Don&#x27;t forget to subscribe to my newsletter for updates straight to your inbox. Subscribe <a href="https://defconq.substack.com" target="_blank" rel="noopener noreferrer">now</a></strong></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/concepts/functionalSelect"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Embracing Terseness: Functional Forms and Parse Trees</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/concepts/iterators"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Iterators: Navigating Vectors Without the Need for Loops</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-we-use-joins" class="table-of-contents__link toc-highlight">Why we use Joins</a></li><li><a href="#basic-joins" class="table-of-contents__link toc-highlight">Basic Joins</a><ul><li><a href="#merge-tables-effortlessly-joining-records-with-concatenate-" class="table-of-contents__link toc-highlight">Merge Tables Effortlessly: Joining Records with Concatenate <code>,</code></a></li><li><a href="#combining-columns-mastering-concatenate-and-each-both-joins" class="table-of-contents__link toc-highlight">Combining Columns: Mastering Concatenate and Each-Both Joins</a></li></ul></li><li><a href="#equi-or-exact-joins" class="table-of-contents__link toc-highlight">Equi (or Exact) Joins</a><ul><li><a href="#left-join-lj" class="table-of-contents__link toc-highlight">Left Join <code>lj</code></a><ul><li><a href="#syntax" class="table-of-contents__link toc-highlight">Syntax</a></li></ul></li><li><a href="#inner-join-ij" class="table-of-contents__link toc-highlight">Inner Join <code>ij</code></a><ul><li><a href="#syntax-1" class="table-of-contents__link toc-highlight">Syntax</a></li></ul></li><li><a href="#union-join-uj" class="table-of-contents__link toc-highlight">Union Join <code>uj</code></a><ul><li><a href="#syntax-2" class="table-of-contents__link toc-highlight">Syntax</a></li><li><a href="#union-join-for-unkeyed-table" class="table-of-contents__link toc-highlight">Union Join for unkeyed table</a></li><li><a href="#union-join-for-keyed-tables" class="table-of-contents__link toc-highlight">Union Join for keyed tables</a></li><li><a href="#the-danger-of-union-joins-handle-with-care" class="table-of-contents__link toc-highlight">The Danger of Union Joins: Handle with Care</a></li></ul></li><li><a href="#plus-join-pj" class="table-of-contents__link toc-highlight">Plus Join <code>pj</code></a><ul><li><a href="#syntax-3" class="table-of-contents__link toc-highlight">Syntax</a></li></ul></li><li><a href="#equi-join-ej" class="table-of-contents__link toc-highlight">Equi Join <code>ej</code></a></li><li><a href="#syntax-4" class="table-of-contents__link toc-highlight">Syntax</a></li></ul></li><li><a href="#as-of-joins" class="table-of-contents__link toc-highlight">As-Of-Joins</a><ul><li><a href="#as-of-join-aj" class="table-of-contents__link toc-highlight">As-of Join <code>aj</code></a><ul><li><a href="#syntax-5" class="table-of-contents__link toc-highlight">Syntax</a></li><li><a href="#navigating-the-pitfalls-the-hidden-dangers-of-as-of-joins" class="table-of-contents__link toc-highlight">Navigating the Pitfalls: The Hidden Dangers of As-Of Joins</a></li></ul></li><li><a href="#window-join-wj" class="table-of-contents__link toc-highlight">Window Join <code>wj</code></a><ul><li><a href="#syntax-6" class="table-of-contents__link toc-highlight">Syntax</a></li><li><a href="#window-joins-mind-the-edge-before-you-lean-too-far" class="table-of-contents__link toc-highlight">Window Joins: Mind the Edge Before You Lean Too Far</a></li></ul></li><li><a href="#as-of-asof" class="table-of-contents__link toc-highlight">As of <code>asof</code></a><ul><li><a href="#syntax-7" class="table-of-contents__link toc-highlight">Syntax</a></li></ul></li></ul></li><li><a href="#performance-considerations" class="table-of-contents__link toc-highlight">Performance considerations</a><ul><li><a href="#join-smart-only-the-data-you-need" class="table-of-contents__link toc-highlight">Join Smart: Only the Data You Need</a></li><li><a href="#boost-your-joins-with-kdbqs-secret-weapon-attributes" class="table-of-contents__link toc-highlight">Boost Your Joins with KDB/Q&#39;s Secret Weapon: Attributes</a></li><li><a href="#optimising-asof-join-performance-tips-and-tricks" class="table-of-contents__link toc-highlight">Optimising Asof Join Performance: Tips and Tricks</a><ul><li><a href="#dont-lose-your-attributes" class="table-of-contents__link toc-highlight">Don&#39;t Lose Your Attributes</a></li></ul></li></ul></li><li><a href="#tips-and-tricks" class="table-of-contents__link toc-highlight">Tips and Tricks</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Learn</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/company/defconq/" target="_blank" rel="noopener noreferrer" class="footer__link-item">DefconQ Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/alexanderunterrainer/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Alexander Unterrainer Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://defconq.myspreadshop.co.uk" target="_blank" rel="noopener noreferrer" class="footer__link-item">DefconQ Swag<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://www.youtube.com/@DefconQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube Channel<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://defconq.substack.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/DefconQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DefconQ Ltd. This website is maintained by Alexander Unterrainer. Disclaimer: All content shared on this website reflect solely his personal thoughts and opinions, and is not representative of any past, current, or future employers or affiliations.</div></div></div></footer></div>
</body>
</html>