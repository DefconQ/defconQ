<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tutorials/tick2" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">KDB Tick Explained: A Walkthrough [PART 2] | DefconQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://DefconQ.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://DefconQ.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://DefconQ.github.io/docs/tutorials/tick2"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="KDB Tick Explained: A Walkthrough [PART 2] | DefconQ"><meta data-rh="true" name="description" content="In my previous tutorial I walked you through all the helper functions you can find in the u.q file of a plain vanilla Tickerplant. I provided a comprehensive overview of the inner workings of these functions and how they interact with each other. It is now time to circle back and continue with our step-by-step examination of the main tick.q file and complete complete our understanding of the Tickerplant. If you&#x27;d like to revisit our previous discussions or if you&#x27;re new to this tutorial, you can access my earlier post here."><meta data-rh="true" property="og:description" content="In my previous tutorial I walked you through all the helper functions you can find in the u.q file of a plain vanilla Tickerplant. I provided a comprehensive overview of the inner workings of these functions and how they interact with each other. It is now time to circle back and continue with our step-by-step examination of the main tick.q file and complete complete our understanding of the Tickerplant. If you&#x27;d like to revisit our previous discussions or if you&#x27;re new to this tutorial, you can access my earlier post here."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://DefconQ.github.io/docs/tutorials/tick2"><link data-rh="true" rel="alternate" href="https://DefconQ.github.io/docs/tutorials/tick2" hreflang="en"><link data-rh="true" rel="alternate" href="https://DefconQ.github.io/docs/tutorials/tick2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://R6JV2N50EX-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DefconQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DefconQ Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E9ED09HNE3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-E9ED09HNE3",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="DefconQ" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5860f28a.css">
<script src="/assets/js/runtime~main.de196548.js" defer="defer"></script>
<script src="/assets/js/main.f241a4c7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#74e8a3" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">Stay up to date with the latest blogs posts - subscribe to my free Substack newsletter now <a href="https://defconq.substack.com">Free Substack Newsletter</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DefconQ Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="150" width="50"><img src="/img/logoLight.svg" alt="DefconQ Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="150" width="50"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Learn</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about/about">About</a><a class="navbar__item navbar__link" href="/testimonials/testimonials">Testimonials</a><a class="navbar__item navbar__link" href="/cv/cv">CV</a><a href="https://defconq.substack.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://defconq.myspreadshop.co.uk" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Swag<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/DefconQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdbq-study-roadmap">KDB/Q Study Roadmap</a><button aria-label="Expand sidebar category &#x27;KDB/Q Study Roadmap&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdbq-language">KDB/Q Language</a><button aria-label="Expand sidebar category &#x27;KDB/Q Language&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kdb-architecture">KDB Architecture</a><button aria-label="Expand sidebar category &#x27;KDB Architecture&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/important-concepts">Important Concepts</a><button aria-label="Expand sidebar category &#x27;Important Concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/tutorials">Tutorials</a><button aria-label="Collapse sidebar category &#x27;Tutorials&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tick">KDB Tick Explained: A Walkthrough [PART 1]</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/tutorials/tick2">KDB Tick Explained: A Walkthrough [PART 2]</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/productivity-tools">Productivity Tools</a><button aria-label="Expand sidebar category &#x27;Productivity Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/tutorials"><span itemprop="name">Tutorials</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">KDB Tick Explained: A Walkthrough [PART 2]</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>KDB Tick Explained: A Walkthrough [PART 2]</h1>
<p>In my previous tutorial I walked you through all the helper functions you can find in the <code>u.q</code> file of a plain vanilla Tickerplant. I provided a comprehensive overview of the inner workings of these functions and how they interact with each other. It is now time to circle back and continue with our step-by-step examination of the main <code>tick.q</code> file and complete complete our understanding of the Tickerplant. If you&#x27;d like to revisit our previous discussions or if you&#x27;re new to this tutorial, you can access my earlier post <a href="https://defconq.tech/docs/tutorials/tick" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tickq---continued"><code>tick.q</code> - Continued<a href="#tickq---continued" class="hash-link" aria-label="Direct link to tickq---continued" title="Direct link to tickq---continued">​</a></h2>
<p>The first function definition we encounter in the <code>tick.q</code> file is the one of <code>.u.ld</code>. For simplicity, we ignore the namespace change <code>\d .u</code> and will provide the full compound name of the functions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="uld"><code>.u.ld</code><a href="#uld" class="hash-link" aria-label="Direct link to uld" title="Direct link to uld">​</a></h2>
<p><code>.u.ld</code> is used to create a new Tickerplant Log file and establish a connection to it. It does this by initially verifying the existence of a Tickerplant Log file. If it doesn&#x27;t exist, a new one is created. Subsequently, it replays the Tickerplant Log file. If an existing Tickerplant Log file was found, the replay will restore the state of the world for all real-time subscribers. If a new file was created, the replay works on an empty file, having no impact. Following this, the function checks the success of the replay and opens a handle to the Tickerplant Log file, returning it. However, if the replay was unsuccessful, it will raise an error, resulting in the Tickerplant aborting. The function <code>.u.ld</code> is  used within <code>.u.tick</code> as well as within <code>.u.endofday</code>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you aren&#x27;t familiar with the Tickerplant Log file, I&#x27;ve given a brief explanation of what they are and their purpose in one of my earlier blog posts. Feel free to take a look at it for more details. <a href="https://defconq.tech/docs/architecture/plain#the-tp-log-file" target="_blank" rel="noopener noreferrer">The Tickerplant Log file</a></p></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (date) - the date for which we want to create a Tickerplant Log file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	the file handle to the Tickerplant Log file for the current day</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.ld:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[not type key .u.L::`$(-10_string .u.L),string x; .[.u.L;();:;()]];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.i::.u.j::-11!(-2;.u.L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[0&lt;=type .u.i;-2 (string L),&quot; is a corrupt log. Truncate to length &quot;,(string last .u.i),&quot;and restart&quot;;exit 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hopen .u.L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>First we need to check for the existence of the Tickerplant Log file. To accomplish this, we must construct the file name. We achieve this by taking the current Tickerplant Log file name stored in <code>.u.L</code> and converting it to a string. Then, we use the drop operator to eliminate the last 10 characters from the string. This demonstrates how operators can have various overloads. We&#x27;ve previously encountered the drop operator when removing the i-th element from a list, but here we&#x27;re using it to eliminate the first or last n-elements from a list.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)string `:sym2023.10.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;:sym2023.10.10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)-10_string `:sym2023.10.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;:sym&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, we convert the current date contained in variable <code>x</code> to a string and append it to the initial Tickerplant Log file name that we acquired earlier. Subsequently, we utilize the double-colon <code>::</code> operator to assign this new Tickerplant Log file name to the global variable <code>.u.L</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q).u.L::`$(-10_string .u.L),string x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)`$(-10_string `:sym2023.10.10),string 2023.10.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`:sym2023.10.11</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can now use the <code>key</code> operator to verify the existence of a file. While the <code>key</code> operator is normally used to retrieve the keys of a dictionary or keyed table, it can also be used to to confirm the existence of a variable, file, or directory. When <code>key</code> is applied to a variable name or a file path, it will return the variable name or file path if the variable or file exists; otherwise, it will return a null result. In the case of a directory, <code>key</code> will return the directory&#x27;s content if it exists, and nothing if it does not.</p>
<p>Let&#x27;s have a look at some examples. We are currently in the directory <code>testing</code> in the location <code>&quot;/Users/Alexander/repos/testing&quot;</code>. The directory contains a directory named <code>folder</code>, two tables <code>newTable</code> and <code>t</code>, a Tickerplant Log file called <code>sym2023.10.10</code>. The directory <code>folder</code> contains two more files <code>file1.txt</code> and <code>file2.txt</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)\pwd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;/Users/Alexander/repos/testing&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)\ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;folder&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;newTable&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;sym2023.10.10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,&quot;t&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;test.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)a:9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)key `a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)key `b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)key `:sym2023.10.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`:sym2023.10.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)key `:sym2023.10.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)key `:folder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`file1.txt`file2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)\ls folder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;file1.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;file2.txt&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the Tickerplant Log file doesn&#x27;t exist, and nothing is returned, <code>type</code> will return 0b. We use <code>not</code> to create the logical complement (negation) to return <code>1b</code> true if the file doesn&#x27;t exist. If the file exist and the file name is returned as symbol, <code>type</code> will return <code>-11h</code>, the type of a symbol atom, and <code>not</code> will thus return <code>0b</code>, false.</p>
<p>If the Tickerplant Log file doesn&#x27;t exist, and the if-statement evaluates to <code>true</code>, we use <code>.[.u.L;();:;()]</code> to create an empty Tickerplant Log file. You might be curious about what that expression does, and I&#x27;m going to share a neat trick. However, this should be used with caution. If you have some knowledge of the history of the Q programming language, you&#x27;re aware that Q is based on <a href="https://en.wikipedia.org/wiki/K_programming_language" target="_blank" rel="noopener noreferrer">K</a> (which is the foundation of KDB). In a Q console, you can access the K mode and inspect the underlying K code of a Q function. Let me demonstrate this for you.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.dpft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k){[d;p;f;t;s]if[` in f,c:!+r:`. . `\:t;&#x27;`domain];if[~f in c;&#x27;f];i:&lt;t f;r:+enxs[$;d;r;s];{[d;t;i;u;x]@[d;x;:;u t[x]i]}[d:par[d;p;t];r;i;]&#x27;[(::;`p#)f=c;c];@[d;`.d;:;f,c@&amp;~f=c];t}[;;;;`sym]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As evident, K code can be even less readable than Q and quite complex. Therefore, I strongly discourage attempting to write K code, especially since <a href="https://code.kx.com/q/basics/exposed-infrastructure/" target="_blank" rel="noopener noreferrer">KX advises against it</a>, as certain functionality might not be guaranteed. However, for simple functions and inspection purposes only, we can take a peek. Let&#x27;s explore how the <code>set</code> function is implemented.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k){$[@x;.[x;();:;y];-19!((,y),x)]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When we examine the middle part of the <code>set</code> function&#x27;s implementation, we notice that the code is similar of how we create an empty Tickerplant Log file. In essence, <code>.[.u.L;();:;()]</code>  accomplishes precisely that. If we replace <code>x</code> with <code>.u.L</code>, the file path to the Tickerplant Log file and <code>y</code> with the empty list <code>()</code>, we can observe that we are essentially generating an empty file.</p>
<p>The last thing that is left to do, is to replay the Tickerplant Log file, ensure that it&#x27;s not corrupted, open a connection handle to it and return it. We replay the Tickerplant Log file with <code>-11!</code> and the <code>-2</code> option. The <code>-2</code> option can be used to replay corrupted Tickerplant Log files. In case the Tickerplant Log file is corrupt, it will return the number of valid chunks in the Tickerplant Log file and the corresponding length of them. If the Tickerplant Log isn&#x27;t corrupt, it simply returns the number of valid chunks.</p>
<p>We proceed by replaying the Tickerplant Log file using the <code>-2</code> option and assigning the number of valid chunks to the global variables <code>.u.i</code> and <code>.u.j</code>. We then verify whether the Tickerplant Log file was corrupt or not. If the Tickerplant Log file was corrupt, using <code>-11!(-2;logFile)</code> will return the number of valid chunks and their respective sizes. Therefore, if we receive a list as the return value, the type will be positive (as a list always has a positive type value). In such a case, we throw an error indicating that the Tickerplant Log file needs to be truncated to the valid part and then abort. However, if the Tickerplant Log file wasn&#x27;t corrupt, we establish a connection to it using <code>hopen</code> and return this connection handle.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if[0&lt;=type .u.i;-2 (string L),&quot; is a corrupt log. Truncate to length &quot;,(string last .u.i),&quot;and restart&quot;;exit 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hopen .u.L</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="utick"><code>.u.tick</code><a href="#utick" class="hash-link" aria-label="Direct link to utick" title="Direct link to utick">​</a></h2>
<p><code>.u.tick</code> is the first function that is executed when the Tickerplant starts up. It proceeds by first invoking <code>.u.init</code> to set up <code>.u.t</code> and <code>.u.w</code>. Following that, it ensures that all tables defined in the schema file have <code>time and sym</code> as their first columns. If this condition isn&#x27;t met, the Tickerplant will raise an error and terminate. As a subsequent step, the <code>g</code> (grouped) attribute is applied to the sym column of each table, a measure taken for performance enhancement, resulting in quicker query times for user queries against the Real-time Database (RDB).</p>
<p>Afterwards, the function initializes <code>.u.d</code> with the current date and then concludes by executing <code>.u.ld</code> to create the Tickerplant Log file and establish a connection to the file.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (String) - The name of the schema file containing the definition of all tables, without file ending </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	y (String) - The path to the directory where the Tickerplant Log and HDB should be stored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.tick:{[x;y]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.init[];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[not min(`time`sym~2#key flip value@)each .u.t;&#x27;`timesym];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @[;`sym;`g#] each .u.t;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.d:.z.D;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[.u.l::count y;.u.L::`$&quot;:&quot;,y,&quot;/&quot;,x,10#&quot;.&quot;;.u.l::.u.ld[.u.d]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Even though <code>.u.tick</code> seems to be a long function with quite a lot going on, it&#x27;s actually relatively simple and straight forward. After the invocation of <code>.u.init</code>, which initializes <code>.u.t</code> and <code>.u.w</code>, it proceeds to validate that all tables defined in the schema file <code>sym.q</code> indeed feature <code>time</code> and <code>sym</code> columns as their initial columns. Let&#x27;s delve into the code to better understand how this is accomplished.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// verify that each table has a time and sym column as their first columns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if[not min (`time`sym~2#key flip value@)each .u.t;&#x27;`timesym]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let&#x27;s break this code further down: We first iterate over every table defined in <code>.u.t</code> using the <code>each</code> iterator. Within the parenthesis we then apply <code>value</code> in order to obtain the actual content of each table. Remember, <code>.u.t</code> only contains the symbol names of all tables. Using <code>value</code> we can actually retrieve the data stored in a variable. We then <code>flip</code> the table transforming the table into a dictionary.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>A table is essentially a flipped column dictionary and is stored as such. A column dictionary is a dictionary where each key in the dictionary has the same number of elements as their corresponding values, making the column dictionary rectangular. When we flip such a column dictionary, it transforms into a table. However, it&#x27;s important to note that KDB/Q doesn&#x27;t actually transpose the data; it merely marks the data as a table. By keeping the data stored as lists, KDB/Q minimizes memory usage and enhances performance by allowing vectorized operations. This also simplifies the process of storing the table to disk. If we examine the internal representation of a table, we can observe that it is, in fact, a flipped column dictionary.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)0N!flip `key1`key2`key3!(`valueA`valueB`valueC;`valueX`valueY`valueZ;`E`F`G)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`key1`key2`key3!(`valueA`valueB`valueC;`valueX`valueY`valueZ;`E`F`G)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key1   key2   key3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">valueA valueX E</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">valueB valueY F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">valueC valueZ G</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: The <code>+</code> operator is the K symbol for the Q <code>flip</code> operator</p></div></div>
<p>After transposing the table into a dictionary, we extract the keys using the <code>key</code> operator and select the first two of them. These two keys are then compared with the symbol list <code>time`sym</code> using the equality operator <code>~</code>. If there is a match, the result is <code>1b</code>. This process is repeated for all tables, resulting in a boolean vector that contains <code>1b</code> for tables with <code>time</code> and <code>sym</code> as their first columns and <code>0b</code> for tables that don&#x27;t meet this criteria. By applying the <code>min</code> function to this boolean vector, we can determine if all tables have <code>time</code> and <code>sym</code> as their first columns. If at least one table does not meet this condition, the <code>min</code> function will return <code>0b</code>, resulting in an error being thrown.</p>
<p>Next, we add the grouped g attribute to the sym column of each table. While the Tickerplant holds no or little data in memory, depending on the mode it runs in, this attribute will be passed to all real-time subscribers when they subscribe to a table. This will ultimately enhance the performance of user queries. Using the apply operator <code>@</code> we create a projection applying the grouped <code>g</code> attribute to the <code>sym</code> column. Finally we iterate over this projection for every table in the <code>.u.t</code> list.</p>
<p>Following that, we set the global variable <code>.u.d</code> to the current date, which is obtained using <code>.z.D</code>. Finally, we invoke <code>.u.ld</code> to generate a new Tickerplant Log file and establish a connection to it. In this process, we first validate whether the path to the TickerplantP Log file is defined. If it is, we create a temporary Tickerplant Log file name with the format <code>:pathToLogFile/filename.........</code> by appending ten dots <code>.</code> at the end of the file name. These dots serve as a temporary placeholder for the actual date, which will be appended to the Tickerplant Log filename during the execution of <code>.u.ld</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="uendofday"><code>.u.endofday</code><a href="#uendofday" class="hash-link" aria-label="Direct link to uendofday" title="Direct link to uendofday">​</a></h2>
<p>The <code>.u.endofday</code> function has three essential tasks:</p>
<ol>
<li>It initiates the execution of <code>.u.end</code>, which sends an asynchronous message to all real-time subscribers, thereby triggering their respective end-of-day functions.</li>
<li>It increments the Tickerplant&#x27;s current date, which is stored in the <code>.u.d</code> global variable, by one to account for the start of the new day.</li>
<li><code>.u.endofday</code> safely closes the connection to the current Tickerplant Log file, generates a new Tickerplant Log file for the new date, and establishes a connection to the newly created file.</li>
</ol>
<p>The <code>.u.endofday</code> function is called from within the <code>.u.ts</code> function, but only if it&#x27;s past midnight and we started a new day.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @params: None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return: None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.endofday:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.end[.u.d];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.d+:1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[.u.l;hclose .u.l;.u.l::0(`.u.ld;.u.d)];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="connection-handles">Connection handles<a href="#connection-handles" class="hash-link" aria-label="Direct link to Connection handles" title="Direct link to Connection handles">​</a></h3>
<p>The majority of the code in <code>.u.endofday</code> is straightforward. We start by calling <code>.u.end</code> with the current date and then increment the current date by one. The final step involves closing the handle to the current Tickerplant Log file (if it exists) and calling <code>.u.ld</code>, which creates a new Tickerplant Log file, opens a handle to it, and returns the handle. However, when calling <code>.u.ld</code>, we encounter a new concept. We invoke <code>.u.ld</code> using one of the three permanent <a href="https://code.kx.com/q/basics/handles/" target="_blank" rel="noopener noreferrer">system handles</a>: <code>0</code> is the system handle for the console, <code>1</code> is the system handle for <code>stdout</code>, and <code>2</code> is the system handle for <code>stderr</code>. Let&#x27;s explore how we can use the system handle <code>0</code> to execute a function.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// We first define a simple function</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)f:{x+x}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// We can now invoke the function by using the system handle 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)0(`f;2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="uts"><code>.u.ts</code><a href="#uts" class="hash-link" aria-label="Direct link to uts" title="Direct link to uts">​</a></h2>
<p><code>.u.ts</code> is responsible for verifying whether we have reached the end of the day and passed midnight. It is called from within <code>.z.ts</code>, which is the system function executed at regular intervals by a timer.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (date) - the current date (.z.D is passed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.ts:{[x]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[.u.d&lt;x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if[.u.d&lt;x-1; system &quot;t 0&quot;;&#x27;&quot;more than one day?&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .u.endofday[]];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>First, we check if <code>.u.d</code>, the current date for which the Tickerplant publishes data for, is less than the current date, represented by <code>.z.D</code> passed as <code>x</code>. If this condition is satisfied, we ensure that we&#x27;ve published data for only one day and not more than that by comparing <code>.u.d</code> to <code>x-1</code>, which is the date preceding the current one. If we indeed only published data for one day, we proceed to invoke <code>.u.endofday</code>. However, if the first condition is not met, meaning we haven&#x27;t reached the end of the day yet, we don&#x27;t take any action. In such a case, <code>.u.ts</code> will be invoked again at the next timer interval, and the checks will be performed again.</p>
<p>We&#x27;re now approaching the final section of the Tickerplant code, and we&#x27;ll encounter different behaviors depending on the mode in which the Tickerplant is running. The Tickerplant can operate in two modes: batch mode and tick mode. In batch mode, incoming data is accumulated for <code>N</code> milliseconds and then dispatched to all real-time subscribers. In contrast, tick mode delivers incoming data immediately, with minimal delay. Let&#x27;s delve deeper into these two modes:</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tickerplant-batch-mode-zts-and-uupd">Tickerplant Batch mode: <code>.z.ts</code> and <code>.u.upd</code><a href="#tickerplant-batch-mode-zts-and-uupd" class="hash-link" aria-label="Direct link to tickerplant-batch-mode-zts-and-uupd" title="Direct link to tickerplant-batch-mode-zts-and-uupd">​</a></h2>
<p>In batch mode, the timer interval for invoking the system function <code>.z.ts</code> is established at startup through the <code>-t</code> flag. In this mode, incoming data is temporarily stored in memory for <code>N</code> milliseconds, and then it is published when the timer triggers after this interval. We check whether a timer interval was set or not using an <code>if</code> statement and the system command <code>system &quot;t&quot;</code>. If this condition evaluates to <code>true</code>, we can determine that we are in batch mode and subsequently define <code>.z.ts</code> and <code>.u.upd</code> accordingly.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if[sytem &quot;t&quot;;	// If true, we run in the batch mode</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zts"><code>.z.ts</code><a href="#zts" class="hash-link" aria-label="Direct link to zts" title="Direct link to zts">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (timestamp) - .z.ts is invoked with the current timestamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.z.ts:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	.u.pub&#x27;[.u.t;value each .u.t];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @[`.;.u.t;@[;`sym;`g#]0#];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.i::.u.j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.ts[.z.D];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Initially, we publish all the updates that have been batched in memory to the real-time subscribers. This is accomplished by utilizing <code>.u.pub</code> along with <code>each-both</code> and a pair of list comprising table names and their corresponding data.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.u.pub&#x27;[.u.t;value each .u.t];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The expression <code>value each .u.t</code> generates a list of data, with each item representing the complete content of a specific table. Since <code>.u.t</code> holds the list of all available tables in our Tickerplant, the expression <code>[.u.t;value each .u.t]</code> forms a pair of lists that include all table names and their respective data. By using <code>each-both</code> along with the dyadic (two-parameter) function <code>.u.pub</code>, we can proceed to publish each table and its associated data to the real-time subscribers.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="each-both-">Each-both <code>&#x27;</code><a href="#each-both-" class="hash-link" aria-label="Direct link to each-both-" title="Direct link to each-both-">​</a></h3>
<p>Let&#x27;s have a closer look how <code>each-both</code> works:
According to <a href="https://code.kx.com/q4m3/6_Functions/#672-each" target="_blank" rel="noopener noreferrer">Q for Mortals</a> <em>The iterator Each <code>&#x27;</code> modifies a binary function (operator, keyword) to apply pairwise to corresponding list items.</em> The following examples should illustrate this behavior</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)0N!(`One`Two`Three),&#x27;(1;2;3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">((`One;1);(`Two;2);(`Three;3))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`One   1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`Two   2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`Three 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(&quot;abc&quot;; &quot;uv&quot;),&#x27;(&quot;de&quot;; &quot;xyz&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;abcde&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;uvxyz&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="namespacing">Namespacing<a href="#namespacing" class="hash-link" aria-label="Direct link to Namespacing" title="Direct link to Namespacing">​</a></h3>
<p>Next we use <a href="https://code.kx.com/q/ref/amend/" target="_blank" rel="noopener noreferrer">amend-at</a> to clear the contents of the tables in memory. We do this by leveraging the fact that in KDB/Q <a href="https://code.kx.com/q4m3/12_Workspace_Organization/" target="_blank" rel="noopener noreferrer">namespacing</a> is implemented with dictionaries. Consequently, we can directly access the root namespace, using our table names as keys, to retrieve or modify the content of the tables.</p>
<p>Assume we have defined the tables trade and quote, a variable a and a function f in our current KDB/Q process. <code>key `.</code> will then show the content of the root namespace</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)key `.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`quote`trade`a`f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)@[`.;`trade`qutote]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`time`sym`price`size!(`timespan$();`symbol$();`float$();`int$())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`time`sym`bid`ask`bsize`asize!(`timespan$();`symbol$();`float$();`float$();`..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{x+x}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amend">Amend<a href="#amend" class="hash-link" aria-label="Direct link to Amend" title="Direct link to Amend">​</a></h3>
<p>The <a href="https://code.kx.com/q/ref/amend/" target="_blank" rel="noopener noreferrer">amend-at</a> operator is highly practical for making modifications at specific indices within data structures. This functionality extends to both simple and nested indexes, depending on the operator being used. For instance, if we wish to replace particular characters in a string, we can employ the <code>amend @</code> operator along with the unary function <code>upper</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)@[&quot;alexander&quot;;0 2 4 6 8;upper]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;AlExAnDeR</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Combining this newly acquired knowledge with the knowledge about namespaces, we can create an expression that deletes the content of all tables and applies the grouped <code>g</code> attribute to the <code>sym</code> column of each table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@[`.;.u.t;@[;`sym;`g#]0#]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The expression above accesses the root namespace to fetch the content of all tables, removes all rows with <code>0#</code>, assigns the grouped <code>g</code> attribute to the <code>sym</code> column, and subsequently replaces each table with an empty one using their corresponding table names.</p>
<p>We proceed by setting the global variable <code>.u.j</code> to the value of <code>.u.i</code>, updating the number of messages stored in the Tickerplant Log file, and then calling <code>.u.ts</code> with the current date to check if midnight has been reached.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="uupd"><code>.u.upd</code><a href="#uupd" class="hash-link" aria-label="Direct link to uupd" title="Direct link to uupd">​</a></h3>
<p>We now define <code>.u.upd</code> for the case the timer is on startup and we run in batch mode. This function differs based on whether a timer was set or not. When a timer is configured, we publish all incoming messages within the <code>.z.ts</code> system function rather than within <code>.u.upd</code>.</p>
<p>The <code>.u.upd</code> function is triggered by the Feedhandler whenever it publishes data to the Tickerplant. It begins by verifying whether the first column of the incoming data is of type time. If it isn&#x27;t, the function prefixes the current timestamp to the incoming records. Subsequently, it inserts the data into the corresponding table specified within the Tickerplant, and it persists these newly arrived messages to the Tickerplant Log file. This log file serves the purpose of data playback, allowing for the recreation of the state of the world at any given point in time. Lastly, <code>.u.upd</code> increments the message counter <code>.u.j</code> by 1. It&#x27;s worth noting that <code>.u.j</code> maintains a record of the total number of messages received, encompassing those saved to the Tickerplant Log file and those held in memory.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When operating in batch mode, <code>.u.upd</code> refrains from immediately publishing messages to the real-time subscriber. Instead, this action occurs when triggered by a timer, invoked by <code>.z.ts</code>.</p></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (symbol) - the table name of the data published by the Feedhandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	y (data)   - the data to be published. This can be in form of a single record or a list of records</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.upd can handle both, single record updates as well as multiple/bulk records updates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Single record update:           .u.upd[`trade;(08:00:00;`GOOG;123.4;1000)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Multiple record update:         .u.upd[`trade;(08:30:00.000 08:30:00.001;`MSFT`AAPL;320.4 180.9;100 250)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.upd:{[t;x]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[not -16=type first first x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if[.u.d&lt;&quot;d&quot;$a:.z.P;.z.ts[]];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                a:&quot;n&quot;$a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x:$[0&gt;type first x;a,x;(enlist(count first x)#a),x];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t insert x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[.u.l;.u.l enlist (`upd;t;x);.u.j+:1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There&#x27;s a lot happening, but it&#x27;s fairly straightforward. Let&#x27;s break it down line by line and understand its functionality.</p>
<p>First, we verify the data type of the initial element in the incoming data to be of type 16 (timespan). As <code>.u.upd</code> manages updates for both single and multiple records simultaneously, the incoming data could be either a single row or multiple rows. If it&#x27;s a single row, the first element is an atom, while in the case of multiple rows, it&#x27;s a list. To ensure accurate type comparison, we need to apply the <code>first</code> function twice for obtaining a single element.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if[not -16=type first first x;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the <code>if-statement</code> evaluates to true, and the incoming data does not contain a time column, we examine if the Tickerplant&#x27;s date is earlier than the current date. We derive the present date from <code>.z.P</code>, capturing the current date and time and storing it in variable <code>a</code>. If it&#x27;s earlier, we trigger <code>.z.ts</code>, responsible for publishing the data in memory and calling the end-of-day function. If the Tickerplant date is not preceding the current date, indicating that we&#x27;re within the same day, we proceed by converting the present date and timespan into a timespan datatype to obtain the current timespan. This will serve as the Tickerplant time, indicating when the record was received.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if[.u.d&lt;&quot;d&quot;$a:.z.P;.z.ts[]];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a:&quot;n&quot;$a;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, we use the conditional operator <code>$</code> to assess whether the initial element of the received record is a single atom (negative types are atoms, and positive types are lists) or a list.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">x:$[0&gt;type first x;a,x;(enlist(count first x)#a),x];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Case 1</strong>: <code>0&gt;type first x</code> evaluates to <code>true</code> meaning we received a single record and the first element is an atom.
We prepend the current timespan to the single record we received, and this updated record is stored in the variable <code>x</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">a,x</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Case 2</strong>: We&#x27;ve received multiple records, which means we need to create a list of timespans with the same length as the number of records we&#x27;ve received.
First, we use <code>count</code> to identify the number of records received. Then, we create a list of timespans, consisting of <code>count first x</code> copies of the current timespan, <code>a</code>. To prepend this list to another list, we need to convert it into a singleton list (a list containing one element that is a list itself). Otherwise, the elements would be individually prepended rather than as one unified list.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)1 2 3,((4 5 6);(7 8 9))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 5 6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7 8 9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)enlist[1 2 3],((4 5 6);(7 8 9))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 5 6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7 8 9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Subsequently, we prepend the singleton list of timespans to the received records for the bulk update. Eventually, this updated set of records is reassigned to the variable <code>x</code>. These modified records are stored in the Tickerplant memory.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(enlist(count first x)#a),x</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Up to this point, we were contained within the initial <code>if</code> statement block. Now, we exit this statement. The first column of the records that are to be inserted now holds timespan values. These values could be the ones sent by the Feedhandler or, in cases where no timespan value was provided, they hold the timespan recorded by the Tickerplant.</p>
<p>We proceed to insert the received records into their respective tables in memory and store them in the Tickerplant Log file, assuming the file exists. After verifying that there is a handle to the Tickerplant Log file,we form a <a href="https://code.kx.com/q/wp/parse-trees/" target="_blank" rel="noopener noreferrer">parse tree</a>, including the function name for when the Tickerplant Log file is replayed as the first element, the table name for the stored data as the second element, and the data itself as the third element. This is only executed if a Tickerplant Log file is confirmed to exist.</p>
<p>We then use <code>enlist</code> and the Tickerplant Log file handle <code>.u.l</code> to append the records to the Tickerplant Log file. When a process replays the Tickerplant Log file,  defined as first element in the parse tree, the  will be invoked with <code>t</code> and  <code>x</code>. Finally we increase <code>.u.j</code> by 1.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">t insert x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if[.u.l;.u.l enlist (`upd;t;x);.u.j+:1];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>For the Tickerplant Log file replay to work, the dyadic function <code>upd</code> as well the schemas of all tables present in the Tickerplant Log file have to be defined first. A simple example of <code>upd</code> would be <code>insert</code> as defined in the Real-time Database (RDB). You can obtain the table schemas from the schema file <code>sym.q</code></p></div></div>
<p>This concludes the definition of <code>.u.upd</code>. Now that we&#x27;ve defined both .z.ts and .u.upd for the Tickerplant when running in batch mode based on a predefined timer, let&#x27;s shift our focus to the Tickerplant publishing every incoming record as it arrives.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tickerplant-tick-mode-zts-and-uupd">Tickerplant Tick mode: <code>.z.ts</code> and <code>.u.upd</code><a href="#tickerplant-tick-mode-zts-and-uupd" class="hash-link" aria-label="Direct link to tickerplant-tick-mode-zts-and-uupd" title="Direct link to tickerplant-tick-mode-zts-and-uupd">​</a></h2>
<p>As explained previously, if a Tickerplant runs in tick mode, it will publish the incoming data straight to all real-time subscribers. Additionally, a timer will verify every second whether we reached the end of the day or not.</p>
<p>We first verify that there was no timer set and if this is true, we know that we should publish all incoming data to all real-time subscriber as soon as it arrives. However, we still have to set a timer to invoke <code>.z.ts</code> and verifiy if we have reached the end of the day or not. We do this by using the <code>system</code> command, setting the interval to invoke the timer to 1 second.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if[not system &quot;t&quot;;system &quot;t 1000&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the next step, we define <code>.z.ts</code> for the case we run in tick mode.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zts-1"><code>.z.ts</code><a href="#zts-1" class="hash-link" aria-label="Direct link to zts-1" title="Direct link to zts-1">​</a></h3>
<p><code>.z.ts</code> is the system function that will be invoked on each timer interval defined with <code>system &quot;t N&quot;</code>, where <code>N</code> is the interval in milliseconds. Given that we publish all incoming data as soon as it arrives, the only purpose of <code>.z.ts</code> is to invoke <code>.u.ts</code> which verifies whether we are past midnight or not.</p>
<p><code>.z.ts</code> will be invoked every <code>N</code> milliseconds and the current timestamp is passed as only argument:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q).z.ts:{show x}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)\t 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)2023.11.11D16:40:30.981221000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.11D16:40:31.981221000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.11D16:40:32.981221000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.11D16:40:33.981221000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\t 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).z.p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.11D16:40:49.621176000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The definition of <code>.z.ts</code> is hence straightforward: we invoke <code>.u.ts</code> with the current date <code>.z.D</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (timestamp) - the current timestamp, .z.P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.z.ts:{.u.ts[.z.D]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="uupd-1"><code>.u.upd</code><a href="#uupd-1" class="hash-link" aria-label="Direct link to uupd-1" title="Direct link to uupd-1">​</a></h3>
<p>Given that there is no timer set on startup and our Tickerplant runs in tick mode, we will publish all incoming data as soon as it is received by the Tickerplant to achieve the lowest latency possible. The following actions are performed by <code>.u.upd</code>: It first calls <code>.u.ts</code> to verify whether we reached the end of day or not and the end of day actions need to be performed. The function then checks if the incoming records contain a timespan as first column; if not, it prefixes them with the current timespan. Subsequently, it publishes all records to real-time subscribers, writes them to the Tickerplant Log file, and increases the overall message count, <code>.u.i</code>, by one.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (symbol) - the table name of the data published by the Feedhandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	y (data)   - the data to be published. This can be in form of a single record or a list of records</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.upd:{[t;x]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.ts &quot;d&quot;$a:.z.P;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[not -16=type first first x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                a:&quot;n&quot;$a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x:$[0&gt;type first x;a,x;(enlist (count first x)#a),x]];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f:key flip value t;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .u.pub[t;$[0&gt;type first x;enlist f!x;flip f!x]];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if[.u.l;.u.l enlist (`upd;t;x);.u.i+:1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The initial section of the <code>.u.upd</code> definition mirrors the one we&#x27;ve previously discussed. First, the current timestamp is stored in the local variable <code>a</code>, which will serve as the Tickerplant timestamp. Then, this timestamp is converted to a date, and <code>.u.ts</code> is called to confirm whether we&#x27;ve moved past midnight and require the execution of the end-of-day function.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.u.ts &quot;d&quot;$a:.z.P;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Similar to the previous process, we check if the incoming data&#x27;s first column is a timestamp. If not, the current timestpan is prepended to the data. This involves converting the variable <code>a</code>—holding the present timestamp—to a timespan. Using the conditional operator <code>$</code>, we distinguish between a single record or a bulk update to adapt the data. A single record receives a singular atom timespan as a prefix, while a bulk update generates a list of timespans, matching the number of received records, and applies it as a prefix.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if[not -16=type first first x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	a:&quot;n&quot;$a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	x:$[0&gt;type first x;a,x;(enlist (count first x)#a),x]];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The final segment of this function distinguishes itself from the previous definition as it immediately publishes the records upon arrival. It involves obtaining the column names of the received data by flipping the target table to a dictionary format. Using the <code>key</code> operator, we retrieve the dictionary&#x27;s keys, representing the table&#x27;s column names. It&#x27;s essential to note that as <code>t</code> stores the table name as a symbol, using <code>value</code> is required to access the content of the table <code>t</code>, even if it&#x27;s currently an empty table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">f:key flip value t;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The above result could have achieved using the <code>cols</code> operator on the table.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade:([] sym:`symbol$(); price:`float$())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)key flip value `trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`sym`price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)cols value `trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`sym`price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(cols value `trade)~key flip value `trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>Next we publish the data to all real-time subscribers by using the <code>.u.pub</code> function.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.u.pub[t;$[0&gt;type first x;enlist f!x;flip f!x]];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We first check if we are publishing a single record or a bulk update. Similar to previous checks, we evaluate the type of the initial record in our data. A negative response to the <code>type</code> function, indicated by <code>0&gt;type first x</code>, confirms that we are publishing a single record. On the contrary, a <code>false</code> result denotes the publication of multiple records. Employing the conditional operator <code>$</code> allows us to take appropriate action for both scenarios. If we&#x27;re dealing with a single record, we create a dictionary by mapping the column names stored in variable <code>f</code> to the actual data stored in variable <code>x</code>, thus creating a column-dictionary. We then enlist this dictionary, transforming it from a column-dictionary, into a single-row table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enlist f!x</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>A KDB/Q table is basically a list of dictionaries, meaning that if you enlist a dictionary, you obtain a single row of a table. If you flip a column dictionary, a dictionary where each key contains a list of values of the same length, you obtain a table. On the other hand, if you take only one row of a table, the data will be represented as a dictionary</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)`sym`price!(`GOOG;200.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  | `GOOG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">price| 200f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)enlist `sym`price!(`GOOG;200.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)flip  `sym`price!(`GOOG`APPL`MSFT;200.0 145.9 332.34)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">APPL 145.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSFT 332.34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade:([] sym:`GOOG`APPL`MSF;price:200.0 145.9 332.34)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOOG 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">APPL 145.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSF  332.34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)first trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  | `GOOG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">price| 200f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  | `APPL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">price| 145.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)last trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sym  | `MSF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">price| 332.34</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>If we are dealing with a bulk update on the other hand, we map the column names to the list of data records, creating a column dictionary. Subsequently, this column dictionary is flipped to form a table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">flip f!x</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, the data can be published using <code>.u.pub</code>, the corresponding table name <code>t</code> and the updated data records stored in <code>x</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.u.pub[t;$[0&gt;type first x;enlist f!x;flip f!x]];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The final step involves inserting the received data into the Tickerplant Log, provided it exists, and updating the overall message count <code>.u.i</code> by one.  As previously explained, we ensure that the handle to the Tickerplant Log exists, and if so, the function appends a parse tree that comprises the <code>upd</code> function as the initial element, the table name t as the second element, and the data as the third element. Subsequently, the function utilizes enlist to add the records to the Tickerplant Log by writing to its handle <code>.u.l</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if[.u.l;.u.l enlist (`upd;t;x);.u.i+:1];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have now defined all necessary functions to operate our lightweight Tickerplant. The final line in the tick.q file calls the <code>.u.tick</code> function with the name of the file that contains the schema definitions and the designated path to store the Tickerplant Log file.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.u.tick[src;.z.x. 1]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We&#x27;ve completed our Tickerplant walkthrough. Next, we&#x27;ll briefly examine the <code>r.q</code> file containing the Real-time Database code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-real-time-database-rdb-code-explained--rq">The Real-Time Database (RDB) Code Explained- <code>r.q</code><a href="#the-real-time-database-rdb-code-explained--rq" class="hash-link" aria-label="Direct link to the-real-time-database-rdb-code-explained--rq" title="Direct link to the-real-time-database-rdb-code-explained--rq">​</a></h2>
<p>The RDB, or Real-time Database, is a crucial component in any KDB/Q Tick setup. It preserves all intraday data in memory, ensuring accessibility for business users and other services requiring intraday data queries. Despite its simplicity, the standard Real-time Database, comprised of just three functions, closely resembles RDBs in more sophisticated and advanced KDB/Q Tick configurations.</p>
<p>Let&#x27;s delve into the code, dissecting it line by line:</p>
<p>We first verify whether our KDB/Q Tick system is running on a Windows or Unix operating system and if we are running on the later we are invoking a <code>sleep</code> system command to pause the process for one second. This allows the system to register our process before establishing any interprocess communication (TCP/IP)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if[not &quot;w&quot;=first string .z.o;system &quot;sleep 1&quot;];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="upd"><code>upd</code><a href="#upd" class="hash-link" aria-label="Direct link to upd" title="Direct link to upd">​</a></h3>
<p>Next we define the update <code>upd</code> function that is invoked by the Tickerplant whenever data is published to the Real-time Database. In most cases, the <code>upd</code> function is defined as a simple <code>insert</code>. Remember, the Tickerplant sends a parse tree, consisting of <code>upd</code> as the function, the first element, followed by the table name and the actual data as parameters. Defining <code>upd</code> as <code>insert</code> will ensure that any new data is added to the end of the respective table.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">upd:insert</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Below examples should illustrate this behavior</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)trade:([] time:`timestamp$();sym:`symbol$();price:`float$());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)quote:([] time:`timestamp$();sym:`symbol$();bid:`float$();ask:`float$());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)upd:insert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)// single row update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)value (`upd;`trade;(.z.P;`GOOG;400.4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time                          sym  price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.13D21:35:46.676306000 GOOG 400.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)// multiple row update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)value (`upd;`trade;(3#.z.P;`GOOG`MSFT`APPL;400.4 134.56 234.5))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time                          sym  price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.13D21:35:46.676306000 GOOG 400.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.13D21:36:11.973625000 GOOG 400.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.13D21:36:11.973625000 MSFT 134.56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.13D21:36:11.973625000 APPL 234.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)value (`upd;`quote;(3#.z.P;`GOOG`MSFT`APPL;400.4 134.56 234.5;400.5 144.9 235.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 1 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time                          sym  bid    ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.13D21:37:06.689310000 GOOG 400.4  400.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.13D21:37:06.689310000 MSFT 134.56 144.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023.11.13D21:37:06.689310000 APPL 234.5  235.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>We use <code>value</code> to evalute the simple parse tree. You can read more about parse trees and how to create and evaluate them <a href="https://code.kx.com/q/wp/parse-trees/" target="_blank" rel="noopener noreferrer">here</a></p></div></div>
<p>We assign the Tickerplant (TP) port and Historical Database (HDB) port provided as startup parameters to the global variable <code>.u.x</code>. In the case where no ports are provided upon startup, we assign the default ports <code>5010</code> and <code>5012</code> to the Tickerplant and Historical Database, respectively.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.u.x:.z.x,(count .z.x)_(&quot;:5010&quot;;&quot;:5012&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The system function <a href="https://code.kx.com/q/ref/dotz/#zx-argv" target="_blank" rel="noopener noreferrer"><code>.z.x</code></a> allows you to access all the parameters passed to a KDB/Q process. <a href="https://code.kx.com/q/ref/dotq/#opt-command-parameters" target="_blank" rel="noopener noreferrer"><code>.Q.opt</code></a> can be used to format the passed command line parameters.</p></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q test.q 5010 5012 --debug 1b --test hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KDB+ 4.0 2023.01.20 Copyright (C) 1993-2023 Kx Systems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).z.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;5010&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;5012&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;--debug&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1b&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;--test&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;hello&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).z.x 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;5010&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).z.x 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;5012&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).Q.opt .z.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-debug| &quot;1b&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-test | &quot;hello&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="uend"><code>.u.end</code><a href="#uend" class="hash-link" aria-label="Direct link to uend" title="Direct link to uend">​</a></h3>
<p><code>.u.end</code> is the function invoked when the end-of-day process starts. At this point, the Tickerplant send an asynchronous message to all real-time subscribers and invokes their corresponding end-of-day function <code>.u.end</code>. As part of the Real-time Database (RDB), it performs the following tasks: it collects the names of all currently defined tables, selecting the subset of tables with the <code>g</code> grouped attribute applied. It then uses the <a href="https://code.kx.com/q/ref/dotq/#hdpf-save-tables" target="_blank" rel="noopener noreferrer"><code>.Q.hdpf</code></a> function to save the current day&#x27;s data in memory to disk partitions and proceeds to clear the tables in memory, triggers a reload message to the HDB, and lastly, reapplies the grouped attribute <code>g</code> to the relevant tables.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (date) - the current date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.end:{[x]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	t:tables`.;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  	t@:where `g=attr each t@\:`sym;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  	.Q.hdpf[`$&quot;:&quot;,.u.x 1;`:.;x;`sym];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  	@[;`sym;`g#] each t;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The initial line of code is quite simple; it essentially retrieves the list of tables defined within the current process and stores them in the variable <code>t</code>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">t:tables`.;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next we retrieve the subset of tables that have the grouped attribute <code>g</code> applied and re-assign it to variable <code>t</code>. We do this by first indexing into the <code>sym</code> column of each table using the <code>each-left</code> operator in conjunction with the <code>apply @</code> operator. For each <code>sym</code> column we then use the <code>attr</code> operator to check for applied attributes. This produces a list of attributes, which we can compare to the symbol representing the grouped attribute <code>g</code>. This comparison generates a boolean mask that marks <code>true (1b)</code> if a table has the grouped attribute <code>g</code> applied and <code>false (0b)</code> if it does not. Using this boolean mask in combination with <code>where</code>, we index into the list of table names to retrieve only those with the grouped attribute <code>g</code> applied. Finally, we overwrite the <code>t</code> variable with this updated list.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">t@:where `g=attr each t@\:`sym;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using <code>.Q.hdpf</code> we then save all in-memory tables into a partitioned Historical Database (HDB), clear the in memory tables and instruct the Historical Database (HDB) to reload. <code>.Q.hdpf</code> takes the following parameters as arguements</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.Q.hdpf[historicalport;directory;partition;`p#field]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In our case this equates to the following:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.Q.hdpf[`$&quot;:&quot;,.u.x 1;`:.;x;`sym];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- historicalport: the location of our HDB `$&quot;:&quot;,.u.x 1 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- directory: the root directory of our HDB, the current directory `:.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- partition: the partition to write the data to, x the input/date passed to .u.end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- `p#field: the column to sort for and apply the parted attribute `p on, `sym in this case</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, we re-apply the grouped attribute <code>g</code> to the tables that had the attribute applied before the data purge.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@[;`sym;`g#] each t;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This concludes our end-of-day function, and we can proceed to the last function defined in the <code>r.q</code> file: the replay function <code>.u.rep.</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="urep"><code>.u.rep</code><a href="#urep" class="hash-link" aria-label="Direct link to urep" title="Direct link to urep">​</a></h3>
<p>The last function in our Real-time Database (RDB) is also one of the most crucial ones. <code>.u.rep</code> is the function responsible for replaying the Tickerplant Log file and is initially invoked when the RDB starts up. It receives a list of pairs constisting of the table names and their corresponding schema as the first parameter. This information is used to  initialise all tables with their respective schema. The second parameter is a list consisting of the total number of messages the Tickerplant has received so far as first element and the location of the Tickerplant Log file as second element. This information is then utilized to replay the Tickerplant Log file, ensuring that the RDB reflects the current state of the world. Let&#x27;s examine the functionality of <code>.u.rep</code> together:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	x (List) - List of pairs containing table names as first element and their corresponding table schema as second element</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @param:	y (List) - List consisting of the total number of elements the Tickerplant has received so far and the Tickerplant Log file location </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @return:	None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.u.rep:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	(.[;();:;].)each x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if[null first y;:()];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	-11!y;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	system &quot;cd &quot;,1_-10_string first reverse y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Before we dive deeper into the functionality of <code>.u.rep</code> let&#x27;s have a quick look at the structure of that first parameter <code>x</code> that the function takes. If you remember, whenever a real-timer subscriber subscribes to the Tickerplant by invoking <code>.u.sub</code> it will receive a list of pairs consisting of table names and their corresponding schema. This structure is illustrated in the code below. If we examine the content as a whole and then break it down into individual elements, we can observe that each element of the list is a pair, with the table name as the first element and the respective empty schema as the second element:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">q)x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`quote +`time`sym`bid`ask`bsize`asize!(`timespan$();`g#`symbol$();`float$();`float$();`int$();`int$())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`trade +`time`sym`price`size!(`timespan$();`g#`symbol$();`float$();`int$())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)x 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`time`sym`bid`ask`bsize`asize!(`timespan$();`g#`symbol$();`float$();`float$();`int$();`int$())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)x 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+`time`sym`price`size!(`timespan$();`g#`symbol$();`float$();`int$())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)x[0;0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)x[0;1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time sym bid ask bsize asize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)x[1;0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)x[1;1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time sym price size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The initial line of code may seem familiar. As previously discussed in the context of <code>.u.ld</code>, I explained that <code>.[x;();:;y]</code> is essentially equivalent to the K implementation of the <a href="https://code.kx.com/q/ref/get/#set" target="_blank" rel="noopener noreferrer"><code>set</code></a> operator. This code, combined with the <code>dot-apply .</code> operator, enables us to initialize each table with its respective table schema.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Illustration of dot-apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q){x+y} . (2;3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`quote +`time`sym`bid`ask`bsize`asize!(`timespan$();`g#`symbol$();`float$();`float$();`int$();`int$())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`trade +`time`sym`price`size!(`timespan$();`g#`symbol$();`float$();`int$())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)(.[;();:;].) each x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`quote`trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)quote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time sym bid ask bsize asize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)trade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time sym price size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After initializing all tables with their corresponding schema, we check whether the number of messages received by the Tickerplant so far is null or not. This is done by examining the first element of the parameter <code>y</code>. If there were no messages received, and the value is null, we terminate the function early and return an empty list. Otherwise, we proceed to replay the Tickerplant Log file using the system function <a href="https://code.kx.com/q/basics/internal/#-11-streaming-execute" target="_blank" rel="noopener noreferrer"><code>-11!</code></a> and the parameter <code>y</code>.</p>
<p>Given that <code>y</code> contains the number of received messages and the path to the Tickerplant Log file, <code>-11!</code> will replay the first <code>N</code> messages of the Tickerplant Log file</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-11!y;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, we change the current directory to the directory of the Historical Database (HDB) to ensure data is saved to the correct location when the RDB invokes the end-of-day save down and calls <code>.Q.hdpf</code>. In the plain vanilla Tick setup, the Tickerplant Log and the Historical Database are saved under the same path. Therefore, we can extract the first part of the path and use it to change the current directory.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">system &quot;cd &quot;,1_-10_string first reverse y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rdb-startup">RDB startup<a href="#rdb-startup" class="hash-link" aria-label="Direct link to RDB startup" title="Direct link to RDB startup">​</a></h3>
<p>The final line of code in <code>r.q</code> is, in fact, the only line that gets executed. Upon startup of the Real-time Database, after initializing all functions with their definitions, it calls <code>.u.rep . (hopen `$&quot;:&quot;,.u.x 0)&quot;(.u.sub[`;`];`.u `i`L)&quot;;</code>. This establishes a connection to the Tickerplant and sends a synchronous message, invoking the <code>.u.sub</code> function to subscribe to all available tables for all symbols. Additionally, the Real-time Database accesses the <code>.u</code> namespace to retrieve <code>.u.i</code> and <code>.u.L</code> – the number of received messages (<code>.u.i</code>) and the path to the Tickerplant Log file (<code>.u.L</code>). This results in a two-item list, where the first item is a list of pairs containing a table name and an empty table schema. The second item of the list consists of the total number of messages received by the Tickerplant and the path to the Tickerplant Log file.</p>
<p>ChatGPT
Observe the elegance of &quot;Q-style&quot; retrieval for <code>.u.i</code> and <code>.u.L</code>: Instead of individually retrieving <code>.u.i</code> and <code>.u.L</code>, we take advantage of the fact that you can pass multiple indices to a data structure for retrieving their elements. This functionality extends across all data structures, including lists, dictionaries, or tables. Because a namespace (<code>.u</code> in this case) is represented as a dictionary, this also applies to namespaces. The following example illustrates this concept.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).u.i:345345</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).u.L:system &quot;pwd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).u.L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;/Users/Alexander/repos/testing&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q).u `i`L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">345345</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,&quot;/Users/Alexander/repos/testing&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// List</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)list:1 2 3 4 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)list 0 1 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 2 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)table:([] a:`a`b`c; b:1 2 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)table 1 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Dictionary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)dict:`a`b`c!1 2 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q)dict `c`a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>While you generally want to keep all communication asynchronous within a KDB/Q Tick setup, the subscription of a real-time subscriber to the Tickerplant must be synchronous. The initialisation of the table schemas as well as the Tickerplant replay is crucial for the real-time subscriber to bring itself up to date with the current state of the world as well as be able to receive future updates, which would not be possible without the table schema</p></div></div>
<p>This two-item list is then passed as parameters to the dyadic function <code>.u.rep</code>, which proceeds to initialize all tables with their corresponding table schemas. It further checks whether the Tickerplant Log file contains any messages and, if so, replays the Tickerplant Log file to synchronize the real-time subscriber with the current state of the world.</p>
<p>This concludes our comprehensive walkthrough of a complete, vanilla  KDB/Q Tick setup, providing you with a thorough understanding of its inner workings. We delved into each process in detail, explaining key KDB/Q concepts along the way.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="limitations-of-kdbq-tick">Limitations of KDB/Q Tick<a href="#limitations-of-kdbq-tick" class="hash-link" aria-label="Direct link to Limitations of KDB/Q Tick" title="Direct link to Limitations of KDB/Q Tick">​</a></h2>
<p>Although this setup serves as an excellent foundation for capturing real-time data, it is essential to acknowledge some inherent limitations, which will be discussed in the following sections.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tickerplant-doesnt-deal-with-corrupt-tickerplant-log-files">Tickerplant doesn&#x27;t deal with corrupt Tickerplant Log files<a href="#tickerplant-doesnt-deal-with-corrupt-tickerplant-log-files" class="hash-link" aria-label="Direct link to Tickerplant doesn&#x27;t deal with corrupt Tickerplant Log files" title="Direct link to Tickerplant doesn&#x27;t deal with corrupt Tickerplant Log files">​</a></h3>
<p>** The Problem:**
One of the primary drawbacks of our basic Tickerplant is its inability to address corrupted Tickerplant Log files. Upon reviewing the <code>.u.ld</code> function, you&#x27;ll notice that encountering a corrupted Tickerplant Log file leads to the termination of the Tickerplant with an error message. While a corrupt Log file is indeed a critical issue requiring manual attention, there are alternative approaches to handle this situation. If your Tickerplant is inactive, it implies potential data loss.</p>
<p><strong>Possible solution:</strong></p>
<p>One possible solution is to utilize the <code>-2</code> option of <code>-11!</code> to identify the count of valid messages in the Tickerplant Log File, replay them, and then generate an alert message to a monitoring service, prompting investigation into the cause of the Log file corruption.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="process-location-one-host-only">Process location: One host only<a href="#process-location-one-host-only" class="hash-link" aria-label="Direct link to Process location: One host only" title="Direct link to Process location: One host only">​</a></h3>
<p>** The Problem:**
The architecture of this KDB/Q Tick system mandates the Real-time Database or any other real-time subscriber to replay the Tickerplant Log on startup for recreating the current state of the world and retrieving all messages received by the Tickerplant up to that moment. However, this requires the Tickerplant Log file to be present on the same host or server as the process attempting to replay the log file. As we pass the path of the Tickerplant Log file as a parameter to <code>-11!</code>, the function used for replaying the log file, this requirement not only dictates that all real-time subscribers must be on the same host, impacting our hardware needs, but it also makes our system less flexible and limits its extensibility.</p>
<p>** Possible Solution:**</p>
<p>A potential solution to this challenge could involve creating an independent process dedicated to replaying the Tickerplant Log file whenever necessary and forwarding the messages to the real-time subscriber that triggered the replay. Another alternative could be the introduction of a Chained Tickerplant (CTP) residing on a secondary host. The CTP would subscribe to the main Tickerplant on the primary host and maintain a local Tickerplant Log file accessible to all real-time subscribers on that specific host. Both solutions require additional design and implementation, and a detailed explanation goes beyond the scope of this post. Nevertheless, they serve as potential ideas for consideration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unnecessary-serialisation-of-messages">Unnecessary serialisation of messages<a href="#unnecessary-serialisation-of-messages" class="hash-link" aria-label="Direct link to Unnecessary serialisation of messages" title="Direct link to Unnecessary serialisation of messages">​</a></h3>
<p>** The problem:**
The existing implementation of <code>.u.pub</code> disseminates all messages received by the Tickerplant to each real-time subscriber separately. In other words, the messages are serialized and dispatched to each subscriber individually. This could potentially increase the latency of our system.</p>
<p>** Possible Solution:**</p>
<p>This problem only has a partial solution, depending on the KDB/Q version your system is running on. In <a href="https://code.kx.com/q/releases/ChangesIn3.4/" target="_blank" rel="noopener noreferrer">version 3.4</a>  KX introduced asynchronous broadcast <a href="https://code.kx.com/q/basics/internal/#-25x-async-broadcast" target="_blank" rel="noopener noreferrer"><code>-25!</code></a>, which serialises outgoing messages only once. If your system is running on version 3.4 or above, you can take advantage of this functionality and reduce CPU and memory load as well as latency.</p>
<p>That&#x27;s all folks. Happy coding!</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/tutorials/tick"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">KDB Tick Explained: A Walkthrough [PART 1]</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/productivity-tools"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Productivity Tools</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tickq---continued" class="table-of-contents__link toc-highlight"><code>tick.q</code> - Continued</a></li><li><a href="#uld" class="table-of-contents__link toc-highlight"><code>.u.ld</code></a></li><li><a href="#utick" class="table-of-contents__link toc-highlight"><code>.u.tick</code></a></li><li><a href="#uendofday" class="table-of-contents__link toc-highlight"><code>.u.endofday</code></a><ul><li><a href="#connection-handles" class="table-of-contents__link toc-highlight">Connection handles</a></li></ul></li><li><a href="#uts" class="table-of-contents__link toc-highlight"><code>.u.ts</code></a></li><li><a href="#tickerplant-batch-mode-zts-and-uupd" class="table-of-contents__link toc-highlight">Tickerplant Batch mode: <code>.z.ts</code> and <code>.u.upd</code></a><ul><li><a href="#zts" class="table-of-contents__link toc-highlight"><code>.z.ts</code></a></li><li><a href="#each-both-" class="table-of-contents__link toc-highlight">Each-both <code>&#39;</code></a></li><li><a href="#namespacing" class="table-of-contents__link toc-highlight">Namespacing</a></li><li><a href="#amend" class="table-of-contents__link toc-highlight">Amend</a></li><li><a href="#uupd" class="table-of-contents__link toc-highlight"><code>.u.upd</code></a></li></ul></li><li><a href="#tickerplant-tick-mode-zts-and-uupd" class="table-of-contents__link toc-highlight">Tickerplant Tick mode: <code>.z.ts</code> and <code>.u.upd</code></a><ul><li><a href="#zts-1" class="table-of-contents__link toc-highlight"><code>.z.ts</code></a></li><li><a href="#uupd-1" class="table-of-contents__link toc-highlight"><code>.u.upd</code></a></li></ul></li><li><a href="#the-real-time-database-rdb-code-explained--rq" class="table-of-contents__link toc-highlight">The Real-Time Database (RDB) Code Explained- <code>r.q</code></a><ul><li><a href="#upd" class="table-of-contents__link toc-highlight"><code>upd</code></a></li><li><a href="#uend" class="table-of-contents__link toc-highlight"><code>.u.end</code></a></li><li><a href="#urep" class="table-of-contents__link toc-highlight"><code>.u.rep</code></a></li><li><a href="#rdb-startup" class="table-of-contents__link toc-highlight">RDB startup</a></li></ul></li><li><a href="#limitations-of-kdbq-tick" class="table-of-contents__link toc-highlight">Limitations of KDB/Q Tick</a><ul><li><a href="#tickerplant-doesnt-deal-with-corrupt-tickerplant-log-files" class="table-of-contents__link toc-highlight">Tickerplant doesn&#39;t deal with corrupt Tickerplant Log files</a></li><li><a href="#process-location-one-host-only" class="table-of-contents__link toc-highlight">Process location: One host only</a></li><li><a href="#unnecessary-serialisation-of-messages" class="table-of-contents__link toc-highlight">Unnecessary serialisation of messages</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Learn</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/company/defconq/" target="_blank" rel="noopener noreferrer" class="footer__link-item">DefconQ Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/alexanderunterrainer/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Alexander Unterrainer Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://defconq.myspreadshop.co.uk" target="_blank" rel="noopener noreferrer" class="footer__link-item">DefconQ Swag<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://www.youtube.com/@DefconQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube Channel<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://defconq.substack.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/DefconQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DefconQ Ltd. This website is maintained by Alexander Unterrainer. Disclaimer: All content shared on this website reflect solely his personal thoughts and opinions, and is not representative of any past, current, or future employers or affiliations.</div></div></div></footer></div>
</body>
</html>